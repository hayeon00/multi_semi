<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <script src="/js/common.js"></script>
  <meta charset="UTF-8">
  <title>코스 목록 | TRAVEL PLANNING</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f9f9f9;
      margin: 0; padding: 0;
    }
    header {
      display: flex; justify-content: space-between; align-items: center;
      background-color: #d9d9d9; padding: 15px 30px;
    }
    .logo { font-weight: bold; font-size: 1.3rem; }
    .title { font-size: 1.5rem; font-weight: bold; }

    nav a {
      margin-left: 15px; text-decoration: none; color: black;
    }

    main { width: 90%; max-width: 1200px; margin: 40px auto; }

    .filter-bar { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 15px; }
    .filter-bar button {
      border: none; background: #eee; padding: 7px 14px; border-radius: 6px; cursor: pointer;
    }
    .filter-bar button.active { background: #000; color: white; }

    .course-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); gap: 25px;
    }
    .course-card {
      background: white; border-radius: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      overflow: hidden; transition: 0.2s; cursor: pointer;
    }
    .course-card:hover { transform: translateY(-5px); }

    .course-image {
      width: 100%; height: 180px; background-color: #e0e0e0;
      display:flex; align-items:center; justify-content:center;
      color:#888; font-size:1rem;
    }

    .course-info { padding: 15px; }
    .course-title { font-weight: bold; font-size: 1.1rem; }

    .course-meta {
      display:flex; justify-content: space-between;
      margin-top:10px; font-size:0.9rem; color:#555;
    }
    .heart { color: red; margin-right: 5px; }

    .pagination { display:flex; justify-content:center; margin-top:30px; gap:10px; }
    .pagination button {
      border:none; background:#eee; padding:5px 10px;
      border-radius:4px; cursor:pointer;
    }
    .pagination button.active { background:#000; color:white; }
  </style>
</head>

<body>

<header>
  <div class="logo">Logo</div>
  <div class="title">TRAVEL PLANNING</div>

  <div>
    <span th:text="${loginUserId != null ? loginUserId + ' 님 환영합니다.' : 'Guest'}"></span>
    <nav>
      <a href="/">Home</a>
      <a href="/courses/view/list">코스보기</a>
      <a href="/member/view/mypage">마이페이지</a>
      <a href="/logout">로그아웃</a>
    </nav>
  </div>
</header>

<main>
  <div class="filter-bar">
    <button id="defaultSort" class="active">기본순</button>
    <button id="popularSort">추천순</button>
  </div>

  <div class="course-grid" id="courseGrid"></div>
  <div class="pagination" id="pagination"></div>
</main>

<script th:inline="javascript">
  const planId = [[${planId}]];
  let currentPage = 0;
  let sortType = 'default';
  const pageSize = 6;

  $(document).ready(function() {
    loadCourses();

    $("#defaultSort").click(function() {
      sortType = 'default';
      $(this).addClass("active");
      $("#popularSort").removeClass("active");
      loadCourses();
    });

    $("#popularSort").click(function() {
      sortType = 'popular';
      $(this).addClass("active");
      $("#defaultSort").removeClass("active");
      loadCourses();
    });
  });

  /* ============================
      코스 목록 조회 (필터링 포함)
  ============================== */
  async function loadCourses(page = 0) {
    currentPage = page;

    let url;
    if (planId) {
      url = `/courses/filter?planId=${planId}&page=${page}&size=${pageSize}`;
    } else {
      url = sortType === 'popular'
              ? `/courses/popular?page=${page}&size=${pageSize}`
              : `/courses?page=${page}&size=${pageSize}`;
    }

    try {
      const response = await fetchWithRefresh(url);
      const res = await response.json();

      const data = res.data.content || res.data;
      const totalPages = res.data.totalPages ?? 1;

      renderCourses(data);
      renderPagination(totalPages, page);

    } catch (e) {
      console.error("코스 목록 조회 실패:", e);
      alert("코스 정보를 불러오는 중 오류 발생");
    }
  }

  /* ============================
      카드 렌더링
  ============================== */
  function renderCourses(courses) {
    const grid = $("#courseGrid");
    grid.empty();

    if (!courses || courses.length === 0) {
      grid.html("<p style='text-align:center;'>조건에 맞는 코스가 없습니다.</p>");
      return;
    }

    courses.forEach(c => {
      const items = c.items ?? [];
      const sorted = items.sort((a,b)=>a.dayNo-b.dayNo || a.orderNo-b.orderNo);

      const firstItem = sorted[0];
      let thumbnail = "/images/no-image.png";

      if (firstItem) {
        if (firstItem.placeImageUrl) thumbnail = firstItem.placeImageUrl;
      }

      const dayCount = [...new Set(items.map(i => i.dayNo))].length;
      const titleName =
              firstItem
                      ? `${firstItem.placeTitle ?? '여행지'}에서 시작하는 ${dayCount}일 여행`
                      : "여행 코스";

      const card = $(`
        <div class="course-card"
             onclick="location.href='/courses/view/detail/${c.courseId}${planId ? `?planId=${planId}` : ''}'">
          <div class="course-image"
               style="background-image:url('${thumbnail}');
                      background-size:cover; background-position:center;">
          </div>

          <div class="course-info">
            <div class="course-title">${titleName}</div>
            <div class="course-meta">
              <span>${dayCount}일 코스</span>
              <span><span class="heart">❤️</span>${c.recCount ?? 0}</span>
            </div>
          </div>
        </div>
      `);

      grid.append(card);
    });
  }

  /* ============================
      페이지네이션 렌더링
  ============================== */
  function renderPagination(totalPages, currentPage) {
    const container = $("#pagination").empty();

    for (let i=0; i<totalPages; i++) {
      const btn = $(`<button>${i+1}</button>`);
      if (i === currentPage) btn.addClass("active");
      btn.click(()=>loadCourses(i));
      container.append(btn);
    }
  }
</script>

</body>
</html>
