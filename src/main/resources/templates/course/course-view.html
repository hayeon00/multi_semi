<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ì½”ìŠ¤ ìƒì„¸ë³´ê¸°</title>
  <link rel="stylesheet" th:href="@{/css/common.css}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9be895ba7d6b98f83597991def648c2c"></script>
</head>
<body>
<header>
  <div class="header-container">
    <div class="logo">TRAVEL PLANING</div>
    <nav>
      <a href="/">Home</a>
      <a href="/mypage">ë§ˆì´í˜ì´ì§€</a>
      <a href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
    </nav>
  </div>
</header>

<main>
  <div class="course-container">
    <div class="map-section">
      <div id="map" style="width: 600px; height: 450px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1);"></div>
    </div>

    <div class="days-section">
      <div id="dayTabs"></div>
      <div id="dayContent"></div>
    </div>
  </div>

  <div class="like-section">
    <button id="recBtn" style="border:none; background:none; cursor:pointer; font-size:18px;">
      â¤ï¸
    </button>
    <span id="recCount">0</span>
  </div>

  <div class="button-section" id="actionButtons"></div>
</main>

<script th:inline="javascript">
  const courseId = [[${courseId}]];
  const loginUserId = [[${loginUserId}]]; // ë°±ì—”ë“œì—ì„œ ì„¸ì…˜ ë˜ëŠ” JWTë¡œ ì „ë‹¬
  const isOwner = [[${isOwner}]]; // true/false

  // ì´ˆê¸° ë¡œë“œ
  $(document).ready(function() {
    loadCourseDetail();
    setupButtons();
  });

  /** ì½”ìŠ¤ ìƒì„¸ ë°ì´í„° ë¡œë“œ */
  function loadCourseDetail() {
    $.ajax({
      url: `/api/courses/${courseId}`,
      type: 'GET',
      success: function(res) {
        const course = res.data;
        $('#recCount').text(course.recCount ?? 0);
        renderDays(course.items);
        renderMap(course.items);
      },
      error: function(err) {
        console.error("ì½”ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
      }
    });
  }

  /** ì¼ì°¨ë³„ ëª©ë¡ í‘œì‹œ */
  function renderDays(items) {
    const dayTabs = $('#dayTabs');
    const dayContent = $('#dayContent');
    dayTabs.empty();
    dayContent.empty();

    const days = [...new Set(items.map(i => i.dayNo))].sort((a,b)=>a-b);

    days.forEach(dayNo => {
      const tab = $(`<button>${dayNo}ì¼ì°¨</button>`);
      tab.click(() => showDay(dayNo, items));
      dayTabs.append(tab);
    });

    // ê¸°ë³¸ ì²« ë²ˆì§¸ ì¼ì°¨ í‘œì‹œ
    if (days.length > 0) showDay(days[0], items);
  }

  /** ì¼ì°¨ë³„ ì¥ì†Œ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ */
  function showDay(dayNo, items) {
    const list = $('#dayContent');
    list.empty();

    items.filter(i => i.dayNo === dayNo)
            .forEach(i => {
              list.append(`<div class="place-item">â€¢ ${i.placeType} - ${i.placeId}</div>`);
            });
  }

  /** ì§€ë„ ë Œë”ë§ */
  function renderMap(items) {
    const mapContainer = document.getElementById('map');
    const mapOption = {
      center: new kakao.maps.LatLng(37.566826, 126.9786567),
      level: 7
    };
    const map = new kakao.maps.Map(mapContainer, mapOption);

    // ì¢Œí‘œ ì˜ˆì‹œ
    items.forEach(i => {
      if (i.latitude && i.longitude) {
        const marker = new kakao.maps.Marker({
          map: map,
          position: new kakao.maps.LatLng(i.latitude, i.longitude)
        });
      }
    });
  }

  /** ë²„íŠ¼ ì˜ì—­ êµ¬ì„± */
  function setupButtons() {
    const btnArea = $('#actionButtons');
    btnArea.empty();

    const backBtn = $('<button>ë’¤ë¡œê°€ê¸°</button>').click(() => history.back());
    btnArea.append(backBtn);

    if (isOwner) {
      btnArea.append(`<button onclick="location.href='/courses/edit/${courseId}'">ì½”ìŠ¤ ìˆ˜ì •í•˜ê¸°</button>`);
      btnArea.append(`<button onclick="deleteCourse(${courseId})">ì½”ìŠ¤ ì‚­ì œí•˜ê¸°</button>`);
    } else {
      btnArea.append(`<button onclick="addPlan(${courseId})">ê³„íš ì¶”ê°€í•˜ê¸°</button>`);
    }
  }

  /** ì¶”ì²œ í† ê¸€ */
  $('#recBtn').click(function() {
    $.ajax({
      url: `/recommend/toggle`,
      type: 'GET',
      data: {
        userId: loginUserId,
        targetId: courseId,
        catCode: 'crs'
      },
      success: function(res) {
        const status = res.data.status;
        const isLiked = status === 'Y';
        $('#recBtn').html(isLiked ? 'â¤ï¸' : 'ğŸ¤');
        $('#recCount').text(function(_, old) {
          const count = parseInt(old);
          return isLiked ? count + 1 : count - 1;
        });
      },
      error: function(err) {
        console.error("ì¶”ì²œ í† ê¸€ ì‹¤íŒ¨:", err);
      }
    });
  });

  function deleteCourse(id) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    $.ajax({
      url: `/api/courses/${id}`,
      type: 'DELETE',
      success: function() {
        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        location.href = '/courses';
      }
    });
  }

  function addPlan(id) {
    alert(`${id}ë²ˆ ì½”ìŠ¤ë¥¼ ê³„íšì— ì¶”ê°€í•©ë‹ˆë‹¤.`);
  }
</script>

<style>
  body {
    font-family: 'Noto Sans KR', sans-serif;
    background-color: #f8f9fa;
    margin: 0;
    padding: 0;
  }

  header {
    background: #ddd;
    padding: 15px 40px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .course-container {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin: 40px auto;
    width: 80%;
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  }

  .map-section { flex: 2; }
  .days-section { flex: 1; }

  .like-section {
    text-align: center;
    margin-top: 20px;
    font-size: 20px;
  }

  .button-section {
    text-align: center;
    margin-top: 20px;
  }

  button {
    background: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    margin: 0 5px;
    cursor: pointer;
  }

  button:hover {
    background: #0056b3;
  }

  #dayTabs button {
    background: #eee;
    border: none;
    margin-right: 5px;
    border-radius: 6px;
    padding: 5px 10px;
    cursor: pointer;
  }

  #dayContent {
    margin-top: 10px;
    background: #f9f9f9;
    border-radius: 10px;
    padding: 10px;
    height: 300px;
    overflow-y: auto;
  }
</style>
</body>
</html>
