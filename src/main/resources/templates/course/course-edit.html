<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì½”ìŠ¤ ìˆ˜ì •</title>
  <script th:src="@{|https://dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoKey}&autoload=false|}"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

  <style>
    body {
      font-family: Pretendard, sans-serif;
      background: #f5f6f8;
      margin: 0;
      padding: 0;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #ddd;
      padding: 15px 40px;
    }
    .page-header h1 { margin: 0; font-size: 20px; }
    .page-header nav a { margin-left: 15px; color: #333; text-decoration: none; }

    .content-wrapper {
      width: 1200px;
      margin: 30px auto;
      background: #fff;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    /* ---------------- ê³„íš ì •ë³´ (ì¡°íšŒìš© UI) ---------------- */
    .plan-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: nowrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .plan-title-view,
    .plan-date-view,
    .plan-people-view {
      font-size: 16px;
      padding: 6px 12px;
      background: #fafafa;
      border-radius: 10px;
      border: 1px solid #ddd;
      display: inline-block;
      min-width: 130px;
      text-align: center;
    }

    .date-people-box {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* ---------------- ë©”ì¸ 3ë¶„í•  ë ˆì´ì•„ì›ƒ ---------------- */
    .main-area {
      display: flex;
      justify-content: space-between;
      gap: 15px;
    }

    .left-panel, .map-panel, .right-panel {
      border-radius: 15px;
      background: #fafafa;
      padding: 15px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }

    .left-panel { width: 320px; height: 550px; display: flex; flex-direction: column; }
    .map-panel { width: 520px; height: 550px; }
    .right-panel { width: 280px; height: 550px; overflow-y: auto; }

    /* ---------------- ê²€ìƒ‰ / íƒ­ ---------------- */
    .tab-menu button {
      margin: 5px 3px;
      padding: 5px 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #ccc;
    }
    .tab-menu button.active {
      background: #000;
      color: #fff;
    }

    .search-box {
      padding: 0 2px;
      margin-bottom: 10px;
    }
    .search-box input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }

    .place-item {
      background: #fff;
      border-radius: 10px;
      padding: 8px 10px;
      margin: 5px 0;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .place-item:hover { background: #eef2ff; }

    /* ---------------- ì¼ì°¨ íƒ­ (ì¢Œìš° í™”ì‚´í‘œ í¬í•¨) ---------------- */
    .day-tabs-wrapper {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 10px;
    }
    .tab-arrow {
      border: none;
      background: #e0e0e0;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
    }

    .day-tabs {
      display: flex;
      gap: 5px;
      overflow-x: auto;
      white-space: nowrap;
      flex: 1;
      scrollbar-width: none;
    }
    .day-tabs::-webkit-scrollbar { display: none; }

    .day-tabs button {
      padding: 6px 10px;
      border-radius: 8px;
      border: none;
      background: #ccc;
      cursor: pointer;
      white-space: nowrap;
    }
    .day-tabs button.active {
      background: #000;
      color: #fff;
    }

    /* ---------------- ì½”ìŠ¤ ë¦¬ìŠ¤íŠ¸ ---------------- */
    .course-item {
      background: #fff;
      padding: 8px 10px;
      border-radius: 10px;
      margin: 5px 0;
      cursor: grab;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .course-item:hover { background: #eef2ff; }
    .delete-btn { display: none; color: red; cursor: pointer; }
    .course-item:hover .delete-btn { display: inline; }

    /* ---------------- í•˜ë‹¨ ë²„íŠ¼ ---------------- */
    .button-area {
      text-align: center;
      margin-top: 20px;
    }
    .button-area button {
      padding: 10px 25px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      margin: 0 5px;
    }
    .btn-primary { background: #000; color: #fff; }
    .btn-secondary { background: #ccc; color: #333; }

    /* ---------------- í˜ì´ì§€ë„¤ì´ì…˜ ---------------- */
    #pagination {
      display: flex;
      justify-content: center;
      gap: 4px;
      margin-top: 10px;
      overflow-x: auto;
      white-space: nowrap;
      scrollbar-width: none;
    }
    #pagination::-webkit-scrollbar { display: none; }

    #pagination button {
      border: none;
      background: transparent;
      padding: 4px 8px;
      border-radius: 8px;
      cursor: pointer;
    }
    #pagination button:hover { background: #eee; }
    #pagination button.active { background: #000; color: #fff; font-weight: bold; }
    #pagination button.disabled { color: #ccc; cursor: default; }

  </style>
</head>
<body>

<div class="page-header">
  <h1>TRAVEL PLANNING</h1>
  <nav>
    <span>{ì‚¬ìš©ì} ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.</span>
    <a href="/">Home</a>
    <a href="/mypage">ë§ˆì´í˜ì´ì§€</a>
    <a href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
  </nav>
</div>

<div class="content-wrapper">

  <!-- ğŸ“Œ ì¡°íšŒìš© ì—¬í–‰ ê¸°ë³¸ ì •ë³´ -->
  <div class="plan-header">
    <span class="plan-title-view" id="titleView"></span>

    <div class="date-people-box">
      <span class="plan-date-view" id="dateRangeView"></span>
      <span class="plan-people-view" id="peopleView"></span>
    </div>
  </div>

  <div class="main-area">

    <!-- ì¢Œì¸¡: ê´€ê´‘ì§€/ìˆ™ì†Œ ëª©ë¡ -->
    <div class="left-panel">

      <div class="tab-menu">
        <button id="tab-tour" class="active">ê´€ê´‘ì§€</button>
        <button id="tab-acc">ìˆ™ì†Œ</button>
      </div>

      <div class="search-box">
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." />
      </div>

      <div id="placeList"></div>
      <div id="pagination"></div>

    </div>

    <!-- ì§€ë„ -->
    <div id="map" class="map-panel"></div>

    <!-- ìš°ì¸¡: ì¼ì°¨ íƒ­ + ì½”ìŠ¤ ë¦¬ìŠ¤íŠ¸ -->
    <div class="right-panel">

      <div class="day-tabs-wrapper">
        <button class="tab-arrow" id="tabLeftBtn">â—€</button>
        <div class="day-tabs" id="dayTabs"></div>
        <button class="tab-arrow" id="tabRightBtn">â–¶</button>
      </div>

      <div id="courseList"></div>
    </div>
  </div>

  <div class="button-area">
    <button id="cancelBtn" class="btn-secondary">ìˆ˜ì •ì·¨ì†Œ</button>
    <button id="saveBtn" class="btn-primary">ìˆ˜ì •ì™„ë£Œ</button>
  </div>
</div>

<script th:inline="javascript">

  const planId = [[${planId}]];
  let map, markers = [], polylines = [];
  let days = [];
  let activeDay = 1;

  let currentPage = 0;
  const pageSize = 10;
  let lastType = "tour";

  /* ---------------- ì´ˆê¸° ë¡œë”© ---------------- */
  $(document).ready(function () {
    kakao.maps.load(function () {
      initMap();
      loadPlan();
      setupTabs();
      setupSearch();
    });
  });

  /* ---------------- ì§€ë„ ì´ˆê¸°í™” ---------------- */
  function initMap() {
    map = new kakao.maps.Map(document.getElementById("map"), {
      center: new kakao.maps.LatLng(37.4979, 127.0276),
      level: 6
    });
  }

  /* ---------------- ê³„íš ë¶ˆëŸ¬ì˜¤ê¸° ---------------- */
  function loadPlan() {
    $.get(`/plans/${planId}`, function (res) {

      const plan = res.data;

      // ì¡°íšŒìš© UIì— ì„¸íŒ…
      $("#titleView").text(plan.title);
      $("#dateRangeView").text(`${plan.startDate} ~ ${plan.endDate}`);
      $("#peopleView").text(`${plan.numberOfPeople}ëª…`);

      const daysCount = dayDiff(plan.startDate, plan.endDate);

      // ì¼ì ë°°ì—´ ìƒì„±
      days = Array.from({ length: daysCount }, (_, i) => ({
        dayNo: i + 1,
        items: []
      }));

      // ê¸°ì¡´ ì €ì¥ëœ coursePlaces ì±„ìš°ê¸°
      if (plan.coursePlaces?.length) {
        plan.coursePlaces.forEach(p => {
          const day = days.find(d => d.dayNo === p.dayNo);
          if (day) day.items.push(p);
        });
      }

      renderDayTabs(daysCount);
      renderCourseList();
      renderMap();

      loadPlaces("tour", "", 0);
    });
  }

  function dayDiff(start, end) {
    return Math.ceil((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24)) + 1;
  }

  /* ---------------- ì¼ì°¨ íƒ­ ë Œë”ë§ ---------------- */
  function renderDayTabs(count) {
    const tabs = $("#dayTabs").empty();

    for (let i = 1; i <= count; i++) {
      const btn = $(`<button class="${i === 1 ? 'active' : ''}">${i}ì¼ì°¨</button>`);

      btn.click(() => {
        activeDay = i;

        $(".day-tabs button").removeClass("active");
        btn.addClass("active");

        // ì¤‘ì•™ì •ë ¬ ìŠ¤í¬ë¡¤
        const box = document.getElementById("dayTabs");
        const rectBtn = btn[0].getBoundingClientRect();
        const rectBox = box.getBoundingClientRect();
        const diff = (rectBtn.left + rectBtn.width / 2) - (rectBox.left + rectBox.width / 2);

        box.scrollBy({ left: diff, behavior: "smooth" });

        renderCourseList();
        renderMap();
      });

      tabs.append(btn);
    }
  }

  $("#tabLeftBtn").click(() => {
    document.getElementById("dayTabs").scrollBy({ left: -150, behavior: "smooth" });
  });
  $("#tabRightBtn").click(() => {
    document.getElementById("dayTabs").scrollBy({ left: 150, behavior: "smooth" });
  });
</script>
<script>

  /* ---------------- ì½”ìŠ¤ ë¦¬ìŠ¤íŠ¸ ---------------- */
  function renderCourseList() {
    const list = $("#courseList").empty();
    const currentDay = days.find(d => d.dayNo === activeDay);

    currentDay.items
            .sort((a, b) => a.orderNo - b.orderNo)
            .forEach((item, idx) => {

              const div = $(`
          <div class="course-item" data-idx="${idx}">
            <span>${item.title}</span>
            <span class="delete-btn">ì‚­ì œ</span>
          </div>
        `);

              list.append(div);
            });

    // ì‚­ì œ
    $(".delete-btn").click(function () {
      const idx = $(this).closest(".course-item").data("idx");
      currentDay.items.splice(idx, 1);
      renderCourseList();
      renderMap();
    });

    // ë“œë˜ê·¸ ì •ë ¬
    $("#courseList").sortable({
      update: function () {
        const reordered = [];
        $("#courseList .course-item").each(function (idx) {
          reordered.push(currentDay.items[$(this).data("idx")]);
        });

        currentDay.items = reordered.map((it, idx) => ({
          ...it,
          orderNo: idx + 1
        }));

        renderCourseList();
        renderMap();
      }
    });
  }

  /* ---------------- ì§€ë„ ë Œë”ë§ ---------------- */
  function renderMap() {
    clearMap();
    const bounds = new kakao.maps.LatLngBounds();

    days.forEach(day => {
      const coords = [];

      day.items.forEach(item => {
        const lat = parseFloat(item.mapy);
        const lng = parseFloat(item.mapx);
        if (isNaN(lat) || isNaN(lng)) return;

        const pos = new kakao.maps.LatLng(lat, lng);
        coords.push(pos);

        const marker = new kakao.maps.Marker({
          map,
          position: pos,
          title: `[${day.dayNo}ì¼ì°¨] ${item.title}`,
          image: new kakao.maps.MarkerImage(
                  day.dayNo === activeDay
                          ? "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png"
                          : "https://t1.daumcdn.net/mapjsapi/images/marker.png",
                  new kakao.maps.Size(24, 35)
          )
        });

        markers.push(marker);
        bounds.extend(pos);
      });

      if (coords.length > 1) {
        const polyline = new kakao.maps.Polyline({
          path: coords,
          strokeWeight: day.dayNo === activeDay ? 4 : 2,
          strokeColor: day.dayNo === activeDay ? "#000" : "#aaa",
          strokeOpacity: 0.9
        });
        polyline.setMap(map);
        polylines.push(polyline);
      }
    });

    if (!bounds.isEmpty()) {
      map.setBounds(bounds);
    }
  }

  function clearMap() {
    markers.forEach(m => m.setMap(null));
    polylines.forEach(p => p.setMap(null));
    markers = [];
    polylines = [];
  }

  /* ---------------- ê²€ìƒ‰ ê¸°ëŠ¥ ---------------- */
  function setupSearch() {
    $("#searchInput").on("keyup", function () {
      const keyword = $(this).val().trim();
      const type = $("#tab-tour").hasClass("active") ? "tour" : "acc";
      loadPlaces(type, keyword, 0);
    });
  }

  /* ---------------- ê´€ê´‘ì§€ / ìˆ™ì†Œ ëª©ë¡ ë¡œë“œ ---------------- */
  function loadPlaces(type, keyword = "", page = 0) {
    lastType = type;
    currentPage = page;

    let url =
            type === "tour"
                    ? (keyword
                            ? `/spots/list?keyword=${keyword}&page=${page}&size=${pageSize}`
                            : `/spots/simple?page=${page}&size=${pageSize}`)
                    : (keyword
                            ? `/accommodations/list?keyword=${keyword}&page=${page}&size=${pageSize}`
                            : `/accommodations/simple?page=${page}&size=${pageSize}`);

    $.get(url, function (res) {
      const totalPages = res.data?.totalPages ?? 1;
      const places = res.data?.contents || res.data?.content || res.data;

      $("#placeList").empty();

      if (!places || places.length === 0) {
        $("#placeList").append("<div>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>");
        return;
      }

      places.forEach(p => {
        const div = $(`
          <div class="place-item"
               data-id="${p.id}"
               data-mapx="${p.mapx}"
               data-mapy="${p.mapy}"
               data-type="${type === "tour" ? "tsp" : "acc"}">
            <span>${p.title}</span>
            <span>+</span>
          </div>
        `);

        div.click(() =>
                addToCourse(
                        p.id,
                        p.title,
                        type === "tour" ? "tsp" : "acc",
                        p.mapx,
                        p.mapy
                )
        );

        $("#placeList").append(div);
      });

      renderPagination(totalPages);
    });
  }

  /* ---------------- í˜ì´ì§€ë„¤ì´ì…˜ ---------------- */
  function renderPagination(totalPages) {
    const pg = $("#pagination").empty();
    const maxVisible = 5;
    const half = Math.floor(maxVisible / 2);

    let start = Math.max(0, currentPage - half);
    let end = Math.min(totalPages - 1, start + maxVisible - 1);

    if (end - start < maxVisible - 1)
      start = Math.max(0, end - maxVisible + 1);

    const prev = $("<button>&laquo; ì´ì „</button>");
    if (currentPage === 0) prev.addClass("disabled");
    else prev.click(() => loadPlaces(lastType, "", currentPage - 1));
    pg.append(prev);

    for (let i = start; i <= end; i++) {
      const btn = $(`<button>${i + 1}</button>`);
      if (i === currentPage) btn.addClass("active");
      btn.click(() => loadPlaces(lastType, "", i));
      pg.append(btn);
    }

    const next = $("<button>ë‹¤ìŒ &raquo;</button>");
    if (currentPage >= totalPages - 1) next.addClass("disabled");
    else next.click(() => loadPlaces(lastType, "", currentPage + 1));
    pg.append(next);
  }

  /* ---------------- ì½”ìŠ¤ì— ì¶”ê°€ ---------------- */
  function addToCourse(id, title, code, mapx, mapy) {
    const currentDay = days.find(d => d.dayNo === activeDay);

    const x = parseFloat(mapx);
    const y = parseFloat(mapy);
    if (isNaN(x) || isNaN(y)) {
      alert("í•´ë‹¹ ì¥ì†ŒëŠ” ìœ„ì¹˜ ì •ë³´ê°€ ì—†ì–´ ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const dup = currentDay.items.some(i => i.id === id && i.categoryCode === code);
    if (dup) {
      alert("ì´ë¯¸ ì¶”ê°€ëœ ì¥ì†Œì…ë‹ˆë‹¤.");
      return;
    }

    currentDay.items.push({
      id,
      title,
      categoryCode: code,
      orderNo: currentDay.items.length + 1,
      dayNo: activeDay,
      mapx: x,
      mapy: y
    });

    renderCourseList();
    renderMap();
  }

  /* ---------------- ê´€ê´‘ì§€ / ìˆ™ì†Œ íƒ­ ---------------- */
  function setupTabs() {
    $("#tab-tour").click(() => {
      $(".tab-menu button").removeClass("active");
      $("#tab-tour").addClass("active");
      loadPlaces("tour", "", 0);
    });

    $("#tab-acc").click(() => {
      $(".tab-menu button").removeClass("active");
      $("#tab-acc").addClass("active");
      loadPlaces("acc", "", 0);
    });
  }

  /* ---------------- ì €ì¥ ìš”ì²­ ---------------- */
  $("#saveBtn").click(function () {
    if (!confirm("ìˆ˜ì • ë‚´ìš©ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    const req = {
      planId: planId,
      items: days.flatMap(day =>
              day.items.map((item, idx) => ({
                placeId: item.id,
                categoryCode: item.categoryCode,
                orderNo: idx + 1,
                dayNo: day.dayNo
              }))
      )
    };

    $.ajax({
      url: `/courses/${planId}`,
      type: "PUT",
      contentType: "application/json",
      data: JSON.stringify(req),
      success: () => {
        alert("ì½”ìŠ¤ ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
        window.location.href = `/plans/${planId}`;
      },
      error: xhr => {
        alert("ì½”ìŠ¤ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        console.error(xhr.responseText);
      }
    });
  });

  /* ---------------- ìˆ˜ì • ì·¨ì†Œ ---------------- */
  $("#cancelBtn").click(function () {
    if (confirm("ì •ë§ ìˆ˜ì • ë‚´ìš©ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      window.location.href = `/plans/${planId}`;
    }
  });

</script>
