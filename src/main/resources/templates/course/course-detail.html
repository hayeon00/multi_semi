<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <script src="/js/common.js"></script>

  <meta charset="UTF-8" />
  <title>ì½”ìŠ¤ ìƒì„¸ | Travel Planning</title>

  <!-- jQuery (DOM ì¡°ì‘ìš©ë§Œ ì‚¬ìš©) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- Kakao Map -->
  <script th:src="@{|https://dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoKey}&autoload=false|}"></script>

  <style>
    body { font-family: Noto Sans KR, sans-serif; margin: 0; background: #f9f9f9; }
    header {
      background: #d9d9d9;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .title { font-size: 1.5rem; font-weight: bold; }
    nav a { margin-left: 10px; color: black; text-decoration: none; }

    main {
      width: 900px; margin: 40px auto; background: #fff;
      border-radius: 20px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .map-container { display: flex; background: #f3f3f3; border-radius: 20px; overflow: hidden; }
    #map { width: 70%; height: 500px; }

    .side-panel { width: 30%; background: #fff; padding: 10px; display: flex; flex-direction: column; }

    /* DAY íƒ­ */
    .day-tabs-wrapper { display: flex; align-items: center; gap: 5px; margin-bottom: 10px; }
    .tab-arrow {
      border: none; background: #e0e0e0; padding: 5px 10px;
      border-radius: 6px; cursor: pointer; font-size: 13px;
    }
    .tabs { display: flex; overflow-x: auto; gap: 5px; flex: 1; white-space: nowrap; }
    .tabs::-webkit-scrollbar { display: none; }
    .tabs button {
      padding: 6px 10px; border-radius: 8px; border: none; background: #ccc; cursor: pointer;
    }
    .tabs button.active { background: #000; color: #fff; }

    .place-list { flex: 1; overflow-y: auto; }
    .place-item {
      background: #fff; margin: 4px 0; border-radius: 8px; padding: 8px; font-size: 14px;
    }

    .btns { text-align: center; margin-top: 20px; }
    .btns button {
      padding: 10px 20px; border: none; border-radius: 8px;
      cursor: pointer; margin: 0 8px;
    }

    .btn-back { background: #ccc; }
    .btn-edit { background: #4A90E2; color: #fff; }
    .btn-delete { background: #ff6b6b; color: #fff; }
    .btn-add { background: #000; color: #fff; }

    .reviews-section {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
    }
    .review-card {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .review-card h4 { margin: 0; font-size: 16px; color: #333; }
    .review-card p { margin: 5px 0; color: #555; }
    .review-meta { font-size: 13px; color: #888; }
  </style>
</head>

<body>
<header>
  <div class="title">TRAVEL PLANNING</div>
  <nav>
    <a href="/">Home</a>
    <a href="/member/view/mypage">ë§ˆì´í˜ì´ì§€</a>
    <a href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
  </nav>
</header>

<main>
  <h2 id="courseTitle"></h2>

  <div class="map-container">
    <div id="map"></div>

    <div class="side-panel">

      <div class="day-tabs-wrapper">
        <button class="tab-arrow" id="tabLeft">â—€</button>
        <div class="tabs" id="dayTabs"></div>
        <button class="tab-arrow" id="tabRight">â–¶</button>
      </div>

      <div class="place-list" id="placeList"></div>
    </div>
  </div>

  <div class="btns" id="buttonArea"></div>

  <section class="reviews-section">
    <h3>ğŸ“ ìµœì‹  ë¦¬ë·°</h3>
    <div id="courseReviewList"></div>
  </section>
</main>

<script th:inline="javascript">
  const courseId = [[${courseId}]];
  const planId = [[${planId}]];
  const loginUserId = [[${loginUserId}]];

  let map, markers = [], polylines = [];
  let course = null;
  let grouped = {};
  let maxDay = 1;
  let activeDay = 1;
  let isOwner = false;

  /* ===============================
      1) ì´ˆê¸° ë¡œë“œ â†’ ì½”ìŠ¤ ì¡°íšŒ
  =============================== */
  kakao.maps.load(() => loadCourse());

  async function loadCourse() {
    try {
      const response = await fetchWithRefresh(`/courses/${courseId}`);
      const res = await response.json();

      course = res.data;
      if (!course) {
        alert("ì½”ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      isOwner = (course.creatorUserId === loginUserId);
      $("#courseTitle").text("ì½”ìŠ¤ ìƒì„¸ë³´ê¸°");

      maxDay = Math.max(...course.items.map(i => i.dayNo));

      await enrichItems();
      groupByDay();

      renderButtons();
      renderDayTabs();
      initMap();
      renderList();
      renderMap();
      loadCourseReviews();
    } catch (e) {
      console.error(e);
      alert("ì½”ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  /* ===============================
      2) ìƒì„¸ ì¡°íšŒ (mapx, mapy, title ë³´ê°•)
  =============================== */
  async function enrichItems() {
    const tasks = course.items.map(async item => {
      const url =
              item.categoryCode === "acc"
                      ? `/accommodations/detail?id=${item.placeId}`
                      : `/spots/detail?id=${item.placeId}`;

      const response = await fetchWithRefresh(url);
      const res = await response.json();

      if (res.data) {
        item.title = res.data.title || res.data.name;
        item.mapx = res.data.mapx;
        item.mapy = res.data.mapy;
      }
    });

    await Promise.all(tasks);
  }

  /* ===============================
      3) ì¼ì°¨ë³„ ê·¸ë£¹í™”
  =============================== */
  function groupByDay() {
    grouped = {};
    for (let i = 1; i <= maxDay; i++) grouped[i] = [];

    course.items.forEach(i => grouped[i.dayNo].push(i));

    for (const d in grouped)
      grouped[d].sort((a, b) => a.orderNo - b.orderNo);
  }

  /* ===============================
      4) ë²„íŠ¼ ë Œë”ë§
  =============================== */
  function renderButtons() {
    const box = $("#buttonArea").empty();
    box.append(`<button class="btn-back" onclick="history.back()">ë’¤ë¡œê°€ê¸°</button>`);

    if (isOwner) {
      box.append(`<button class="btn-edit" onclick="location.href='/courses/view/edit?courseId=${courseId}'">ìˆ˜ì •í•˜ê¸°</button>`);
      box.append(`<button class="btn-delete" onclick="deleteCourse()">ì‚­ì œí•˜ê¸°</button>`);
    } else if (planId) {
      box.append(`
        <button class="btn-add" onclick="goAddToPlan(${courseId}, ${planId})">
          ì´ ì½”ìŠ¤ë¥¼ ê³„íšì— ì¶”ê°€í•˜ê¸°
        </button>
      `);
    }
  }

  /* ===============================
      DELETE ì½”ìŠ¤
  =============================== */
  async function deleteCourse() {
    if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    try {
      const response = await fetchWithRefresh(`/courses/${courseId}`, {
        method: "DELETE"
      });

      if (!response.ok) {
        alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.href = "/courses/view/list";

    } catch (e) {
      console.error(e);
      alert("ì‚­ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  /* ===============================
      5) ì¼ì°¨ íƒ­ ë Œë”ë§
  =============================== */
  function renderDayTabs() {
    const tabs = $("#dayTabs").empty();

    for (let d = 1; d <= maxDay; d++) {
      const btn = $(`<button>${d}ì¼ì°¨</button>`);
      if (d === activeDay) btn.addClass("active");

      btn.click(() => {
        activeDay = d;
        $(".tabs button").removeClass("active");
        btn.addClass("active");
        renderList();
        renderMap();
      });

      tabs.append(btn);
    }

    $("#tabLeft").click(() => {
      document.getElementById("dayTabs").scrollBy({ left: -150, behavior: "smooth" });
    });

    $("#tabRight").click(() => {
      document.getElementById("dayTabs").scrollBy({ left: 150, behavior: "smooth" });
    });
  }

  /* ===============================
      6) ì˜¤ë¥¸ìª½ ë¦¬ìŠ¤íŠ¸
  =============================== */
  function renderList() {
    const box = $("#placeList").empty();

    grouped[activeDay].forEach(i => {
      box.append(`<div class="place-item">${i.title}</div>`);
    });
  }

  /* ===============================
      7) ì§€ë„ ì´ˆê¸°í™”
  =============================== */
  function initMap() {
    map = new kakao.maps.Map(document.getElementById("map"), {
      center: new kakao.maps.LatLng(37.4979, 127.0276),
      level: 6
    });
  }

  /* ===============================
      8) ì§€ë„ ë Œë”ë§ (ë§ˆì»¤ + í´ë¦¬ë¼ì¸)
  =============================== */
  function renderMap() {
    clearMap();

    const items = grouped[activeDay];
    const bounds = new kakao.maps.LatLngBounds();
    const coords = [];

    items.forEach(i => {
      if (!i.mapx || !i.mapy) return;

      const pos = new kakao.maps.LatLng(parseFloat(i.mapy), parseFloat(i.mapx));
      coords.push(pos);
      bounds.extend(pos);

      const marker = new kakao.maps.Marker({
        map,
        position: pos,
        image: new kakao.maps.MarkerImage(
                "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
                new kakao.maps.Size(24, 35)
        )
      });

      markers.push(marker);
    });

    if (coords.length >= 2) {
      const line = new kakao.maps.Polyline({
        map,
        path: coords,
        strokeWeight: 4,
        strokeColor: "#000",
        strokeOpacity: 0.9
      });
      polylines.push(line);
    }

    if (!bounds.isEmpty()) map.setBounds(bounds);
  }

  function clearMap() {
    markers.forEach(m => m.setMap(null));
    polylines.forEach(p => p.setMap(null));
    markers = [];
    polylines = [];
  }

  function loadCourseReviews() {
    fetch(`/reviews/target?type=COURSE&id=${courseId}&size=3`)
            .then(res => res.json())
            .then(result => {
              const reviews = result.content;
              const box = $("#courseReviewList").empty();

              if (!reviews || reviews.length === 0) {
                box.html(`<p style="color:#888;">ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`);
                return;
              }

              reviews.forEach(r => {
                box.append(`
            <div class="review-card">
              <h4>${r.writer || "ìµëª…"}</h4>
              <p><strong>${r.title}</strong></p>
              <p>${r.content}</p>
              <div class="review-meta">â­ ${r.rating}ì  | ${r.createdAt}</div>
            </div>
          `);
              });
            })
            .catch(err => {
              console.error("ë¦¬ë·° ë¡œë“œ ì‹¤íŒ¨:", err);
            });
  }

  async function goAddToPlan(courseId, planId) {
    await fetchWithRefresh(`/plans/${planId}/course?courseId=${courseId}`, {
      method: "POST"
    });

    alert("ì½”ìŠ¤ê°€ ê³„íšì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
    location.href = `/plans/view/${planId}`;
  }


</script>

</body>
</html>
