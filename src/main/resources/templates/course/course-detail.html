<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/common/layout}"
      lang="ko">

<head>
    <th:block layout:fragment="head">
        <meta charset="UTF-8"/>
        <title>ì½”ìŠ¤ ìƒì„¸ | Travel Planning</title>

        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script th:src="@{|https://dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoKey}&autoload=false|}"></script>

        <style>
            .back-nav-wrapper {
                margin-bottom: 15px;
            }

            .btn-back-nav {
                background: #e5e5e5;
                padding: 6px 12px;
                border-radius: 8px;
                border: none;
                cursor: pointer;
                font-size: 14px;
                transition: 0.2s;
            }

            .btn-back-nav:hover {
                background: #d0d0d0;
            }

            body {
                font-family: Pretendard, sans-serif;
                margin: 0;
                background: #f9f9f9;
            }

            main {
                width: 900px;
                margin: 40px auto;
                background: #fff;
                border-radius: 20px;
                padding: 20px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            }

            .map-container {
                display: flex;
                background: #f3f3f3;
                border-radius: 20px;
                overflow: hidden;
            }

            #map {
                width: 70%;
                height: 500px;
            }

            .side-panel {
                width: 30%;
                background: #fff;
                padding: 10px;
                display: flex;
                flex-direction: column;
            }

            .day-tabs-wrapper {
                display: flex;
                align-items: center;
                gap: 5px;
                margin-bottom: 10px;
            }

            .tab-arrow {
                border: none;
                background: #e0e0e0;
                padding: 5px 10px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
            }

            .tabs {
                display: flex;
                overflow-x: auto;
                gap: 5px;
                flex: 1;
                white-space: nowrap;
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tabs button {
                padding: 6px 10px;
                border-radius: 8px;
                border: none;
                background: #ccc;
                cursor: pointer;
            }

            .tabs button.active {
                background: #000;
                color: #fff;
            }

            .place-list {
                flex: 1;
                overflow-y: auto;
            }

            .place-item {
                background: #fff;
                margin: 4px 0;
                border-radius: 8px;
                padding: 8px;
                font-size: 14px;
            }

            .btns {
                text-align: center;
                margin-top: 20px;
                display: flex;
                justify-content: center;
                gap: 8px;
            }

            .btns button {
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
            }

            .btn-back {
                background: #ccc;
            }

            .btn-edit {
                background: #4A90E2;
                color: #fff;
            }

            .btn-delete {
                background: #ff6b6b;
                color: #fff;
            }

            .btn-add {
                background: #000;
                color: #fff;
            }

            .btn-like {
                background: #e74c3c;
                color: white;
                font-weight: 600;
            }

            .btn-like.active {
                background: #ff6b81;
            }

            .reviews-section {
                margin-top: 40px;
                padding-top: 20px;
                border-top: 1px solid #ddd;
            }

            .review-card {
                background: #f9f9f9;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 15px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            }

            .review-card h4 {
                margin: 0;
                font-size: 16px;
                color: #333;
            }

            .review-meta {
                font-size: 13px;
                color: #888;
            }

            .toast-message {
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(40, 40, 40, 0.9);
                color: #fff;
                padding: 12px 18px;
                border-radius: 6px;
                font-size: 14px;
                animation: fadeInOut 2s ease;
                z-index: 1000;
            }

            @keyframes fadeInOut {
                0% {
                    opacity: 0;
                    transform: translate(-50%, 10px);
                }
                20%, 80% {
                    opacity: 1;
                    transform: translate(-50%, 0);
                }
                100% {
                    opacity: 0;
                    transform: translate(-50%, 10px);
                }
            }

            /* ================================
         ê³„íš ìƒì„¸ í˜ì´ì§€ ìŠ¤íƒ€ì¼ ë³µì‚¬ë³¸
         ì½”ìŠ¤ ìƒì„¸ í˜ì´ì§€ì— ê·¸ëŒ€ë¡œ ì ìš©
      ================================ */

            /* ì½”ìŠ¤ ëª©ë¡ ì™¸ê³½ íŒ¨ë„ */
            .side-panel {
                background: #fafafa;
                padding: 20px;
                width: 360px;
                border-radius: 15px;
                box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
            }

            /* ìƒë‹¨ Day Tabs */
            .day-tabs-wrapper {
                display: flex;
                align-items: center;
                gap: 5px;
                margin-bottom: 15px;
            }

            .tabs {
                display: flex;
                gap: 8px;
                overflow-x: auto;
                white-space: nowrap;
                flex: 1;
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tabs button {
                padding: 6px 12px;
                background: #ddd;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
            }

            .tabs button.active {
                background: #000;
                color: #fff;
            }

            /* ëª©ë¡ ì „ì²´ ì˜ì—­ */
            .place-list {
                flex: 1;
                overflow-y: auto;
            }

            /* ê°œë³„ ì½”ìŠ¤ ì•„ì´í…œ (ì™„ì „ ë™ì¼ ìŠ¤íƒ€ì¼) */
            .place-item {
                padding: 10px;
                background: white;
                border-radius: 10px;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
                font-size: 15px;
            }

            /* ìˆœì„œ ë²ˆí˜¸ ìŠ¤íƒ€ì¼ (ê³„íš ìƒì„¸ í˜ì´ì§€ ë™ì¼) */
            .place-index {
                background: #eee;
                width: 26px;
                height: 26px;
                border-radius: 50%;
                text-align: center;
                line-height: 26px;
                font-size: 13px;
            }

        </style>
    </th:block>
</head>

<body>

<main layout:fragment="content">

    <div class="back-nav-wrapper">
        <button class="btn-back-nav" onclick="window.history.back()">â† ì´ì „ í˜ì´ì§€</button>
    </div>

    <h2 id="courseTitle"></h2>

    <div class="map-container">
        <div id="map"></div>

        <div class="side-panel">
            <div class="day-tabs-wrapper">
                <button class="tab-arrow" id="tabLeft">â—€</button>
                <div class="tabs" id="dayTabs"></div>
                <button class="tab-arrow" id="tabRight">â–¶</button>
            </div>

            <div class="place-list" id="placeList"></div>
        </div>
    </div>

    <div class="btns" id="buttonArea"></div>

    <section class="reviews-section">
        <h3>ğŸ“ ìµœì‹  ë¦¬ë·°</h3>
        <div id="courseReviewList"></div>
    </section>

</main>

<th:block layout:fragment="script">

    <script th:inline="javascript">
        const courseId = [[${courseId}]];
        const planId = [[${planId}]];
        const loginUserId = [[${loginUserId}]];

        let map, markers = [], polylines = [];
        let course = null;
        let grouped = {};
        let maxDay = 1;
        let activeDay = 1;
        let isOwner = false;

        function showToast(message) {
            const toast = document.createElement("div");
            toast.textContent = message;
            toast.className = "toast-message";
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        kakao.maps.load(() => loadCourse());

        async function loadCourse() {
            try {
                const response = await fetchWithRefresh(`/courses/${courseId}`);
                const res = await response.json();

                course = res.data;
                if (!course) {
                    alert("ì½”ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                isOwner = (course.creatorUserId === loginUserId);
                $("#courseTitle").text("ì½”ìŠ¤ ìƒì„¸ë³´ê¸°");

                maxDay = Math.max(...course.items.map(i => i.dayNo));

                await enrichItems();
                groupByDay();

                renderButtons();
                renderDayTabs();
                initMap();
                renderList();
                renderMap();
                loadCourseReviews();
                loadLikeStatus();

            } catch (e) {
                console.error(e);
                alert("ì½”ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        async function enrichItems() {
            const tasks = course.items.map(async item => {
                const url =
                    item.categoryCode === "acc"
                        ? `/accommodations/detail?id=${item.placeId}`
                        : `/spots/detail?id=${item.placeId}`;

                const response = await fetchWithRefresh(url);
                const res = await response.json();

                if (res.data) {
                    item.title = res.data.title || res.data.name;
                    item.mapx = res.data.mapx;
                    item.mapy = res.data.mapy;
                }
            });

            await Promise.all(tasks);
        }

        function groupByDay() {
            grouped = {};
            for (let i = 1; i <= maxDay; i++) grouped[i] = [];

            course.items.forEach(i => grouped[i.dayNo].push(i));
            for (const d in grouped) grouped[d].sort((a, b) => a.orderNo - b.orderNo);
        }

        function renderButtons() {
            const box = $("#buttonArea").empty();

            box.append(`<button class="btn-back" onclick="history.back()">ë’¤ë¡œê°€ê¸°</button>`);

            if (isOwner) {
                box.append(`<button class="btn-edit" onclick="location.href='/courses/view/edit?courseId=${courseId}'">ìˆ˜ì •í•˜ê¸°</button>`);
                box.append(`<button class="btn-delete" onclick="deleteCourse()">ì‚­ì œí•˜ê¸°</button>`);
            } else if (planId) {
                box.append(`<button class="btn-add" onclick="goAddToPlan(${courseId}, ${planId})">ì´ ì½”ìŠ¤ë¥¼ ê³„íšì— ì¶”ê°€í•˜ê¸°</button>`);
            }

            box.append(`<button class="btn-like" id="btnLike">â™¡ ì¶”ì²œ</button>`);
            document.getElementById("btnLike").onclick = toggleLike;
        }

        async function loadLikeStatus() {
            try {
                const response = await fetchWithRefresh(`/recommend/status?targetId=${courseId}&catCode=course`);
                const res = await response.json();

                const btn = document.getElementById("btnLike");

                if (res.data?.status === "Y") {
                    btn.classList.add("active");
                    btn.innerHTML = "â¤ï¸ ì¶”ì²œ ì·¨ì†Œ";
                } else {
                    btn.classList.remove("active");
                    btn.innerHTML = "â™¡ ì¶”ì²œ";
                }
            } catch (e) {
                console.warn("ì¶”ì²œ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e);
            }
        }

        async function toggleLike() {
            try {
                const response = await fetchWithRefresh(`/recommend/toggle?targetId=${courseId}&catCode=crs`);
                const result = await response.json();

                const btn = document.getElementById("btnLike");

                if (result.data?.status === "Y") {
                    btn.classList.add("active");
                    btn.innerHTML = "â¤ï¸ ì¶”ì²œ ì·¨ì†Œ";
                    showToast("ì¶”ì²œí–ˆìŠµë‹ˆë‹¤!");
                } else {
                    btn.classList.remove("active");
                    btn.innerHTML = "â™¡ ì¶”ì²œ";
                    showToast("ì¶”ì²œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                }

            } catch (e) {
                console.error("ì¶”ì²œ ì˜¤ë¥˜:", e);
            }
        }

        async function deleteCourse() {
            if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            const response = await fetchWithRefresh(`/courses/${courseId}`, {method: "DELETE"});
            if (!response.ok) {
                alert("ì‚­ì œ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                return;
            }

            alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.href = "/courses/view/list";
        }

        function renderDayTabs() {
            const tabs = $("#dayTabs").empty();

            for (let d = 1; d <= maxDay; d++) {
                const btn = $(`<button>${d}ì¼ì°¨</button>`);
                if (d === activeDay) btn.addClass("active");

                btn.click(() => {
                    activeDay = d;
                    $(".tabs button").removeClass("active");
                    btn.addClass("active");
                    renderList();
                    renderMap();
                });

                tabs.append(btn);
            }
        }

        $("#tabLeft").click(() => {
            document.getElementById("dayTabs").scrollBy({left: -150, behavior: "smooth"});
        });

        $("#tabRight").click(() => {
            document.getElementById("dayTabs").scrollBy({left: 150, behavior: "smooth"});
        });

        function renderList() {
            const box = $("#placeList").empty();
            grouped[activeDay].forEach((i, idx) => {
                box.append(`
            <div class="place-item">
                <div class="place-index">${idx + 1}</div>
                <div>${i.title}</div>
            </div>
        `);
            });
        }

        function initMap() {
            map = new kakao.maps.Map(document.getElementById("map"), {
                center: new kakao.maps.LatLng(37.4979, 127.0276),
                level: 6
            });
        }

        function renderMap() {
            clearMap();

            const items = grouped[activeDay];
            const bounds = new kakao.maps.LatLngBounds();
            const coords = [];

            items.forEach(i => {
                if (!i.mapx || !i.mapy) return;

                const pos = new kakao.maps.LatLng(parseFloat(i.mapy), parseFloat(i.mapx));
                coords.push(pos);
                bounds.extend(pos);

                const marker = new kakao.maps.Marker({
                    map,
                    position: pos,
                    image: new kakao.maps.MarkerImage(
                        "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
                        new kakao.maps.Size(24, 35)
                    )
                });

                markers.push(marker);
            });

            if (coords.length >= 2) {
                const line = new kakao.maps.Polyline({
                    map,
                    path: coords,
                    strokeWeight: 4,
                    strokeColor: "#000",
                    strokeOpacity: 0.9
                });
                polylines.push(line);
            }

            if (!bounds.isEmpty()) map.setBounds(bounds);
        }

        function clearMap() {
            markers.forEach(m => m.setMap(null));
            polylines.forEach(p => p.setMap(null));
            markers = [];
            polylines = [];
        }

        function loadCourseReviews() {
            fetch(`/reviews/target?type=COURSE&id=${courseId}&size=3`)
                .then(res => res.json())
                .then(result => {
                    const reviews = result.content;
                    const box = $("#courseReviewList").empty();

                    if (!reviews || reviews.length === 0) {
                        box.html(`<p style="color:#888;">ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`);
                        return;
                    }

                    reviews.forEach(r => {
                        box.append(`
                        <div class="review-card">
                          <h4>${r.writer || "ìµëª…"}</h4>
                          <p><strong>${r.title}</strong></p>
                          <p>${r.content}</p>
                          <div class="review-meta">â­ ${r.rating}ì  | ${r.createdAt}</div>
                        </div>
                    `);
                    });
                })
                .catch(err => {
                    console.error("ë¦¬ë·° ë¡œë“œ ì‹¤íŒ¨:", err);
                });
        }

        async function goAddToPlan(courseId, planId) {
            await fetchWithRefresh(`/plans/${planId}/course?courseId=${courseId}`, {
                method: "POST"
            });

            alert("ì½”ìŠ¤ê°€ ê³„íšì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
            location.href = `/plans/view/${planId}`;
        }

    </script>

</th:block>

</body>
</html>
