<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>마이페이지 | Travel Planing</title>
    <link rel="stylesheet" th:href="@{/css/mypage.css}">
</head>
<body>
<header class="header">
    <div class="logo-area">
        <img th:src="@{/images/logo.png}" alt="Logo" class="logo">
        <span class="title">TRAVEL PLANING</span>
    </div>

    <div class="user-menu">
        <span class="welcome-text" th:text="|${member.username} 님 환영합니다.|">홍길동 님 환영합니다.</span>
        <nav>
            <a th:href="@{/}">Home</a>
            <a th:href="@{/mypage}">마이페이지</a>
            <a th:href="@{/logout}">로그아웃</a>
        </nav>
    </div>
</header>



<main class="mypage-container">
    <!-- 왼쪽 프로필 영역 -->
    <section class="profile">
        <img th:src="${member.imageUrl != null ? member.imageUrl : '/images/profile-sample.jpg'}"
             alt="프로필 이미지"
             class="profile-img">
        <h2 th:text="${member.username}">홍길동</h2>
        <p class="user-id" th:text="'@' + ${member.loginId}">@아이디</p>
        <p class="user-email" th:text="${member.email}">email@abc.com</p>
        <button class="btn-edit" onclick="location.href='/member/edit'">프로필 수정</button>

        <button class="btn-review" onclick="location.href='/review/my'">내가 쓴 리뷰보기</button>
    </section>

    <!-- 오른쪽 최근 계획 -->
    <section class="plan-section">
        <div class="plan-header">
            <h3>최근 내 계획</h3>
            <select class="plan-filter">
                <option>Value</option>
            </select>
        </div>

        <div class="plan-list" id="plan-list">
            <p class="no-plan">여행 계획을 불러오는 중...</p>
        </div>
    </section>
</main>

<!-- ✅ 자동 토큰 재발급 공통 JS -->
<script src="/js/common.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const response = await fetchWithRefresh("/members/plans", {
                method: "GET",
                headers: { "Content-Type": "application/json" },
                credentials: "include" // ✅ JWT 쿠키 포함
            });

            const result = await response.json();
            const list = document.getElementById("plan-list");

            if (response.ok && result.status === 200) {
                const plans = result.data;

                if (plans.length === 0) {
                    list.innerHTML = `<p class="no-plan">아직 작성한 여행계획이 없습니다.</p>`;
                } else {
                    list.innerHTML = plans.map(plan => `
                    <div class="plan-item">
                        <div class="plan-title">${plan.title}</div>
                        <button class="btn-review-small" onclick="location.href='/review/${plan.id}'">리뷰</button>
                    </div>
                `).join("");
                }
            } else {
                list.innerHTML = `<p class="no-plan">여행 계획을 불러올 수 없습니다. (${result.message})</p>`;
            }
        } catch (err) {
            console.error("서버 통신 오류:", err);
            document.getElementById("plan-list").innerHTML =
                `<p class="no-plan">서버 오류로 데이터를 불러올 수 없습니다.</p>`;
        }
    });
</script>
</body>
</html>