<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="ko"
      layout:decorate="~{/common/layout}">

<head layout:fragment="head">
    <meta charset="UTF-8">
    <title>ìˆ™ì†Œ ìƒì„¸ë³´ê¸° | Travel Planning</title>

    <!-- detail ê³µí†µ CSS -->
    <link rel="stylesheet" th:href="@{/css/detail.css}">
    <style>
        #btnBack {
            left: 20px !important;
        }
    </style>
</head>

<body>

<div layout:fragment="content">

    <div class="detail-container">

        <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
        <button class="btn-nav" id="btnBack">â† ë’¤ë¡œê°€ê¸°</button>

        <h1 class="detail-title">ìˆ™ì†Œ ìƒì„¸ì •ë³´</h1>

        <!-- ë¡œë”© -->
        <div id="loading">
            <div class="loading-spinner"></div>
            <p class="loading-text">ğŸŒ€ ìƒì„¸ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <!-- ìƒì„¸ì •ë³´ -->
        <div id="detail" style="display:none;"></div>

        <!-- ë¦¬ë·° ì˜ì—­ -->
        <div id="reviews" class="reviews" style="display:none;">
            <h3>ğŸ“ ìµœì‹  ë¦¬ë·°</h3>
            <div id="review-list"></div>
        </div>

        <!-- ì§€ë„ -->
        <div id="map">ì§€ë„ ë¡œë”© ì¤‘...</div>

        <!-- ë²„íŠ¼ ê·¸ë£¹ -->
        <div id="actions" class="btn-group" style="display:none;">
            <button class="btn btn-accommodation" id="btnAcc">ğŸ¨ ê´€ê´‘ì§€ ëª©ë¡ ë³´ê¸°</button>
            <button class="btn btn-plan" id="btnTspDetail">ğŸ—“ï¸ ê´€ê´‘ì§€ ìƒì„¸ ì •ë³´ë¡œ ëŒì•„ê°€ê¸°</button>
            <button class="btn btn-like" id="btnLike">â™¡ ì¶”ì²œ</button>
        </div>

    </div>

    <!-- Kakao Map SDK -->
    <script th:inline="javascript">
        const kakaoKey = /*[[${kakaoKey}]]*/ '';
        const script = document.createElement('script');
        script.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoKey}&autoload=false`;
        script.async = true;
        script.onload = () => {
            console.log("ğŸ—ºï¸ Kakao Map SDK ë¡œë“œ ì™„ë£Œ");
            loadDetail();
        };
        document.head.appendChild(script);
    </script>

    <!-- Core Script (ì›ë³¸ ê¸°ëŠ¥ 100% ìœ ì§€) -->
    <script th:inline="javascript">
        const accId = /*[[${accId}]]*/ 0;
        const tspId = /*[[${tspId}]]*/ 0;

        let liked = false;

        function showToast(message) {
            const toast = document.createElement("div");
            toast.textContent = message;
            toast.className = "toast-message";
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // ìƒì„¸ì •ë³´ ë¡œë“œ
        function loadDetail() {
            fetchWithRefresh(`/accommodations/detail?id=${accId}`)
                .then(res => res.json())
                .then(result => {
                    const data = result.data;
                    if (!data) throw new Error("ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤");

                    document.getElementById("loading").style.display = "none";
                    document.getElementById("detail").style.display = "block";
                    document.getElementById("actions").style.display = "flex";

                    document.getElementById("detail").innerHTML = `
                        <img src="${data.firstImage || '/images/no-image.png'}"
                             class="detail-image">

                        <h2 class="detail-name">${data.title}</h2>

                        <div class="info">
                            <p><strong>ì£¼ì†Œ:</strong> ${data.address || 'ì •ë³´ ì—†ìŒ'}</p>
                            <p><strong>ì „í™”ë²ˆí˜¸:</strong> ${data.tel || 'ì •ë³´ ì—†ìŒ'}</p>
                            <p><strong>í™ˆí˜ì´ì§€:</strong>
                                ${data.homepage ? `<a href="${data.homepage}" target="_blank">${data.homepage}</a>` : 'ì •ë³´ ì—†ìŒ'}
                            </p>
                            <p><strong>ì„¤ëª…:</strong> ${data.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                            <p><strong>ì¶”ì²œìˆ˜:</strong> ${data.recCount}</p>
                            <p><strong>ì‘ì„±ì¼:</strong> ${data.createdAt}</p>
                            <p><strong>ìˆ˜ì •ì¼:</strong> ${data.modifiedAt}</p>
                            <p><strong>ì¹´í…Œê³ ë¦¬ ì½”ë“œ:</strong> ${data.catCode}</p>
                        </div>
                    `;

                    initMap(data.mapy, data.mapx, data.title);

                    loadReviews();
                })
                .catch(err => {
                    console.error("âŒ ìƒì„¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
                    document.getElementById("loading").innerHTML =
                        `<p class='error-text'>âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
                });
        }

        // ë¦¬ë·° ë¡œë“œ
        function loadReviews() {
            fetch(`/reviews/target?type=acc&id=${accId}&size=3`)
                .then(res => res.json())
                .then(result => {
                    const reviews = result.content;

                    const reviewSection = document.getElementById("reviews");
                    const reviewList = document.getElementById("review-list");

                    reviewSection.style.display = "block";
                    reviewList.innerHTML = "";

                    if (!reviews || reviews.length === 0) {
                        reviewList.innerHTML = `<p style="color:#888;">ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                        return;
                    }

                    reviews.forEach(r => {
                        const div = document.createElement("div");
                        div.classList.add("review-card");
                        div.innerHTML = `
                            <h4>${r.writer || "ìµëª… ì‚¬ìš©ì"}</h4>
                            <p><strong>${r.title}</strong></p>
                            <p>${r.content}</p>
                            <div class="review-meta">â­ ${r.rating || 0}ì  | ${r.createdAt}</div>
                        `;
                        reviewList.appendChild(div);
                    });
                })
                .catch(err => {
                    console.error("âŒ ë¦¬ë·° ë¡œë“œ ì‹¤íŒ¨:", err);
                    document.getElementById("review-list").innerHTML =
                        `<p style="color:red;">ë¦¬ë·° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
                });
        }

        // Kakao Map
        function initMap(lat, lng, title) {
            if (!window.kakao || !kakao.maps) {
                setTimeout(() => initMap(lat, lng, title), 300);
                return;
            }

            kakao.maps.load(() => {
                const map = new kakao.maps.Map(document.getElementById('map'), {
                    center: new kakao.maps.LatLng(lat, lng),
                    level: 3
                });

                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(lat, lng)
                });
                marker.setMap(map);

                document.getElementById("map").style.color = "transparent";
            });
        }

        // ë²„íŠ¼ ê¸°ëŠ¥ë“¤
        document.getElementById("btnBack").addEventListener("click", () => {
            window.history.back();
        });

        document.getElementById("btnAcc").addEventListener("click", () => {
            // window.location.href = `/spots/view/tourspotlist`;
            safeRedirect(`/spots/view/tourspotlist`);
        });

        document.getElementById("btnTspDetail").addEventListener("click", () => {
            window.location.href = `/spots/view/tourspotdetail?id=${tspId}`;
        });

        document.getElementById("btnLike").addEventListener("click", () => {
            fetchWithRefresh(`/recommend/toggle?targetId=${accId}&catCode=acc`)
                .then(res => res.json())
                .then(result => {
                    const btn = document.getElementById("btnLike");

                    if (result.data.status === "Y") {
                        btn.classList.add("active");
                        btn.innerHTML = "â¤ï¸ ì¶”ì²œ ì·¨ì†Œ";
                        showToast("ìˆ™ì†Œë¥¼ ì¶”ì²œí–ˆìŠµë‹ˆë‹¤!");
                    } else {
                        btn.classList.remove("active");
                        btn.innerHTML = "â™¡ ì¶”ì²œ";
                        showToast("ì¶”ì²œì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.");
                    }

                    loadDetail();
                })
                .catch(err => {
                    console.error("âŒ ì¶”ì²œ í† ê¸€ ì‹¤íŒ¨:", err);
                    showToast("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
        });
    </script>

</div>

</body>
</html>
