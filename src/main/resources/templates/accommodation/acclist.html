<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="ko"
      layout:decorate="~{/common/layout}">

<head layout:fragment="head">
    <meta charset="UTF-8">
    <title>ìˆ™ì†Œ ëª©ë¡ | Travel Planning</title>

    <!-- list ê³µí†µ CSS -->
    <link rel="stylesheet" th:href="@{/css/list.css}">
</head>

<body>

<div layout:fragment="content">

    <!-- ë’¤ë¡œê°€ê¸° + ì œëª© -->
    <header class="list-header">
        <h1 class="page-title">ìˆ™ì†Œ ëª©ë¡</h1>
        <button class="btn-nav" id="btnBack">â† ë’¤ë¡œê°€ê¸°</button>
    </header>

    <!-- 3Ã—3 ì¹´ë“œ ê·¸ë¦¬ë“œ -->
    <div id="acc-container" class="grid"></div>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    <div id="pagination" class="pagination"></div>


    <!-- JS: ê¸°ëŠ¥ì€ ì ˆëŒ€ ìˆ˜ì • ì—†ìŒ -->
    <script th:inline="javascript">
        const tspId = /*[[${tspId}]]*/ 0;
        console.log("ğŸ“ ì „ë‹¬ë°›ì€ tspId:", tspId);

        let page = 0;
        let size = 9;

        function loadAccs() {
            const query = new URLSearchParams({
                page,
                size,
                id: tspId
            });

            fetchWithRefresh(`/accommodations/distance?${query}`)
                .then(res => res.json())
                .then(result => {
                    if (result.status !== 200) throw new Error(result.message);

                    const data = result.data;
                    renderAccs(data.contents);
                    renderPagination(data.totalPages);
                })
                .catch(err => {
                    console.error("âŒ ìˆ™ì†Œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
                    document.getElementById("acc-container").innerHTML =
                        "<p class='empty-text'>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
                });
        }

        function renderAccs(data) {
            const container = document.getElementById("acc-container");
            container.innerHTML = "";

            if (!data || data.length === 0) {
                container.innerHTML = "<p class='empty-text'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                return;
            }

            data.forEach(acc => {
                const card = document.createElement("div");
                card.classList.add("card");

                const img = document.createElement("img");
                img.src = acc.firstImage || "/images/no-image.png";
                img.classList.add("card-img");

                const title = document.createElement("h3");
                title.textContent = acc.title;

                const addr = document.createElement("p");
                addr.textContent = acc.address;

                const rec = document.createElement("p");
                rec.textContent = "ì¶”ì²œìˆ˜: " + (acc.recCount ?? 0);

                let distanceText = "";
                if (acc.distanceMeter != null) {
                    const dist = acc.distanceMeter;

                    const displayDistance =
                        dist >= 1000 ? `${(dist / 1000).toFixed(2)}km` : `${dist.toFixed(0)}m`;

                    const minutes = Math.round(dist / 75);
                    let timeText = "";

                    if (minutes < 1) timeText = "ë„ë³´ 1ë¶„ ë¯¸ë§Œ";
                    else if (minutes < 60) timeText = `ë„ë³´ ì•½ ${minutes}ë¶„`;
                    else {
                        const h = Math.floor(minutes / 60);
                        const m = minutes % 60;
                        timeText = `ë„ë³´ ì•½ ${h}ì‹œê°„ ${m > 0 ? `${m}ë¶„` : ""}`;
                    }

                    distanceText = `ğŸ“ ê±°ë¦¬: ${displayDistance} (${timeText})`;
                } else {
                    distanceText = "ğŸ“ ê±°ë¦¬ ì •ë³´ ì—†ìŒ";
                }

                const distanceInfo = document.createElement("p");
                distanceInfo.textContent = distanceText;

                card.addEventListener("click", () => {
                    window.location.href =
                        `/accommodations/view/accdetail?accId=${acc.id}&tspId=${tspId}`;
                });

                card.append(img, title, addr, rec, distanceInfo);
                container.appendChild(card);
            });
        }

        function renderPagination(totalPages) {
            const pagination = document.getElementById("pagination");
            pagination.innerHTML = "";

            if (totalPages <= 1) return;

            const prevBtn = document.createElement("button");
            prevBtn.textContent = "â† Previous";
            prevBtn.classList.add("page-btn");
            if (page === 0) prevBtn.classList.add("disabled");

            prevBtn.onclick = () => {
                if (page > 0) {
                    page--;
                    loadAccs();
                }
            };
            pagination.appendChild(prevBtn);

            const maxVisible = 5;
            let start = Math.max(0, page - 2);
            let end = Math.min(totalPages, start + maxVisible);

            if (end - start < maxVisible && start > 0) {
                start = Math.max(0, end - maxVisible);
            }

            for (let i = start; i < end; i++) {
                const pageBtn = document.createElement("button");
                pageBtn.textContent = i + 1;
                pageBtn.classList.add("page-btn");
                if (i === page) pageBtn.classList.add("active");

                pageBtn.onclick = () => {
                    page = i;
                    loadAccs();
                };
                pagination.appendChild(pageBtn);
            }

            const nextBtn = document.createElement("button");
            nextBtn.textContent = "Next â†’";
            nextBtn.classList.add("page-btn");
            if (page >= totalPages - 1) nextBtn.classList.add("disabled");

            nextBtn.onclick = () => {
                if (page < totalPages - 1) {
                    page++;
                    loadAccs();
                }
            };
            pagination.appendChild(nextBtn);
        }

        document.getElementById("btnBack").addEventListener("click", () => {
            window.history.back();
        });

        document.addEventListener("DOMContentLoaded", loadAccs);
    </script>

</div>

</body>
</html>
