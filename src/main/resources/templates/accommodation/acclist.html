<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <script src="/js/common.js"></script>
    <meta charset="UTF-8">
    <title>ìˆ™ì†Œ ëª©ë¡ | Travel Planning</title>
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background: #fafafa;
            margin: 0;
        }

        header {
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
            padding: 20px 40px 0;
            position: relative;
        }

        .btn-back {
            padding: 5px 14px;
            border: none;
            border-radius: 6px;
            background-color: #ddd;
            cursor: pointer;
            font-weight: 600;
            color: #333;
            transition: 0.2s;
            margin-bottom: 6px;
        }

        h1 {
            flex: 1;
            text-align: center;
            font-size: 32px;
            font-weight: 700;
            color: #222;
            margin: 0;
            padding: 10px 0 20px;
            letter-spacing: -0.3px;
            line-height: 1.2;
        }


        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: scale(1.02);
        }

        .card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            background: #ddd;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
            gap: 6px;
        }



        .page-btn {
            border: none;
            background: none;
            cursor: pointer;
            padding: 8px 12px;
            font-size: 14px;
            color: #333;
        }

        .page-btn.active {
            background-color: #333;
            color: #fff;
            border-radius: 5px;
        }

        .page-btn.disabled {
            color: #aaa;
            cursor: not-allowed;
        }

    </style>
</head>
<body>

<!-- âœ… ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
<header>
    <button class="btn-back" id="btnBack">â† ë’¤ë¡œê°€ê¸°</button>

    <h1>ìˆ™ì†Œ ëª©ë¡</h1>
</header>


<!-- âœ… ìˆ™ì†Œ ì¹´ë“œ ì¶œë ¥ ì˜ì—­ -->
<div id="acc-container" class="grid"></div>


<!-- âœ… í˜ì´ì§€ë„¤ì´ì…˜ -->
<div id="pagination" class="pagination"></div>

<script th:inline="javascript">
    // ======= ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì „ë‹¬ë°›ì€ tspId =======
    const tspId = /*[[${tspId}]]*/ 0;
    console.log("ğŸ“ ì „ë‹¬ë°›ì€ tspId:", tspId);

    let page = 0;
    let size = 9;

    // ======= ìˆ™ì†Œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° =======
    function loadAccs() {
        const query = new URLSearchParams({
            page,
            size,
            id: tspId
        });

        fetchWithRefresh(`/accommodations/distance?${query}`)
            .then(res => res.json())
            .then(result => {
                if (result.status !== 200) throw new Error(result.message);

                const data = result.data;
                renderAccs(data.contents); // âœ… ìˆ™ì†Œ ëª©ë¡
                renderPagination(data.totalPages); // âœ… í˜ì´ì§€ë„¤ì´ì…˜
            })
            .catch(err => {
                console.error("âŒ ìˆ™ì†Œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
                document.getElementById("acc-container").innerHTML =
                    "<p style='text-align:center; grid-column:1/-1;'>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
            });
    }

    // ======= ìˆ™ì†Œ ì¹´ë“œ ë Œë”ë§ =======
    function renderAccs(data) {
        const container = document.getElementById("acc-container");
        container.innerHTML = "";

        if (!data || data.length === 0) {
            container.innerHTML =
                "<p style='text-align:center; grid-column:1/-1;'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
        }

        data.forEach(acc => {
            const card = document.createElement("div");
            card.classList.add("card");

            const img = document.createElement("img");
            img.src = acc.firstImage || "/images/no-image.png";

            const title = document.createElement("h3");
            title.textContent = acc.title;

            const addr = document.createElement("p");
            addr.textContent = acc.address;

            const rec = document.createElement("p");
            rec.textContent = "ì¶”ì²œìˆ˜: " + (acc.recCount ?? 0);

            const distanceInfo = document.createElement("p");
            if (acc.distanceMeter != null) {
                const distance = acc.distanceMeter;

                // --- ë‹¨ìœ„ ë³€í™˜ ---
                let displayDistance;
                if (distance >= 1000) {
                    displayDistance = `${(distance / 1000).toFixed(2)}km`;
                } else {
                    displayDistance = `${distance.toFixed(0)}m`;
                }

                // --- ë„ë³´ ì‹œê°„ ê³„ì‚° (75m/min ê¸°ì¤€) ---
                const minutes = Math.round(distance / 75);
                let timeText = "";

                if (minutes < 1) {
                    timeText = "ë„ë³´ 1ë¶„ ë¯¸ë§Œ";
                } else if (minutes < 60) {
                    timeText = `ë„ë³´ ì•½ ${minutes}ë¶„`;
                } else {
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    timeText = `ë„ë³´ ì•½ ${hours}ì‹œê°„ ${mins > 0 ? `${mins}ë¶„` : ""}`;
                }

                distanceText = `ğŸ“ ì„ íƒí•œ ê´€ê´‘ì§€ë¡œë¶€í„°ì˜ ê±°ë¦¬: ì•½ ${displayDistance} (${timeText})`;
            } else {
                distanceText = "ğŸ“ ê±°ë¦¬ ì •ë³´ ì—†ìŒ";
            }

            distanceInfo.textContent = distanceText;

            // âœ… í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ ì´ë™
            card.addEventListener("click", () => {
                window.location.href = `/accommodations/view/accdetail?accId=${acc.id}&tspId=${tspId}`;
            });

            card.append(img, title, addr, rec, distanceInfo);
            container.appendChild(card);
        });
    }

    // ======= í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§ =======
    function renderPagination(totalPages) {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        if (totalPages <= 1) return;

        // Previous
        const prevBtn = document.createElement("button");
        prevBtn.textContent = "â† Previous";
        prevBtn.classList.add("page-btn");
        if (page === 0) prevBtn.classList.add("disabled");
        prevBtn.addEventListener("click", () => {
            if (page > 0) {
                page--;
                loadAccs();
            }
        });
        pagination.appendChild(prevBtn);

        // í˜ì´ì§€ ë²ˆí˜¸ í‘œì‹œ (1 ~ totalPages)
        const maxVisible = 5; // í•œ ë²ˆì— ë³´ì´ëŠ” í˜ì´ì§€ ìˆ˜
        let start = Math.max(0, page - 2);
        let end = Math.min(totalPages, start + maxVisible);

        if (end - start < maxVisible && start > 0) {
            start = Math.max(0, end - maxVisible);
        }

        for (let i = start; i < end; i++) {
            const pageBtn = document.createElement("button");
            pageBtn.textContent = i + 1;
            pageBtn.classList.add("page-btn");
            if (i === page) pageBtn.classList.add("active");
            pageBtn.addEventListener("click", () => {
                page = i;
                loadAccs();
            });
            pagination.appendChild(pageBtn);
        }

        // Next
        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Next â†’";
        nextBtn.classList.add("page-btn");
        if (page >= totalPages - 1) nextBtn.classList.add("disabled");
        nextBtn.addEventListener("click", () => {
            if (page < totalPages - 1) {
                page++;
                loadAccs();
            }
        });
        pagination.appendChild(nextBtn);
    }

    // ======= ë²„íŠ¼ ì´ë²¤íŠ¸ =======
    document.getElementById("btnBack").addEventListener("click", () => {
        window.history.back();
    });

    // ======= ì´ˆê¸° ë¡œë“œ =======
    document.addEventListener("DOMContentLoaded", loadAccs);
</script>
</body>
</html>
