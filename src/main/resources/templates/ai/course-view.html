<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AI 여행 코스 결과</title>
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_APP_KEY"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <style>
    body { font-family: Pretendard, sans-serif; margin: 0; padding: 0; background: #f5f6f8; }
    .container { display: flex; justify-content: center; margin-top: 50px; }
    .map-area {
      width: 600px;
      height: 500px;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 0 8px rgba(0,0,0,0.15);
      background: white;
    }
    .list-area {
      width: 320px;
      height: 500px;
      margin-left: 30px;
      background: #fff;
      border-radius: 20px;
      padding: 15px;
      overflow-y: auto;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    .day-title {
      font-weight: bold;
      margin: 15px 0 5px 5px;
      color: #4b73ff;
    }
    .item {
      background: #f9f9f9;
      border-radius: 10px;
      padding: 10px 15px;
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: grab;
      transition: all 0.2s ease;
    }
    .item:hover { background: #f0f2ff; }
    .delete-btn {
      display: none;
      color: red;
      font-size: 14px;
      cursor: pointer;
    }
    .item:hover .delete-btn { display: inline; }

    .buttons { text-align: center; margin-top: 40px; }
    button {
      margin: 0 10px;
      padding: 10px 25px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    .btn-primary { background: #4b73ff; color: white; }
    .btn-secondary { background: #ccc; color: #333; }

    h2 { text-align: center; margin-top: 30px; color: #333; }
  </style>
</head>
<body>
<h2>AI 추천 여행 코스 결과</h2>

<div class="container">
  <div id="map" class="map-area"></div>
  <div class="list-area">
    <div id="courseList"></div>
  </div>
</div>

<div class="buttons">
  <button id="retryBtn" class="btn-secondary">코스 다시짜기</button>
  <button id="confirmBtn" class="btn-primary">코스 확정하기</button>
</div>

<script th:inline="javascript">
  const planId = [[${planId}]];

  let map;
  let markers = [];
  let polylines = [];

  $(document).ready(function() {
    initMap();
    loadCourse();
  });

  // Kakao Map 초기화
  function initMap() {
    const container = document.getElementById('map');
    const options = { center: new kakao.maps.LatLng(37.4979, 127.0276), level: 6 };
    map = new kakao.maps.Map(container, options);
  }

  // AI 코스 로드
  function loadCourse() {
    $.post(`/ai/courses/plan/${planId}`, function(res) {
      const data = res.data;
      renderCourseList(data.days);
      renderMap(data.days);
    }).fail(() => {
      alert("AI 코스 데이터를 불러오지 못했습니다.");
    });
  }

  // 지도에 마커 및 경로 표시
  function renderMap(days) {
    clearMap();
    const lineCoords = [];

    days.forEach(day => {
      day.items.forEach((item, idx) => {
        // 실제 데이터에선 DB 좌표를 불러와야 함 (임시 랜덤 좌표)
        const lat = 37.4979 + Math.random() * 0.02;
        const lng = 127.0276 + Math.random() * 0.02;
        const position = new kakao.maps.LatLng(lat, lng);

        const marker = new kakao.maps.Marker({
          map: map,
          position: position,
          title: `${day.dayNo}일차 ${item.placeType}`
        });
        markers.push(marker);
        lineCoords.push(position);
      });
    });

    if (lineCoords.length > 1) {
      const polyline = new kakao.maps.Polyline({
        path: lineCoords,
        strokeWeight: 3,
        strokeColor: '#4b73ff',
        strokeOpacity: 0.8
      });
      polyline.setMap(map);
      polylines.push(polyline);

      // 지도 영역 자동 조정
      const bounds = new kakao.maps.LatLngBounds();
      lineCoords.forEach(coord => bounds.extend(coord));
      map.setBounds(bounds);
    }
  }

  // 지도 클리어
  function clearMap() {
    markers.forEach(m => m.setMap(null));
    polylines.forEach(p => p.setMap(null));
    markers = [];
    polylines = [];
  }

  // 코스 리스트 렌더링
  function renderCourseList(days) {
    const list = $("#courseList").empty();

    days.forEach(day => {
      const title = $(`<div class="day-title">${day.dayNo}일차</div>`);
      list.append(title);

      const dayList = $("<div class='day-items'></div>");
      day.items.forEach((item, idx) => {
        const div = $(`
                    <div class="item" data-place-id="${item.placeId}" data-day="${day.dayNo}" data-order="${idx + 1}">
                        <span>${idx + 1}. ${item.placeType} (${item.placeId})</span>
                        <span class="delete-btn">삭제</span>
                    </div>
                `);
        dayList.append(div);
      });
      list.append(dayList);
    });

    // 삭제 버튼
    $(".delete-btn").click(function() {
      $(this).closest(".item").remove();
    });

    // 드래그 앤 드롭 (순서 변경)
    $(".day-items").sortable({
      update: function(event, ui) {
        renumberItems();
      }
    });
  }

  // 순서 다시 번호 매기기
  function renumberItems() {
    $(".day-items").each(function() {
      $(this).find(".item").each(function(idx) {
        $(this).attr("data-order", idx + 1);
        $(this).find("span:first").text(`${idx + 1}. ${$(this).data("place-id")}`);
      });
    });
  }

  // 코스 다시짜기 (피드백 페이지 이동)
  $("#retryBtn").click(function() {
    window.location.href = `/ai/courses/feedback/${planId}`;
  });

  // 코스 확정하기 (수정 페이지로 이동)
  $("#confirmBtn").click(function() {
    window.location.href = `/courses/edit/${planId}`;
  });
</script>
</body>
</html>