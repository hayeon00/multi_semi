<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>AI 코스 생성 | Travel Planning</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script th:src="@{|https://dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoKey}&autoload=false|}"></script>

  <style>
    body { font-family: 'Noto Sans KR', sans-serif; margin: 0; background-color: #f9f9f9; }
    header { display: flex; justify-content: space-between; align-items: center; background-color: #d9d9d9; padding: 15px 30px; }
    .logo { font-weight: bold; }
    .title { font-size: 1.5rem; font-weight: bold; }
    nav a { margin-left: 10px; color: black; text-decoration: none; }

    main { width: 900px; margin: 40px auto; background: #fff; border-radius: 20px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .map-container { display: flex; background: #f3f3f3; border-radius: 20px; overflow: hidden; }
    #map { width: 70%; height: 500px; }
    .side-panel { width: 30%; background: #f9f9f9; padding: 10px; display: flex; flex-direction: column; }
    .tabs { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; }
    .tabs button { border: none; padding: 5px 10px; border-radius: 8px; background: #ccc; cursor: pointer; }
    .tabs button.active { background: #000; color: #fff; }
    .place-list { flex: 1; overflow-y: auto; text-align: left; padding: 5px 10px; }
    .place-item { background: white; margin: 4px 0; border-radius: 10px; padding: 8px; }
    .btns { text-align: center; margin-top: 20px; }
    .btns button { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; margin: 0 10px; }
    .btn-retry { background: #ccc; color: #333; }
    .btn-confirm { background: #000000; color: #fff; }
  </style>
</head>

<body>
<header>
  <div class="logo">Logo</div>
  <div class="title">TRAVEL PLANNING</div>
  <div class="menu">
    <span>{사용자} 님 환영합니다.</span>
    <nav>
      <a href="/">Home</a>
      <a href="/mypage">마이페이지</a>
      <a href="/logout">로그아웃</a>
    </nav>
  </div>
</header>

<main>
  <div class="map-container">
    <div id="map"></div>
    <div class="side-panel">
      <div class="tabs" id="dayTabs"></div>
      <div class="place-list" id="placeList"></div>
    </div>
  </div>

  <div class="btns">
    <button class="btn-retry" id="btnRetry">코스 다시짜기</button>
    <button class="btn-confirm" id="btnConfirm">코스 확정하기</button>
  </div>
</main>

<script th:inline="javascript">
  const planId = [[${planId}]];
  let map, markers = [], polylines = [];
  let days = [];
  let activeDay = 1;

  $(document).ready(() => {
    kakao.maps.load(function() {
      initMap();
      generateCourse();
    });
  });


  // 지도 초기화
  function initMap() {
    const container = document.getElementById("map");
    const options = { center: new kakao.maps.LatLng(37.4979, 127.0276), level: 6 };
    map = new kakao.maps.Map(container, options);
  }

  // AI 코스 생성
  function generateCourse() {
    $.post(`/ai/courses/plan/${planId}`, function(res) {
      if (!res.data) return alert("AI 코스 생성 실패");
      days = res.data.days;
      enrichPlaces().then(() => {
        renderTabs();
        renderList();
        renderMap();
      });
    });
  }

  // 좌표 정보 보강
  async function enrichPlaces() {
    const promises = [];
    days.forEach(day => {
      day.items.forEach(item => {
        const apiUrl =
                item.categoryCode === "acc"
                        ? `/accommodations/detail?id=${item.placeId}`
                        : `/spots/detail?id=${item.placeId}`;

        const p = $.get(apiUrl).then(res => {
          if (res.data) {
            item.title = res.data.name || res.data.title;
            item.mapx = res.data.mapx;
            item.mapy = res.data.mapy;
          }
        });
        promises.push(p);
      });
    });
    await Promise.all(promises);
  }

  // 탭 렌더링
  function renderTabs() {
    const tabs = $("#dayTabs").empty();
    days.forEach(day => {
      const btn = $(`<button class="${day.dayNo === 1 ? "active" : ""}">${day.dayNo}일차</button>`);
      btn.click(() => {
        activeDay = day.dayNo;
        $(".tabs button").removeClass("active");
        btn.addClass("active");
        renderList();
        renderMap();
      });
      tabs.append(btn);
    });
  }

  // 리스트 렌더링
  function renderList() {
    const list = $("#placeList").empty();
    const currentDay = days.find(d => d.dayNo === activeDay);
    if (!currentDay) return;
    currentDay.items.forEach((item, idx) => {
      const div = $(`<div class="place-item">${idx + 1}. ${item.title || "장소"} (${item.categoryCode})</div>`);
      list.append(div);
    });
  }

  // 지도 렌더링
  function renderMap() {
    clearMap();
    const bounds = new kakao.maps.LatLngBounds();

    days.forEach(day => {
      const coords = [];
      day.items.forEach(item => {
        if (!item.mapy || !item.mapx) return; // 좌표 없는 경우 스킵
        const pos = new kakao.maps.LatLng(parseFloat(item.mapy), parseFloat(item.mapx));
        coords.push(pos);
        const markerImage = new kakao.maps.MarkerImage(
                day.dayNo === activeDay
                        ? "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png"
                        : "https://t1.daumcdn.net/mapjsapi/images/marker.png",
                new kakao.maps.Size(24, 35)
        );
        const marker = new kakao.maps.Marker({
          map,
          position: pos,
          title: `[${day.dayNo}일차] ${item.title}`,
          image: markerImage
        });
        markers.push(marker);
        bounds.extend(pos);
      });

      if (coords.length > 1) {
        const polyline = new kakao.maps.Polyline({
          path: coords,
          strokeWeight: 4,
          strokeColor: day.dayNo === activeDay ? "#000" : "#aaa",
          strokeOpacity: 0.9
        });
        polyline.setMap(map);
        polylines.push(polyline);
      }
    });

    // 모든 마커 기준으로 중심 이동
    if (!bounds.isEmpty()) map.setBounds(bounds);
  }

  function clearMap() {
    markers.forEach(m => m.setMap(null));
    polylines.forEach(p => p.setMap(null));
    markers = [];
    polylines = [];
  }

  // 코스 다시짜기
  $("#btnRetry").click(() => {
    if (!confirm("AI에게 다시 코스를 추천받을까요?")) return;
    $.post(`/ai/courses/feedback`, JSON.stringify({ planId }), function(res) {
      days = res.data.days;
      enrichPlaces().then(() => {
        activeDay = 1;
        renderTabs();
        renderList();
        renderMap();
      });
    });
  });

  // 코스 확정
  $("#btnConfirm").click(() => {
    if (!confirm("이 코스를 확정하시겠습니까?")) return;
    const req = { planId, days };
    $.ajax({
      url: `/ai/courses/confirm`,
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify(req),
      success: () => {
        alert("코스가 확정되었습니다!");
        window.location.href = `/courses/view/edit?planId=${planId}`;
      },
      error: (xhr) => {
        console.error(xhr.responseText);
        alert("코스 확정 중 오류가 발생했습니다.");
      },
    });
  });
</script>
</body>
</html>
