<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/common/layout}"
      lang="ko">

<head>
    <th:block layout:fragment="head">
        <title>AI 코스 생성 | TRAVEL PLANNING</title>

        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script th:src="@{|https://dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoKey}&autoload=false|}"></script>

        <style>
            .back-nav-wrapper { margin-bottom: 15px; }
            .btn-back-nav { background: #e5e5e5; padding: 6px 12px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; transition: 0.2s; }
            .btn-back-nav:hover { background: #d0d0d0; }

            main { width: 1000px; margin: 40px auto; background: #fff; border-radius: 20px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
            .map-container { display: flex; background: #f3f3f3; border-radius: 20px; overflow: hidden; min-height: 500px; }
            #map { width: 65%; height: 500px; }
            .side-panel { width: 35%; background: #f9f9f9; padding: 10px; display: flex; flex-direction: column; }

            .day-tabs-wrapper { display: flex; align-items: center; gap: 5px; margin-bottom: 10px; }
            .tab-arrow { border: none; background: #e0e0e0; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 13px; }
            .tab-arrow:hover { background: #d0d0d0; }

            .tabs { display: flex; gap: 5px; overflow-x: auto; white-space: nowrap; flex: 1; scrollbar-width: none; }
            .tabs::-webkit-scrollbar { display: none; }

            .tabs button { padding: 6px 10px; border-radius: 8px; border: none; background: #ccc; cursor: pointer; }
            .tabs button.active { background: #000; color: #fff; }

            .place-list { flex: 1; overflow-y: auto; padding: 5px 10px; }
            .place-item { background: #fff; margin: 4px 0; border-radius: 10px; padding: 8px; font-size: 14px; }

            .btns { text-align: center; margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
            .btns button { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; }

            .btn-generate { background: #3182F6; color: #fff; }
            .btn-retry { background: #ccc; color: #333; }
            .btn-confirm { background: #000; color: #fff; }

            .btns button:disabled { opacity: 0.5; cursor: not-allowed; }

            .feedback-section { margin-top: 20px; padding: 15px; border-radius: 12px; background: #f5f5f5; }
            .feedback-section h3 { margin: 0 0 8px; font-size: 16px; }
            #feedbackInput { width: 100%; min-height: 80px; border-radius: 8px; border: 1px solid #ddd; padding: 8px; resize: vertical; box-sizing: border-box; font-size: 14px; }
            .feedback-actions { margin-top: 8px; text-align: right; }
        </style>
    </th:block>
</head>

<body>

<main layout:fragment="content">

    <div class="back-nav-wrapper">
        <button class="btn-back-nav" onclick="window.history.back()">← 이전 페이지</button>
    </div>

    <p style="margin-bottom: 15px; font-size: 14px;">
        선택한 여행 계획(planId:
        <span th:text="${planId}"></span>) 기준으로 AI가 일정을 자동 생성합니다.
    </p>

    <div class="map-container">
        <div id="map"></div>

        <div class="side-panel">
            <div class="day-tabs-wrapper">
                <button class="tab-arrow" id="tabLeftBtn">◀</button>
                <div class="tabs" id="dayTabs"></div>
                <button class="tab-arrow" id="tabRightBtn">▶</button>
            </div>

            <div class="place-list" id="placeList">
                <div style="text-align: center; margin-top: 30px; color: #888; font-size: 13px;">
                    아직 코스가 없습니다.<br/>
                    아래 "AI 코스 생성하기" 버튼을 눌러 주세요.
                </div>
            </div>
        </div>
    </div>

    <div class="btns">
        <button class="btn-generate" id="btnGenerate">AI 코스 생성하기</button>
        <button class="btn-retry" id="btnRetry" disabled>피드백 반영해서 다시 생성</button>
        <button class="btn-confirm" id="btnConfirm" disabled>코스 확정하기</button>
    </div>

    <div class="feedback-section">
        <h3>코스가 마음에 들지 않나요?</h3>
        <textarea id="feedbackInput" placeholder="피드백을 입력해 주세요."></textarea>
    </div>

</main>

<th:block layout:fragment="script">
    <script th:inline="javascript">

        const planId = [[${planId}]];

        let map;
        let markers = [];
        let polylines = [];

        let currentCourse = null;
        let itemsByDay = {};
        let maxDay = 0;
        let activeDay = 1;

        kakao.maps.load(() => {
            initMap();
            bindEvents();
        });

        function initMap() {
            map = new kakao.maps.Map(
                document.getElementById("map"),
                { center: new kakao.maps.LatLng(37.4979, 127.0276), level: 7 }
            );
        }

        function bindEvents() {
            $('#btnGenerate').on('click', async () => {
                try {
                    $('#btnGenerate').prop('disabled', true).text('생성 중...');

                    const res = await fetchWithRefresh(`/ai/courses/plan/${planId}`, {
                        method: 'POST'
                    });
                    const data = await res.json();

                    if (res.ok && data.data) {
                        currentCourse = data.data;
                        await buildItemsByDayFromAiCourse();
                        renderDayTabs();
                        renderCourseList();
                        renderMap();

                        $('#btnRetry').prop('disabled', false);
                        $('#btnConfirm').prop('disabled', false);
                        alert('AI 코스가 생성되었습니다.');
                    } else {
                        alert('AI 코스 생성에 실패했습니다.');
                    }
                } catch (e) {
                    console.error(e);
                    alert('AI 코스 생성 중 오류가 발생했습니다.');
                } finally {
                    $('#btnGenerate').prop('disabled', false).text('AI 코스 생성하기');
                }
            });

            $('#btnRetry').on('click', async () => {
                if (!currentCourse) return alert('먼저 AI 코스를 생성해 주세요.');

                const feedback = $('#feedbackInput').val();
                if (!feedback || !feedback.trim()) return alert('피드백을 입력해 주세요.');

                try {
                    $('#btnRetry').prop('disabled', true).text('재생성 중...');

                    const body = {
                        planId: planId,
                        feedback: feedback,
                        baseCourse: currentCourse
                    };

                    const res = await fetchWithRefresh('/ai/courses/feedback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    const data = await res.json();

                    if (res.ok && data.data) {
                        currentCourse = data.data;
                        await buildItemsByDayFromAiCourse();
                        renderDayTabs();
                        renderCourseList();
                        renderMap();

                        alert('피드백을 반영하여 코스를 다시 생성했습니다.');
                    } else {
                        alert('피드백 기반 코스 재생성에 실패했습니다.');
                    }

                } catch (e) {
                    console.error(e);
                    alert('코스 재생성 중 오류가 발생했습니다.');
                } finally {
                    $('#btnRetry').prop('disabled', false).text('피드백 반영해서 다시 생성');
                }
            });

            $('#btnConfirm').on('click', async () => {
                if (!currentCourse) return alert('먼저 AI 코스를 생성해 주세요.');

                if (!confirm('현재 보이는 AI 코스를 확정하시겠습니까?')) return;

                try {
                    $('#btnConfirm').prop('disabled', true).text('저장 중...');

                    const res = await fetchWithRefresh('/ai/courses/confirm', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(currentCourse)
                    });
                    const data = await res.json();

                    if (res.ok && data.data) {
                        alert('코스가 확정되어 저장되었습니다.');
                        location.href = `/courses/view/edit?planId=${currentCourse.planId}`;
                    } else {
                        alert('코스 확정 중 오류가 발생했습니다.');
                    }
                } catch (e) {
                    console.error(e);
                    alert('코스 확정 중 오류가 발생했습니다.');
                } finally {
                    $('#btnConfirm').prop('disabled', false).text('코스 확정하기');
                }
            });

            $('#tabLeftBtn').on('click', () => {
                const tabs = document.getElementById('dayTabs');
                tabs.scrollLeft -= 80;
            });
            $('#tabRightBtn').on('click', () => {
                const tabs = document.getElementById('dayTabs');
                tabs.scrollLeft += 80;
            });
        }

        async function buildItemsByDayFromAiCourse() {
            itemsByDay = {};
            maxDay = 0;
            activeDay = 1;

            if (!currentCourse || !currentCourse.days || currentCourse.days.length === 0) return;

            currentCourse.days.forEach(day => {
                const dayNo = day.dayNo;
                if (!itemsByDay[dayNo]) itemsByDay[dayNo] = [];
                if (day.items) itemsByDay[dayNo] = itemsByDay[dayNo].concat(day.items);
                if (dayNo > maxDay) maxDay = dayNo;
            });

            for (let d in itemsByDay) {
                itemsByDay[d].sort((a, b) => (a.orderNo || 0) - (b.orderNo || 0));
            }

            await enrichItems();
        }

        async function enrichItems() {
            const tasks = [];

            Object.keys(itemsByDay).forEach(dayNo => {
                itemsByDay[dayNo].forEach(item => {
                    const url = item.categoryCode === 'acc'
                        ? `/accommodations/detail?id=${item.placeId}`
                        : `/spots/detail?id=${item.placeId}`;

                    tasks.push(
                        fetchWithRefresh(url)
                            .then(res => res.json())
                            .then(res => {
                                if (res.data) {
                                    item.mapx = res.data.mapx;
                                    item.mapy = res.data.mapy;
                                    item.placeTitle = res.data.title || res.data.name || `ID: ${item.placeId}`;
                                }
                            })
                            .catch(err => console.error('상세 조회 실패:', err))
                    );
                });
            });

            await Promise.all(tasks);
        }

        function renderDayTabs() {
            const box = $('#dayTabs').empty();

            if (!currentCourse || !currentCourse.days || currentCourse.days.length === 0) return;

            for (let i = 1; i <= maxDay; i++) {
                const btn = $(`<button>${i}일차</button>`);
                if (i === activeDay) btn.addClass('active');

                btn.on('click', () => {
                    activeDay = i;
                    $('#dayTabs button').removeClass('active');
                    btn.addClass('active');
                    renderCourseList();
                    renderMap();
                });

                box.append(btn);
            }
        }

        function renderCourseList() {
            const list = $('#placeList').empty();

            const items = itemsByDay[activeDay] || [];
            if (!items.length) {
                list.append(`
                    <div style="text-align: center; margin-top: 30px; color: #888; font-size: 13px;">
                        해당 일차에 설정된 코스가 없습니다.
                    </div>
                `);
                return;
            }

            items.forEach((item, idx) => {
                const categoryLabel = item.categoryCode === 'acc' ? '[숙소]' : '[관광지]';
                list.append(`
                    <div class="place-item">
                        <b>${idx + 1}</b>. ${categoryLabel} ${item.placeTitle || '이름 없음'}
                    </div>
                `);
            });
        }

        function renderMap() {
            clearMap();

            const items = itemsByDay[activeDay] || [];
            if (!items.length) return;

            const bounds = new kakao.maps.LatLngBounds();
            const coords = [];

            items.forEach((item, idx) => {
                if (!item.mapy || !item.mapx) return;

                const pos = new kakao.maps.LatLng(parseFloat(item.mapy), parseFloat(item.mapx));
                coords.push(pos);
                bounds.extend(pos);

                const marker = new kakao.maps.Marker({
                    map,
                    position: pos,
                    title: `${idx + 1}. ${item.placeTitle || ''}`
                });
                markers.push(marker);
            });

            if (coords.length >= 2) {
                const polyline = new kakao.maps.Polyline({
                    map,
                    path: coords,
                    strokeWeight: 4,
                    strokeColor: '#3182F6',
                    strokeOpacity: 0.9
                });
                polylines.push(polyline);
            }

            if (!bounds.isEmpty()) {
                map.setBounds(bounds);
            }
        }

        function clearMap() {
            markers.forEach(m => m.setMap(null));
            polylines.forEach(p => p.setMap(null));
            markers = [];
            polylines = [];
        }

    </script>
</th:block>

</body>
</html>
