<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/common/layout}"
      lang="ko">

<head>
  <th:block layout:fragment="head">
    <meta charset="UTF-8">
    <title>계획 생성 | Travel Planning</title>

    <style>
      .back-nav-wrapper {
        margin-bottom: 15px;
        text-align: left;
      }

      .btn-back-nav {
        float: none !important;
        background: #e5e5e5;
        padding: 6px 12px;
        border-radius: 8px;
        margin: 0px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        transition: 0.2s;
      }

      .btn-back-nav:hover {
        background: #d0d0d0;
      }

      main {
        max-width: 600px;
        margin: 50px auto;
        padding: 30px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      }

      label {
        display: block;
        font-weight: bold;
        margin-top: 15px;
      }

      input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-top: 5px;
      }

      .btn-next {
        margin-top: 50px;
        float: right;
        background-color: #000000;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 10px;
        cursor: pointer;
      }

      .btn-next :hover {
        background-color: #2f2f2f;
      }

      .readonly {
        background-color: #f2f2f2;
      }
    </style>

  </th:block>
</head>

<body>

<main layout:fragment="content">

  <form id="planForm">

    <div class="back-nav-wrapper">
      <button class="btn-back-nav" onclick="window.history.back()">← 이전 페이지</button>
    </div>

    <label>1. 여행 제목을 입력해주세요</label>
    <input type="text" id="title" placeholder="예: 자유 여행" required>

    <label>2. 출발 위치</label>
    <input type="text" id="startLocation" class="readonly" readonly>
    <input type="hidden" id="tourSpotId">

    <label>3. 여행 기간을 선택해주세요</label>
    <div style="display:flex; gap:10px;">
      <input type="date" id="startDate" required>
      <input type="date" id="endDate" required>
    </div>

    <label>4. 인원수를 선택해주세요</label>
    <input type="number" id="numberOfPeople" min="1" required>

    <button class="btn-next" type="submit">다음 >></button>
  </form>

</main>

<th:block layout:fragment="script">
  <script>
    const tourSpotInput = document.getElementById("tourSpotId");
    const startLocationInput = document.getElementById("startLocation");

    const urlParams = new URLSearchParams(window.location.search);
    const tspId = urlParams.get('tspId');

    const defaultSpotId = tspId ? parseInt(tspId) : 11;
    let defaultSpotName = "강서역사문화거리";

    (async function loadSpotName() {
      if (!tspId) {
        tourSpotInput.value = defaultSpotId;
        startLocationInput.value = defaultSpotName;
        return;
      }

      try {
        const response = await fetchWithRefresh(`/spots/detail?id=${tspId}`);
        const result = await response.json();

        if (result?.data?.title) defaultSpotName = result.data.title;

        startLocationInput.value = defaultSpotName;

      } catch (err) {
        startLocationInput.value = defaultSpotName;
      }

      tourSpotInput.value = defaultSpotId;
    })();

    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");

    function validateDates() {
      const start = startDateInput.value;
      const end = endDateInput.value;

      if (start && end && start > end) {
        alert("종료일은 시작일 이후여야 합니다.");
        endDateInput.value = "";
        return false;
      }
      return true;
    }

    startDateInput.addEventListener("change", validateDates);
    endDateInput.addEventListener("change", validateDates);

    document.getElementById("planForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!validateDates()) return;

      const dto = {
        tourSpotId: parseInt(tourSpotInput.value),
        title: document.getElementById("title").value,
        numberOfPeople: parseInt(document.getElementById("numberOfPeople").value),
        startDate: startDateInput.value,
        endDate: endDateInput.value
      };

      try {
        const response = await fetchWithRefresh("/plans", {
          method: "POST",
          headers: { "Content-Type": "application/json;charset=utf-8" },
          body: JSON.stringify(dto)
        });

        const result = await response.json();

        if (response.ok) {
          alert(result.message);
          location.href = `/courses/view/choose?planId=${result.data}`;
        } else {
          alert("오류 발생: " + result.message);
        }
      } catch (err) {
        alert("서버 통신 오류가 발생했습니다.");
      }
    });

  </script>
</th:block>

</body>
</html>
