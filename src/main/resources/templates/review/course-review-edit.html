<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì½”ìŠ¤ ë¦¬ë·° ìˆ˜ì •</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Pretendard&display=swap">
    <style>
        /* ========================================= */
        /* ê¸°ë³¸ ë³€ìˆ˜ ë° ë¦¬ì…‹ */
        /* ========================================= */
        :root {
            --main-color: #7E57C2;      /* ë³´ë¼ìƒ‰ */
            --hover-color: #6A4CA5;     /* ì§™ì€ ë³´ë¼ìƒ‰ */
            --gray-bg: #F5F6F8;         /* ë°°ê²½ */
            --deep-text: #2C3E50;       /* ì§„í•œ í…ìŠ¤íŠ¸ */
            --light-border: #E0E0E0;    /* ì—°í•œ ê²½ê³„ì„  */
            --star-color: #FFC107;      /* ë³„ ìƒ‰ìƒ */
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background: var(--gray-bg); /* ë°°ê²½ìƒ‰ í†µì¼ */
            margin: 0;
            padding: 0;
        }

        /* ========================================= */
        /* HEADER ìŠ¤íƒ€ì¼ (mypage.html ê¸°ë°˜ìœ¼ë¡œ í†µí•©) */
        /* ========================================= */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: linear-gradient(135deg, var(--main-color) 0%, #B39DDB 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: white;
            padding: 5px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            object-fit: contain;
        }

        .title {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .welcome-text {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            padding: 5px 0;
            font-weight: 500;
        }

        .user-badge {
            font-weight: 700;
            font-size: 16px;
            color: white;
            margin-right: 5px;
        }

        .nav {
            display: flex;
            gap: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background-color: rgba(255, 255, 255, 0.15);
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* í˜„ì¬ í˜ì´ì§€ëŠ” 'ë‚´ ë¦¬ë·°'ì™€ ì—°ê´€ë˜ë¯€ë¡œ active ì²˜ë¦¬ */
        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
        }

        .nav-link.logout {
            background-color: rgba(231, 76, 60, 0.6);
        }

        .nav-link.logout:hover {
            background-color: rgba(231, 76, 60, 0.8);
        }

        .nav-icon {
            font-size: 16px;
        }


        /* ========================================= */
        /* ì½˜í…ì¸  ì˜ì—­ ë° í¼ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) */
        /* ========================================= */
        .content-wrapper {
            max-width: 1000px; !important;
            width: 1000px;
            margin: 40px auto;
            padding: 30px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        /* í¼ ìŠ¤íƒ€ì¼ */
        .form-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #EAEAEA;
            border-radius: 6px;
            background: #FDFDFF;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #4A4A4A;
        }

        input[type="text"], textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #DDD;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* ë³„ì  ìŠ¤íƒ€ì¼ */
        .star-rating {
            display: inline-block;
            font-size: 28px;
            cursor: pointer;
            color: #CCC; /* ê¸°ë³¸ ë³„ ìƒ‰ìƒ */
        }

        .star-rating span {
            margin-right: 2px;
            transition: color 0.2s;
        }

        .star-rating span.selected {
            color: var(--star-color); /* ì„ íƒëœ ë³„ ìƒ‰ìƒ */
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-submit {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 30px;
            background-color: var(--main-color); /* ë©”ì¸ ìƒ‰ìƒ */
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-submit:hover {
            background-color: var(--hover-color); /* í˜¸ë²„ ìƒ‰ìƒ */
        }

        .btn-submit:disabled {
            background-color: #BDBDBD;
            cursor: not-allowed;
        }

        /* ì´ë¯¸ì§€ ì—…ë¡œë“œ/ë¯¸ë¦¬ë³´ê¸° */
        .image-upload-area {
            border: 1px dashed #BDBDBD;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            margin-top: 10px;
        }

        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .image-wrapper {
            position: relative;
            width: 120px;
            height: 120px;
            border: 1px solid #E0E0E0;
            border-radius: 4px;
            overflow: hidden;
        }

        .image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-wrapper .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 18px;
            text-align: center;
            font-size: 14px;
            cursor: pointer;
            padding: 0;
        }

        .image-wrapper.deleted {
            opacity: 0.5;
            border: 1px dashed #E74C3C;
        }
        .image-wrapper.deleted .delete-btn {
            background: #E74C3C;
        }

        /* ìŠ¤íŒŸ ë¦¬ë·° ì„¹ì…˜ */
        .spot-review-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #EEE;
        }

        .spot-review-section h3 {
            color: var(--main-color);
            margin-bottom: 20px;
        }

        .spot-review-section .form-group {
            border: 1px solid #D1C4E9; /* ì—°í•œ ë³´ë¼ìƒ‰ í…Œë‘ë¦¬ */
            background: #F5F7FF; /* ì—°í•œ ë°°ê²½ìƒ‰ */
            margin-bottom: 15px;
        }

        .spot-review-section label {
            color: #6A4CA5;
        }

        .spot-review-section textarea {
            min-height: 50px;
        }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <img th:src="@{/images/logo.png}" alt="Logo" class="logo">
        <div class="title">TRAVEL PLANNING</div>
    </div>
    <div class="header-right">
        <div class="welcome-text" id="welcome-text">
            <span class="user-badge" id="display-username">íšŒì›</span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.
        </div>
        <nav class="nav">
            <a th:href="@{/spots/view/tourspotlist}" class="nav-link">
                <span class="nav-icon">ğŸ </span>
                <span>í™ˆ</span>
            </a>
            <a th:href="@{/member/view/mypage}" class="nav-link">
                <span class="nav-icon">ğŸ‘¤</span>
                <span>ë§ˆì´í˜ì´ì§€</span>
            </a>
            <a th:href="@{/reviews/view/search/my}" class="nav-link active">
                <span class="nav-icon">âœï¸</span>
                <span>ë‚´ ë¦¬ë·°</span>
            </a>
            <a href="javascript:void(0);" class="nav-link logout" onclick="handleLogout()">
                <span class="nav-icon">ğŸšª</span>
                <span>ë¡œê·¸ì•„ì›ƒ</span>
            </a>
        </nav>
    </div>
</header>
<div class="content-wrapper">
    <div id="review-form-container">
        <p style="text-align: center; color: #7E57C2; font-weight: 600;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div class="form-group" id="image-upload-area" style="display: none;">
        <label>ìƒˆë¡œìš´ ì´ë¯¸ì§€ ì¶”ê°€</label>
        <input type="file" id="newImages" name="newImages" multiple accept="image/*" onchange="previewNewImages(event)">
        <div class="image-preview-container" id="new-image-preview">
        </div>
        <p style="font-size: 12px; color: #888; margin-top: 5px;">* ìµœëŒ€ 5ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ê¸°ì¡´ ì´ë¯¸ì§€ í¬í•¨)</p>
    </div>

    <button type="button" class="btn-submit" onclick="submitReview(event)">ë¦¬ë·° ìˆ˜ì • ì™„ë£Œ</button>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/

    // âœ… [ìˆ˜ì •] í—¤ë” ì‚¬ìš©ì ì´ë¦„ ì„¤ì • (mypage.html êµ¬ì¡°ì— ë§ê²Œ textContent ì„¤ì •)
    const tempUsername = "ì—¬í–‰ì";
    const usernameElement = document.getElementById("display-username");
    // welcome-text ìì²´ê°€ íšŒì›ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤ë¥¼ í¬í•¨í•˜ê³  ìˆìœ¼ë¯€ë¡œ, usernameElementì—ëŠ” ì´ë¦„ë§Œ ë„£ìŠµë‹ˆë‹¤.
    if (usernameElement) {
        usernameElement.textContent = tempUsername;
    }

    // âœ… [ì¶”ê°€] ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜ (í—¤ë”ì˜ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì²˜ë¦¬ë¥¼ ìœ„í•¨)
    async function handleLogout() {
        try {
            const response = await fetch('/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include' // ì¿ í‚¤ í¬í•¨
            });

            if (response.ok) {
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/login';
            } else {
                const result = await response.json();
                alert(result.message || 'ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
            alert('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // Thymeleaf ë³€ìˆ˜ (planIdëŠ” ReviewFrontControllerì—ì„œ ëª¨ë¸ì— ì¶”ê°€ë¨)
    const planId = /*[[${planId}]]*/ null;

    // ë©”ì¸ ë¦¬ë·° IDë¥¼ ì €ì¥í•  ë³€ìˆ˜
    let mainReviewId = null;

    let initialReviewsData = null; // ì´ˆê¸° ë¡œë“œëœ ëª¨ë“  ë¦¬ë·° ë°ì´í„° (ìˆ˜ì •ìš©)
    let deletedImageUrls = []; // ì‚­ì œí•  ì´ë¯¸ì§€ URL ëª©ë¡ (ê¸°ì¡´ ì´ë¯¸ì§€)
    let newImageFiles = []; // ìƒˆë¡œ ì¶”ê°€ëœ ì´ë¯¸ì§€ íŒŒì¼ ê°ì²´ ëª©ë¡


    // --------------------------------------------------------------------------------
    // â­ ì´ˆê¸° ë°ì´í„° ë¡œë”© ë° í¼ ìƒì„±
    // --------------------------------------------------------------------------------

    /**
     * ì„œë²„ì—ì„œ Plan IDì— í•´ë‹¹í•˜ëŠ” ê¸°ì¡´ ë³µí•© ë¦¬ë·° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ í¼ì„ ì±„ì›ë‹ˆë‹¤.
     */
    async function loadReviewData() {
        const container = document.getElementById('review-form-container');
        // ë¡œë”© ë©”ì‹œì§€ ì„¤ì • (ì„±ê³µ ì‹œ renderReviewFormì—ì„œ êµì²´ë¨)
        container.innerHTML = `<p style="text-align: center; color: #7E57C2; font-weight: 600;" id="loading-status">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>`;

        try {
            // â­ API ê²½ë¡œ: /reviews/plan/{planId}/complex-edit
            const response = await fetch(`/reviews/plan/${planId}/complex-edit`, {
                method: "GET",
                credentials: "include"
            });

            const data = await response.json();

            if (!response.ok) {
                // ì„œë²„ì—ì„œ 403, 500 ë“±ì´ ë°œìƒí–ˆì„ ê²½ìš°
                const errorText = data.message || await response.text();
                console.error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ ìƒì„¸:", response.status, response.statusText, errorText);
                container.innerHTML = `
                    <p style="text-align:center;color:#e74c3c; font-weight: 600; margin-top: 20px;">
                        ğŸš¨ ë¦¬ë·° ë°ì´í„° ë¡œë”© ì‹¤íŒ¨! (HTTP ${response.status} ${response.statusText})
                    </p>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn-submit" style="width: 200px;" onclick="window.history.back()">ë’¤ë¡œ ê°€ê¸°</button>
                    </div>
                `;
                return;
            }

            initialReviewsData = data; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥

            // ë°ì´í„° êµ¬ì¡° í™•ì¸ ë° ë Œë”ë§
            if (data.mainReview && data.mainReview.reviewId) {
                mainReviewId = data.mainReview.reviewId;
                renderReviewForm(data); // í¼ ë Œë”ë§ ì‹œì‘
                // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜ì—­ í‘œì‹œ
                document.getElementById('image-upload-area').style.display = 'block';
            } else {
                container.innerHTML = `<p style="text-align:center;color:#e74c3c;">ìˆ˜ì •í•  ì½”ìŠ¤ ë¦¬ë·°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë°ì´í„° êµ¬ì¡° ì˜¤ë¥˜)</p>`;
            }

        } catch (error) {
            console.error("ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", error);
            // ë„¤íŠ¸ì›Œí¬/JSON íŒŒì‹± ì˜¤ë¥˜ ì²˜ë¦¬
            container.innerHTML = `
                <p style="text-align:center;color:#e74c3c; font-weight: 600; margin-top: 20px;">
                    âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” JSON íŒŒì‹± ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                </p>
            `;
        }
    }


    /**
     * ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¦¬ë·° ìˆ˜ì • í¼ì„ HTMLë¡œ ë Œë”ë§í•©ë‹ˆë‹¤. (í•µì‹¬ í•¨ìˆ˜)
     * @param {Object} data - ì„œë²„ì—ì„œ ë°›ì€ ë³µí•© ë¦¬ë·° ë°ì´í„°
     */
    function renderReviewForm(data) {
        const container = document.getElementById('review-form-container');
        const mainReview = data.mainReview;
        const spotReviews = data.spotReviews || [];
        const courseTitle = data.courseTitle || "ì „ì²´ ì½”ìŠ¤ ë¦¬ë·°";

        // 1. ë©”ì¸ ë¦¬ë·°(ì½”ìŠ¤ ë¦¬ë·°) í¼ ìƒì„±
        let mainReviewHtml = `
            <p style="color: #6A4CA5; font-weight: 600; margin-bottom: 20px;">ì½”ìŠ¤ ë¦¬ë·° ìˆ˜ì •</p>
            <form id="reviewForm" enctype="multipart/form-data">

                <input type="hidden" name="mainReview.reviewId" value="${mainReview.reviewId}">
                <input type="hidden" name="mainReview.planId" value="${planId}">
                <input type="hidden" name="mainReview.targetType" value="${mainReview.targetType}">
                <input type="hidden" name="mainReview.targetId" value="${mainReview.targetId}">

                <div class="form-group">
                    <label for="mainTitle">ë¦¬ë·° ì œëª©</label>
                    <input type="text" id="mainTitle" name="mainReview.title" value="${mainReview.title}" placeholder="ì „ì²´ ì½”ìŠ¤ì— ëŒ€í•œ ë¦¬ë·° ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”." required>
                </div>

                <div class="form-group">
                    <label for="mainContent">ë‚´ìš©</label>
                    <textarea id="mainContent" name="mainReview.content" placeholder="ì „ì²´ ì½”ìŠ¤ì— ëŒ€í•œ ìƒì„¸ ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.">${mainReview.content || ''}</textarea>
                </div>

                <div class="form-group">
                    <label>ë³„ì </label>
                    <div class="star-rating" id="mainRating" data-target="mainReview.rating" data-rating="${mainReview.rating}">
                        ${getStarSpans(mainReview.rating)}
                    </div>
                    <input type="hidden" id="mainReviewRatingValue" name="mainReview.rating" value="${mainReview.rating}">
                </div>
            </form>
        `;

        // 2. ê¸°ì¡´ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§ (ë©”ì¸ ë¦¬ë·°ë§Œ ì´ë¯¸ì§€ë¥¼ ê°€ì§‘ë‹ˆë‹¤.)
        if (mainReview.imageUrls && mainReview.imageUrls.length > 0) {
            mainReviewHtml += `
                <div class="form-group" id="existing-image-group">
                    <label>ê¸°ì¡´ ì´ë¯¸ì§€</label>
                    <div class="image-preview-container" id="existing-image-preview">
                        ${mainReview.imageUrls.map(url => renderExistingImage(url)).join('')}
                    </div>
                </div>
            `;
        } else {
            mainReviewHtml += `
                <div class="form-group" id="existing-image-group">
                    <label>ê¸°ì¡´ ì´ë¯¸ì§€</label>
                    <div class="image-preview-container" id="existing-image-preview">
                        <p style="color:#888;">ë“±ë¡ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            `;
        }


        // 3. ìŠ¤íŒŸ ë¦¬ë·° ì„¹ì…˜ ìƒì„±
        let spotReviewHtml = `
            <div class="spot-review-section">
                <h3>ê´€ê´‘ì§€ ë¦¬ë·° ìˆ˜ì •</h3>
                <div id="spot-review-list">
                    ${spotReviews.map(renderSpotReview).join('')}
                </div>
            </div>
        `;

        // ë¡œë”© ë©”ì‹œì§€ë¥¼ ìƒˆë¡œìš´ í¼ìœ¼ë¡œ êµì²´í•©ë‹ˆë‹¤.
        container.innerHTML = mainReviewHtml + spotReviewHtml;

        // 4. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.querySelectorAll('.star-rating').forEach(starContainer => {
            starContainer.addEventListener('click', handleStarRatingClick);
        });
    }

    /**
     * ê¸°ì¡´ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°ë¥¼ HTMLë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
     */
    function renderExistingImage(url) {
        // íŒŒì¼ ì´ë¦„ì€ URLì˜ ë§ˆì§€ë§‰ ë¶€ë¶„ìœ¼ë¡œ ê°€ì •
        const fileName = url.substring(url.lastIndexOf('/') + 1);
        return `
            <div class="image-wrapper" data-url="${url}">
                <img src="${url}" alt="${fileName}">
                <button type="button" class="delete-btn" onclick="deleteExistingImage('${url}')">Ã—</button>
            </div>
        `;
    }

    /**
     * ê°œë³„ ìŠ¤íŒŸ ë¦¬ë·° í¼ ìš”ì†Œë¥¼ HTMLë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
     */
    function renderSpotReview(spotDto, index) {
        // spotDto.placeTitle: ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ 'ë¦¬ë·° ì œëª©'ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. (editable titleì˜ ì´ˆê¸°ê°’)
        // ì´ ê°’ì„ ì‚¬ìš©ìì—ê²Œ 'ì¥ì†Œ ì´ë¦„'ìœ¼ë¡œ ë³´ì—¬ì£¼ê³ , editable title í•„ë“œì— ë„£ì–´ì¤ë‹ˆë‹¤.
        const placeNameForDisplay = spotDto.title;
        const initialReviewTitle = spotDto.title || '';

        const ratingId = `spotRating_${index}`;
        const prefix = `spotReviews[${index}]`;

        return `
            <div class="form-group spot-review-item" data-review-id="${spotDto.reviewId || 'new'}">
                <label style="font-size: 16px; color: var(--deep-text); margin-bottom: 15px;">
                    ğŸ“ **${placeNameForDisplay}**
                </label>

                <input type="hidden" form="reviewForm" name="${prefix}.reviewId" value="${spotDto.reviewId || ''}">
                <input type="hidden" form="reviewForm" name="${prefix}.targetType" value="${spotDto.targetType}">
                <input type="hidden" form="reviewForm" name="${prefix}.targetId" value="${spotDto.targetId}">
                <div class="form-group" style="border: none; padding: 0; margin-top: 15px;">
                    <label style="font-weight: normal;">ë¦¬ë·° ì œëª©</label>
                    <input type="text" form="reviewForm" name="${prefix}.placeTitle" value="${initialReviewTitle}"
                        placeholder="${placeNameForDisplay}ì— ëŒ€í•œ ë¦¬ë·° ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”." required>
                </div>

                <div class="form-group" style="border: none; padding: 0;">
                    <label style="font-weight: normal;">ë³„ì </label>
                    <div class="star-rating" id="${ratingId}" data-target="${prefix}.rating" data-rating="${spotDto.rating}">
                        ${getStarSpans(spotDto.rating)}
                    </div>
                    <input type="hidden" form="reviewForm" name="${prefix}.rating" value="${spotDto.rating}">
                </div>

                <div class="form-group" style="border: none; padding: 0;">
                    <label style="font-weight: normal;">ë¦¬ë·° ë‚´ìš©</label>
                    <textarea form="reviewForm" name="${prefix}.content" placeholder="${placeNameForDisplay}ì— ëŒ€í•œ ìƒì„¸ ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.">${spotDto.content || ''}</textarea>
                </div>
            </div>
        `;
    }

    /**
     * ë³„ì  ë Œë”ë§ìš© HTML ìƒì„±
     */
    function getStarSpans(rating) {
        let html = '';
        for (let i = 1; i <= 5; i++) {
            const isSelected = i <= rating ? 'selected' : '';
            html += `<span data-value="${i}" class="${isSelected}">â˜…</span>`;
        }
        return html;
    }


    /**
     * ë³„ì  í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
     */
    function handleStarRatingClick(event) {
        const span = event.target.closest('span');
        if (!span) return;

        const starContainer = event.currentTarget;
        const clickedValue = parseInt(span.dataset.value);
        const inputName = starContainer.dataset.target;

        // ë³„ì  ì—…ë°ì´íŠ¸ (ì‹œê°ì )
        starContainer.querySelectorAll('span').forEach(s => {
            const starValue = parseInt(s.dataset.value);
            s.classList.toggle('selected', starValue <= clickedValue);
        });

        // Hidden Input ê°’ ì—…ë°ì´íŠ¸ (ë°ì´í„° ì „ì†¡ìš©)
        document.querySelector(`input[form="reviewForm"][name="${inputName}"]`).value = clickedValue;
    }

    /**
     * ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ ì²˜ë¦¬ (DeletedImageUrls ëª©ë¡ì— ì¶”ê°€)
     */
    function deleteExistingImage(url) {
        const wrapper = document.querySelector(`.image-wrapper[data-url="${url}"]`);
        if (!wrapper) return;

        if (wrapper.classList.contains('deleted')) {
            // ì´ë¯¸ ì‚­ì œ ì˜ˆì •ì´ë©´ ì·¨ì†Œ
            wrapper.classList.remove('deleted');
            deletedImageUrls = deletedImageUrls.filter(u => u !== url);
            console.log("âœ… ì‚­ì œ ì·¨ì†Œ ì´ë¯¸ì§€:", url);
        } else {
            // ì‚­ì œ ì˜ˆì •ìœ¼ë¡œ í‘œì‹œ
            if (!confirm('ì´ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ìˆ˜ì • ì™„ë£Œ ì‹œ ì„œë²„ì—ì„œ ì™„ì „íˆ ì‚­ì œë©ë‹ˆë‹¤.')) {
                return;
            }
            wrapper.classList.add('deleted');

            // ì‚­ì œ ëª©ë¡ì— ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
            if (!deletedImageUrls.includes(url)) {
                deletedImageUrls.push(url);
                console.log("ğŸ—‘ï¸ ì‚­ì œ ì˜ˆì • ì´ë¯¸ì§€ ì¶”ê°€:", deletedImageUrls);
            }
        }
    }


    // --------------------------------------------------------------------------------
    // â­ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë° íŒŒì¼ ê´€ë¦¬
    // --------------------------------------------------------------------------------

    /**
     * ìƒˆë¡œìš´ ì´ë¯¸ì§€ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
     */
    function previewNewImages(event) {
        const files = Array.from(event.target.files);
        const previewContainer = document.getElementById('new-image-preview');
        previewContainer.innerHTML = '';
        newImageFiles = []; // ì´ˆê¸°í™”

        const existingImageCount = document.querySelectorAll('#existing-image-preview .image-wrapper:not(.deleted)').length;
        const totalMax = 5;
        const remainingSlots = totalMax - existingImageCount;
        let fileCount = 0;

        files.forEach((file, index) => {
            if (fileCount < remainingSlots) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'image-wrapper new-image';
                        wrapper.dataset.index = index; // ì¸ë±ìŠ¤ ì €ì¥ (ì‚­ì œ ì‹œ ì‚¬ìš©)
                        wrapper.innerHTML = `
                            <img src="${e.target.result}" alt="ìƒˆ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°">
                            <button type="button" class="delete-btn" onclick="deleteNewImage(${index}, this)">Ã—</button>
                        `;
                        previewContainer.appendChild(wrapper);
                        newImageFiles.push(file); // ì‹¤ì œ íŒŒì¼ ëª©ë¡ì— ì¶”ê°€
                    };
                    reader.readAsDataURL(file);
                    fileCount++;
                } else {
                    console.warn("ì´ë¯¸ì§€ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤:", file.name);
                }
            } else if (fileCount === remainingSlots) {
                alert(`ìµœëŒ€ ì´ë¯¸ì§€ ê°œìˆ˜(${totalMax}ì¥)ë¥¼ ì´ˆê³¼í•˜ì—¬ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ê¸°ì¡´ ì´ë¯¸ì§€ ${existingImageCount}ì¥ í¬í•¨)`);
                fileCount++; // ì´ˆê³¼ ì•Œë¦¼ì€ í•œ ë²ˆë§Œ ë„ìš°ê¸° ìœ„í•´ ì¹´ìš´íŠ¸ ì¦ê°€
            }
        });

        // íŒŒì¼ inputì˜ file listë¥¼ ì‹¤ì œ ì„ íƒëœ íŒŒì¼ ëª©ë¡ìœ¼ë¡œ ëŒ€ì²´ (ì—…ë¡œë“œ ì‹œ ì‚¬ìš©)
        // newImageFiles ë°°ì—´ì„ ê¸°ë°˜ìœ¼ë¡œ FileListë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, submit ì‹œ formDataì— ì§ì ‘ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.
        // ì—¬ê¸°ì„œëŠ” input ìš”ì†Œë¥¼ ë¹„ì›Œë‘ê³  newImageFilesë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        event.target.files = new DataTransfer().files;
    }

    /**
     * ìƒˆë¡œìš´ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì‚­ì œ
     */
    function deleteNewImage(index, button) {
        // newImageFiles ë°°ì—´ì—ì„œ íŒŒì¼ ì œê±°
        newImageFiles.splice(index, 1);

        // DOMì—ì„œ ë¯¸ë¦¬ë³´ê¸° ì œê±°
        const wrapper = button.closest('.image-wrapper');
        wrapper.remove();

        // ì¸ë±ìŠ¤ê°€ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ, ë‚¨ì€ ì´ë¯¸ì§€ë“¤ì˜ ì¸ë±ìŠ¤ ì¬ì„¤ì • (í•„ìš” ì‹œ)
        // ì—¬ê¸°ì„œëŠ” newImageFiles ë°°ì—´ì„ ê¸°ì¤€ìœ¼ë¡œ FormDataë¥¼ ìƒì„±í•  ê²ƒì´ë¯€ë¡œ, DOM ì¸ë±ìŠ¤ ì¬ì„¤ì •ì€ ìƒëµí•©ë‹ˆë‹¤.
        console.log("ğŸ—‘ï¸ ìƒˆ ì´ë¯¸ì§€ ì‚­ì œë¨. ë‚¨ì€ íŒŒì¼ ìˆ˜:", newImageFiles.length);
    }


    // --------------------------------------------------------------------------------
    // â­ í¼ ì œì¶œ (ë¦¬ë·° ìˆ˜ì •)
    // --------------------------------------------------------------------------------

    /**
     * ë¦¬ë·° ìˆ˜ì • í¼ ë°ì´í„°ë¥¼ ì„œë²„ë¡œ ì œì¶œí•©ë‹ˆë‹¤.
     */
    async function submitReview(event) {
        event.preventDefault();

        if (mainReviewId === null) {
            alert('ë¦¬ë·° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
            return;
        }

        const submitBtn = event.target;
        submitBtn.disabled = true;
        submitBtn.textContent = 'ìˆ˜ì • ì¤‘...';

        const form = document.getElementById('reviewForm');
        const formData = new FormData();

        // 1. DTO ê°ì²´ ìƒì„± (MainReviewDto + List<SpotReviewDto> + deletedImageUrls)
        const mainReview = {
            reviewId: form.elements['mainReview.reviewId'].value,
            planId: form.elements['mainReview.planId'].value,
            targetType: form.elements['mainReview.targetType'].value,
            targetId: form.elements['mainReview.targetId'].value,
            title: form.elements['mainReview.title'].value,
            content: form.elements['mainReview.content'].value,
            rating: parseInt(form.elements['mainReview.rating'].value)
        };

        const spotReviews = Array.from(document.querySelectorAll('.spot-review-item')).map((item, index) => {
            const prefix = `spotReviews[${index}]`;
            // placeTitle í•„ë“œì— 'ë¦¬ë·° ì œëª©' ì…ë ¥ ê°’ì´ ë°”ì¸ë”©ë©ë‹ˆë‹¤.
            return {
                reviewId: item.querySelector(`input[name="${prefix}.reviewId"]`).value || null,
                placeTitle: item.querySelector(`input[name="${prefix}.placeTitle"]`).value, // <-- ìˆ˜ì •ëœ ë¦¬ë·° ì œëª© ê°’
                targetType: item.querySelector(`input[name="${prefix}.targetType"]`).value,
                targetId: item.querySelector(`input[name="${prefix}.targetId"]`).value,
                rating: parseInt(item.querySelector(`input[name="${prefix}.rating"]`).value),
                content: item.querySelector(`textarea[name="${prefix}.content"]`).value
            };
        });

        const complexReqDto = {
            mainReview: mainReview,
            spotReviews: spotReviews,
            deletedImageUrls: deletedImageUrls
        };

        // 2. DTOë¥¼ JSONìœ¼ë¡œ ë³€í™˜í•˜ì—¬ FormDataì— 'dto' íŒŒíŠ¸ë¡œ ì¶”ê°€
        const dtoBlob = new Blob([JSON.stringify(complexReqDto)], { type: 'application/json' });
        formData.append('dto', dtoBlob);
        console.log("--- DTO Object Ready ---");
        console.log("JSON DTO:", complexReqDto);


        // 3. ìƒˆë¡œìš´ ì´ë¯¸ì§€ íŒŒì¼ë“¤ì„ 'newImages' íŒŒíŠ¸ë¡œ ì¶”ê°€
        if (newImageFiles.length > 0) {
            newImageFiles.forEach((file) => {
                formData.append('newImages', file, file.name);
            });
        }

        console.log("--- Final FormData Contents (For Debug) ---");
        for (const [key, value] of formData.entries()) {
            console.log(`${key}: ${value instanceof File ? value.name || '(Empty File)' : value}`);
        }
        console.log("--- Sending Request ---");

        try {
            // PUT ìš”ì²­ ê²½ë¡œ: '/reviews/{reviewId}' (ë©”ì¸ ë¦¬ë·° ID ì‚¬ìš©)
            const response = await fetch(`/reviews/${mainReviewId}`, {
                method: "PUT",
                body: formData,
                credentials: "include"
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ ìƒì„¸:", errorText);
                alert(`ë¦¬ë·° ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${response.status} ${response.statusText})\nìì„¸í•œ ë‚´ìš©ì€ ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                return;
            }

            alert("ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
            // ì„±ê³µ í›„ ìƒì„¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜ (planId ê¸°ì¤€)
            location.href = `/reviews/view/search/my`;

        } catch (err) {
            console.error("Fetch ìš”ì²­ ìì²´ì—ì„œ ì˜¤ë¥˜ ë°œìƒ:", err);
            alert("ìš”ì²­ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'ë¦¬ë·° ìˆ˜ì • ì™„ë£Œ';
        }
    }


    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¦¬ë·° ë°ì´í„° ë¡œë”© ì‹œì‘
    document.addEventListener('DOMContentLoaded', loadReviewData);

    /*]]>*/
</script>
</body>
</html>