<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/common/layout}"
      lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ÏΩîÏä§ Î¶¨Î∑∞ ÏàòÏ†ï</title>

    <!-- üî• Ïù¥ ÌéòÏù¥ÏßÄ Ï†ÑÏö© Ïä§ÌÉÄÏùº -->
    <th:block layout:fragment="head">
        <style>
            :root {
                --main-color: #7E57C2;
                --hover-color: #6A4CA5;
                --gray-bg: #F5F6F8;
                --deep-text: #2C3E50;
                --light-border: #E0E0E0;
                --star-color: #FFC107;
            }

            body {
                background: var(--gray-bg);
            }

            .content-wrapper {
                max-width: 1000px;
                margin: 40px auto;
                padding: 30px;
                background: #fff;
                border-radius: 10px;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            }

            .form-group {
                margin-bottom: 20px;
                padding: 15px;
                border: 1px solid #EAEAEA;
                border-radius: 6px;
                background: #FDFDFF;
            }

            .form-group label {
                display: block;
                font-weight: 600;
                margin-bottom: 8px;
                color: #4A4A4A;
            }

            input[type="text"],
            textarea {
                width: calc(100% - 20px);
                padding: 10px;
                border: 1px solid #DDD;
                border-radius: 4px;
                font-size: 14px;
                font-family: inherit;
                box-sizing: border-box;
            }

            textarea {
                min-height: 100px;
                resize: vertical;
            }

            .star-rating {
                display: inline-block;
                font-size: 28px;
                cursor: pointer;
                color: #CCC;
            }

            .star-rating span {
                margin-right: 2px;
                transition: color 0.2s;
            }

            .star-rating span.selected {
                color: var(--star-color);
            }

            .btn-submit,
            .btn-back {
                width: 48%;
                padding: 14px;
                font-size: 17px;
                font-weight: 700;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                margin-top: 30px;
            }

            .btn-submit {
                background: linear-gradient(45deg, var(--main-color), var(--hover-color));
                color: white;
            }

            .btn-submit:hover {
                opacity: .92;
            }

            .btn-back {
                background: #E0E0E0;
                color: var(--deep-text);
            }

            /* Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ */
            .image-preview-container {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-top: 10px;
            }

            .image-wrapper {
                position: relative;
                width: 120px;
                height: 120px;
                border-radius: 6px;
                border: 1px solid #DDD;
                overflow: hidden;
            }

            .image-wrapper img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .image-wrapper .delete-btn {
                position: absolute;
                top: 5px;
                right: 5px;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                border: none;
                background: rgba(0, 0, 0, 0.6);
                color: white;
                cursor: pointer;
                line-height: 19px;
                text-align: center;
            }

            .image-wrapper.deleted {
                opacity: 0.5;
                border: 1px dashed #E74C3C;
            }

            .spot-review-section {
                margin-top: 40px;
                padding-top: 20px;
                border-top: 2px solid #EEE;
            }

            .spot-review-section .form-group {
                background: #F7F5FF;
                border: 1px solid #D0C4FF;
            }

        </style>
    </th:block>
</head>

<body>

<main layout:fragment="content">

    <div class="content-wrapper">
        <div id="review-form-container">
            <p style="text-align:center;color:#7E57C2;font-weight:600;">
                Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...
            </p>
        </div>

        <!-- ÏÉàÎ°úÏö¥ Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú ÏòÅÏó≠ -->
        <div class="form-group" id="image-upload-area" style="display:none;">
            <label>ÏÉàÎ°úÏö¥ Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä</label>
            <input type="file" id="newImages" multiple accept="image/*" onchange="previewNewImages(event)">
            <div class="image-preview-container" id="new-image-preview"></div>
        </div>

        <div style="display:flex;gap:4%;justify-content:center;">
            <button type="button" class="btn-back" onclick="history.back()">Îí§Î°úÍ∞ÄÍ∏∞</button>
            <button type="button" class="btn-submit" onclick="submitReview(event)">Î¶¨Î∑∞ ÏàòÏ†ï ÏôÑÎ£å</button>
        </div>
    </div>

</main>

<!-- ========================================================= -->
<!-- üî• SCRIPT (Í≥µÌÜµ common.jsÎäî layout.htmlÏóêÏÑú ÏûêÎèô Ìè¨Ìï®Îê®) -->
<!-- ========================================================= -->
<th:block layout:fragment="script">
    <script th:inline="javascript">
        /* <![CDATA[ */

        const planId = /*[[${planId}]]*/ null;

        let mainReviewId = null;
        let deletedImageUrls = [];
        let newImageFiles = [];

        /* ------------------- Îç∞Ïù¥ÌÑ∞ Î°úÎìú ------------------- */
        async function loadReviewData() {
            const container = document.getElementById("review-form-container");

            try {
                const res = await fetch(`/reviews/plan/${planId}/complex-edit`, {credentials: "include"});
                const data = await res.json();

                if (!res.ok) {
                    container.innerHTML = `<p style="text-align:center;color:red;">Î¶¨Î∑∞ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.</p>`;
                    return;
                }

                mainReviewId = data.mainReview.reviewId;

                renderReviewForm(data);

                document.getElementById("image-upload-area").style.display = "block";

            } catch (err) {
                console.error(err);
                container.innerHTML = `<p style="text-align:center;color:red;">ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò</p>`;
            }
        }

        document.addEventListener("DOMContentLoaded", loadReviewData);


        /* ------------------- ÌôîÎ©¥ Î†åÎçîÎßÅ ------------------- */
        function renderReviewForm(data) {
            const container = document.getElementById("review-form-container");
            const main = data.mainReview;
            const spots = data.spotReviews || [];

            let html = `
        <h2 style="margin-bottom:15px;">ÏΩîÏä§ Î¶¨Î∑∞ ÏàòÏ†ï</h2>
        <p style="color:#6A4CA5;font-weight:600;margin-bottom:25px;">
            [ÏΩîÏä§: ${data.courseTitle}]
        </p>

        <form id="reviewForm">
            <input type="hidden" name="mainReview.reviewId" value="${main.reviewId}">
            <input type="hidden" name="mainReview.planId" value="${main.planId}">
            <input type="hidden" name="mainReview.targetId" value="${main.targetId}">
            <input type="hidden" name="mainReview.targetType" value="${main.targetType}">

            <div class="form-group">
                <label>Î¶¨Î∑∞ Ï†úÎ™©</label>
                <input type="text" name="mainReview.title" value="${main.title}">
            </div>

            <div class="form-group">
                <label>Î≥ÑÏ†ê</label>
                <div class="star-rating" data-target="mainReview.rating">
                    ${getStarSpans(main.rating)}
                </div>
                <input type="hidden" name="mainReview.rating" value="${main.rating}">
            </div>

            <div class="form-group">
                <label>ÎÇ¥Ïö©</label>
                <textarea name="mainReview.content">${main.content || ""}</textarea>
            </div>
        </form>
    `;

            /* Í∏∞Ï°¥ Ïù¥ÎØ∏ÏßÄ */
            if (main.imageUrls?.length) {
                html += `
        <div class="form-group">
            <label>Í∏∞Ï°¥ Ïù¥ÎØ∏ÏßÄ</label>
            <div class="image-preview-container" id="existing-image-preview">
                ${main.imageUrls.map(url => renderExistingImage(url)).join("")}
            </div>
        </div>`;
            }

            /* Ïä§Ìåü Î¶¨Î∑∞ ÏÑπÏÖò */
            html += `
        <div class="spot-review-section">
            <h3>Í¥ÄÍ¥ëÏßÄ Î¶¨Î∑∞ ÏàòÏ†ï</h3>
            ${spots.map((spot, i) => renderSpot(spot, i)).join("")}
        </div>
    `;

            container.innerHTML = html;

            /* Î≥ÑÏ†ê Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© */
            document.querySelectorAll(".star-rating").forEach(el => {
                el.addEventListener("click", handleStarClick);
            });
        }


        /* ------------------- HTML ÏÉùÏÑ± Ìï®Ïàò ------------------- */

        function getStarSpans(rating) {
            let html = "";
            for (let i = 1; i <= 5; i++) {
                html += `<span data-value="${i}" class="${i <= rating ? "selected" : ""}">‚òÖ</span>`;
            }
            return html;
        }

        function renderExistingImage(url) {
            return `
        <div class="image-wrapper" data-url="${url}">
            <img src="${url}">
            <button class="delete-btn" onclick="deleteExistingImage('${url}')">√ó</button>
        </div>`;
        }

        function renderSpot(spot, i) {
            const prefix = `spotReviews[${i}]`;
            return `
        <div class="form-group spot-review-item">
            <label>üìç ${spot.placeTitle}</label>

            <input type="hidden" name="${prefix}.reviewId" value="${spot.reviewId}">
            <input type="hidden" name="${prefix}.targetId" value="${spot.targetId}">
            <input type="hidden" name="${prefix}.targetType" value="${spot.targetType}">

            <div class="form-group" style="border: none; padding: 0;">
                <label>Î¶¨Î∑∞ Ï†úÎ™©</label>
                <input type="text" name="${prefix}.placeTitle" value="${spot.placeTitle}">
            </div>

            <div class="form-group" style="border: none; padding: 0;">
                <label>Î≥ÑÏ†ê</label>
                <div class="star-rating" data-target="${prefix}.rating">
                    ${getStarSpans(spot.rating)}
                </div>
                <input type="hidden" name="${prefix}.rating" value="${spot.rating}">
            </div>

            <div class="form-group" style="border: none; padding: 0;">
                <label>ÎÇ¥Ïö©</label>
                <textarea name="${prefix}.content">${spot.content || ""}</textarea>
            </div>
        </div>`;
        }


        /* ------------------- Î≥ÑÏ†ê ÌÅ¥Î¶≠ ------------------- */
        function handleStarClick(e) {
            const span = e.target.closest("span");
            if (!span) return;

            const wrap = e.currentTarget;
            const value = parseInt(span.dataset.value);
            const inputName = wrap.dataset.target;

            wrap.querySelectorAll("span").forEach(s => {
                s.classList.toggle("selected", parseInt(s.dataset.value) <= value);
            });

            document.querySelector(`input[name="${inputName}"]`).value = value;
        }


        /* ------------------- Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú ------------------- */
        function deleteExistingImage(url) {
            const wrapper = document.querySelector(`.image-wrapper[data-url="${url}"]`);
            wrapper.classList.toggle("deleted");

            if (wrapper.classList.contains("deleted")) {
                deletedImageUrls.push(url);
            } else {
                deletedImageUrls = deletedImageUrls.filter(u => u !== url);
            }
        }


        /* ------------------- ÏÉà Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ ------------------- */
        function previewNewImages(e) {
            const files = Array.from(e.target.files);
            const preview = document.getElementById("new-image-preview");

            preview.innerHTML = "";
            newImageFiles = [];

            files.forEach(f => {
                if (!f.type.startsWith("image/")) return;

                const reader = new FileReader();
                reader.onload = ev => {
                    preview.innerHTML += `
                <div class="image-wrapper">
                    <img src="${ev.target.result}">
                    <button class="delete-btn" onclick="removeNewImage('${f.name}', this)">√ó</button>
                </div>`;
                };
                reader.readAsDataURL(f);
                newImageFiles.push(f);
            });
        }

        function removeNewImage(name, btn) {
            newImageFiles = newImageFiles.filter(f => f.name !== name);
            btn.parentElement.remove();
        }


        /* ------------------- ÏµúÏ¢Ö Ï†úÏ∂ú ------------------- */
        async function submitReview(ev) {
            ev.preventDefault();

            const form = document.getElementById("reviewForm");
            const formData = new FormData();

            /* DTO ÏÉùÏÑ± */
            const mainReview = {
                reviewId: form["mainReview.reviewId"].value,
                planId: form["mainReview.planId"].value,
                targetType: form["mainReview.targetType"].value,
                targetId: form["mainReview.targetId"].value,
                title: form["mainReview.title"].value,
                content: form["mainReview.content"].value,
                rating: parseInt(form["mainReview.rating"].value)
            };

            const spotDtoList = Array.from(document.querySelectorAll(".spot-review-item")).map((item, idx) => {
                const prefix = `spotReviews[${idx}]`;

                return {
                    reviewId: item.querySelector(`input[name="${prefix}.reviewId"]`).value,
                    placeTitle: item.querySelector(`input[name="${prefix}.placeTitle"]`).value,
                    targetType: item.querySelector(`input[name="${prefix}.targetType"]`).value,
                    targetId: item.querySelector(`input[name="${prefix}.targetId"]`).value,
                    rating: parseInt(item.querySelector(`input[name="${prefix}.rating"]`).value),
                    content: item.querySelector(`textarea[name="${prefix}.content"]`).value
                };
            });

            const dto = {
                mainReview: mainReview,
                spotReviews: spotDtoList,
                deletedImageUrls: deletedImageUrls
            };

            formData.append("dto", new Blob([JSON.stringify(dto)], {type: "application/json"}));

            newImageFiles.forEach(f => {
                formData.append("newImages", f);
            });

            /* ÏÑúÎ≤Ñ ÏöîÏ≤≠ */
            try {
                const res = await fetch(`/reviews/${mainReviewId}`, {
                    method: "PUT",
                    body: formData,
                    credentials: "include"
                });

                if (!res.ok) {
                    alert("Î¶¨Î∑∞ ÏàòÏ†ï Ïã§Ìå®");
                    return;
                }

                alert("Î¶¨Î∑∞ ÏàòÏ†ïÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!");
                location.href = "/reviews/view/search/my";

            } catch (err) {
                console.error(err);
                alert("ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò");
            }
        }

        /* ]]> */
    </script>
</th:block>

</body>
</html>
