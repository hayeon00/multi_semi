<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" th:href="@{/css/mypage.css}">
    <title>내가 쓴 리뷰</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Pretendard&display=swap">
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background: #F4F6FA;
            margin: 0;
            padding: 0;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            padding: 15px 40px;
            border-bottom: 1px solid #E0E0E0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .page-header h1 {
            font-size: 20px;
            margin: 0;
            color: #2C3E50;
            font-weight: 700;
        }

        .page-header nav a {
            margin-left: 15px;
            color: #555;
            text-decoration: none;
            font-weight: 500;
        }

        .content-wrapper {
            max-width: 1000px; !important;
            width: 1000px; !important;
            margin: 40px auto;
            background: #fff;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        h2 {
            margin-bottom: 30px;
            font-size: 26px;
            color: #2C3E50;
            font-weight: 700;
        }

        .no-content {
            text-align: center;
            color: #999;
            padding: 40px 0;
        }

        .plan-card {
            display: flex; /* 리뷰 내용과 액션 버튼을 가로로 배치 */
            justify-content: space-between; /* 양쪽 끝으로 분리 */
            align-items: flex-start; /* 상단 정렬 */
            padding: 20px;
            border: 1px solid #E0E0E0;
            border-radius: 12px;
            margin-bottom: 15px;
            background: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); /* 은은한 그림자 추가 */
        }

        .plan-group {
            background: #F9F9F9;
            border: 1px solid #eee;
            border-radius: 14px;
            margin-bottom: 25px;
            overflow: hidden;
        }

        .plan-header {
            background: #F1F3F5;
            padding: 20px 25px;
        }

        .plan-header-top {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 600px;
        }

        .plan-header h3 {
            margin: 0;
            font-size: 20px;
            color: #2C3E50;
        }

        .plan-header p {
            margin: 5px 0 0 0;
            color: #555;
            font-size: 15px;
        }

        /* ==================================== */
        /* ✅ 버튼 크기/위치(간격) 수정 부분 */
        /* ==================================== */
        .plan-btn-group {
            display: flex;
            gap: 8px; /* 간격 살짝 줄임 */
            align-items: center;
        }

        .plan-btn-group button {
            padding: 6px 12px; /* 버튼 크기/높이 조정 (8px 14px -> 6px 12px) */
            min-width: 70px; /* 최소 너비 지정 */
            border: none;
            border-radius: 6px; /* 모서리 조정 (8px -> 6px) */
            color: white;
            font-size: 13px; /* 폰트 크기 조정 (14px -> 13px) */
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* 그림자 추가 */
        }
        /* ==================================== */
        /* ✅ 버튼 크기/위치(간격) 수정 끝 */
        /* ==================================== */

        .btn-edit {
            background: #5D87FF;
        }
        .btn-delete {
            background: #FF6B6B;
        }

        .btn-edit:hover {
            background: #4A89DC; /* 색상 미세 조정 */
        }

        .btn-delete:hover {
            background: #E9573F; /* 색상 미세 조정 */
        }

        .review-list-container {
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .review-card {
            background: #fff;
            border: 1px solid #E0E0E0;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            gap: 20px;
            cursor: default;
            transition: none;
        }

        .review-card:hover {
            box-shadow:none;
        }

        .review-card img.review-image {
            width: 150px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .review-card .review-content {
            flex-grow: 1;
        }

        .review-card h4 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: #333;
        }

        .review-card p {
            margin: 5px 0;
            color: #555;
            font-size: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .review-card .rating {
            color: #F39C12;
            font-weight: 600;
            font-size: 16px;
        }
    </style>
</head>

<body>

<div class="page-header">
    <img th:src="@{/images/logo.png}" alt="Logo" class="logo">
    <h1>TRAVEL PLANNING</h1>
    <nav>
        <a th:href="@{/}">Home</a>
        <a th:href="@{/member/view/mypage}">마이페이지</a>
        <a th:href="@{/logout}">로그아웃</a>
    </nav>
</div>

<div class="content-wrapper">
    <h2>내가 쓴 리뷰</h2>
    <div id="planReviewList">
        <p class="no-content">작성한 여행 계획을 불러오는 중입니다...</p>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        loadPlansAndReviews();
    });

    async function loadPlansAndReviews() {
        const listContainer = document.getElementById("planReviewList");
        try {
            const planResponse = await fetch('/plans', { credentials: 'include' });
            if (!planResponse.ok) throw new Error("여행 계획 로딩 실패");
            const planResDto = await planResponse.json();
            const plans = planResDto.data;

            if (!plans || plans.length === 0) {
                listContainer.innerHTML = `<div class="no-content">작성한 여행 계획이 없습니다.</div>`;
                return;
            }

            listContainer.innerHTML = "";

            for (const plan of plans) {
                const planGroup = document.createElement("div");
                planGroup.className = "plan-group";

                const planHeader = document.createElement("div");
                planHeader.className = "plan-header";
                planHeader.innerHTML = `
          <div class="plan-header-top">
            <div>
              <h3>${plan.title}</h3>
              <p>${plan.startDate} ~ ${plan.endDate}</p>
            </div>
            <div class="plan-btn-group">
              <button class="btn-edit" onclick="editPlan(${plan.id})">수정</button>
              <button class="btn-delete" onclick="deletePlan(${plan.id})">계획삭제</button>
            </div>
          </div>
        `;

                const reviewContainer = document.createElement("div");
                reviewContainer.className = "review-list-container";
                reviewContainer.id = `reviews-for-plan-${plan.id}`;
                reviewContainer.innerHTML = `<p style="color: #888;">리뷰를 불러오는 중...</p>`;

                planGroup.appendChild(planHeader);
                planGroup.appendChild(reviewContainer);
                listContainer.appendChild(planGroup);

                loadReviewsForPlan(plan.id, reviewContainer.id);
            }
        } catch (e) {
            console.error("로딩 실패:", e);
            listContainer.innerHTML = `<div class="no-content">리뷰를 불러오는 중 오류가 발생했습니다.</div>`;
        }
    }

    async function loadReviewsForPlan(planId, containerId) {
        const container = document.getElementById(containerId);

        try {
            const targetResponse = await fetch(`/reviews/course?planId=${planId}`, { credentials: 'include' });
            if (!targetResponse.ok) {
                container.innerHTML = `<p style="color: #888;">이 계획에는 코스가 없거나 리뷰 대상이 아닙니다.</p>`;
                return;
            }

            const targetDto = await targetResponse.json();
            const courseId = targetDto.targetId;
            const courseType = targetDto.type;

            const reviewResponse = await fetch(`/reviews/target?type=${courseType}&id=${courseId}`, {
                credentials: 'include'
            });

            if (!reviewResponse.ok) throw new Error("리뷰 로딩 실패");
            const reviewPage = await reviewResponse.json();
            const reviews = reviewPage.content;

            if (!reviews || reviews.length === 0) {
                container.innerHTML = `<p style="color: #888;">이 코스에 대한 리뷰가 없습니다.</p>`;
                return;
            }

            container.innerHTML = "";

            reviews.forEach(r => {
                const div = document.createElement("div");
                div.className = "review-card";
                //div.onclick = () => location.href = `/reviews/view/detail?planId=${planId}`;

                const imageTag = (r.imageUrls && r.imageUrls.length > 0)
                    ? `<img class="review-image" src="${r.imageUrls[0]}" alt="리뷰 이미지">`
                    : `<img class="review-image" src="/images/default-thumbnail.png" alt="기본 이미지">`;

                div.innerHTML = `
          ${imageTag}
          <div class="review-content">
            <h4>${r.title}</h4>
            <p class="rating">★ ${r.rating}</p>
            <p>${r.content}</p>
          </div>
        `;
                container.appendChild(div);
            });

        } catch (e) {
            console.error(`Plan ${planId} 리뷰 로딩 실패:`, e);
            container.innerHTML = `<p style="color: #E74C3C;">리뷰를 불러오는 중 오류가 발생했습니다.</p>`;
        }
    }

    function editPlan(planId) {
        location.href = `/reviews/view/edit?planId=${planId}`;
    }

    async function deletePlan(planId) {
        if (!confirm("이 여행 계획과 관련된 모든 리뷰가 함께 삭제됩니다. 정말 삭제하시겠습니까?\"")) return;
        try {
            const res = await fetch(`/plans/${planId}`, { method: "DELETE", credentials: "include" });
            if (!res.ok) throw new Error("삭제 실패");
            alert("삭제되었습니다.");
            loadPlansAndReviews();
        } catch (e) {
            alert("삭제 중 오류 발생");
            console.error(e);
        }
    }
</script>
</body>
</html>