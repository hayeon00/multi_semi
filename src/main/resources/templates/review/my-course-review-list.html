<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" th:href="@{/css/mypage.css}">
    <script th:src="@{/js/common.js}"></script>
    <title>ë‚´ê°€ ì“´ ë¦¬ë·°</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Pretendard&display=swap">
    <style>
        /* ========================================= */
        /* ê¸°ë³¸ ë³€ìˆ˜ ë° ë¦¬ì…‹ */
        /* ========================================= */
        :root {
            --main-color: #7E57C2;      /* ë³´ë¼ìƒ‰ */
            --hover-color: #6A4CA5;     /* ì§™ì€ ë³´ë¼ìƒ‰ */
            --gray-bg: #F5F6F8;         /* ë°°ê²½ */
            --deep-text: #2C3E50;       /* ì§„í•œ í…ìŠ¤íŠ¸ */
            --light-border: #E0E0E0;    /* ì—°í•œ ê²½ê³„ì„  */
            --star-color: #FFC107;      /* ë³„ ìƒ‰ìƒ */
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background: var(--gray-bg); /* ë°°ê²½ìƒ‰ í†µì¼ */
            margin: 0;
            padding: 0;
        }

        /* ========================================= */
        /* HEADER ìŠ¤íƒ€ì¼ (ë¦¬ë·° ë“±ë¡ í˜ì´ì§€ì™€ ë™ì¼) */
        /* ========================================= */
        .header {
            background: linear-gradient(135deg, var(--main-color) 0%, #B39DDB 100%);
            width: 100%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 15px 0;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-left .logo {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: white;
            padding: 5px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            object-fit: cover;
        }

        .header-left .title {
            font-size: 24px;
            font-weight: 700;
            color: white;
            letter-spacing: 0.5px;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .user-info {
            padding: 5px 0;
        }

        .welcome-text {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        .username {
            font-weight: 700;
            font-size: 16px;
            color: white;
            margin-right: 5px;
        }

        .nav {
            display: flex;
            gap: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background-color: rgba(255, 255, 255, 0.15);
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
        }

        .nav-link.logout {
            background-color: rgba(231, 76, 60, 0.6);
        }

        .nav-link.logout:hover {
            background-color: rgba(231, 76, 60, 0.8);
        }

        .nav-icon {
            font-size: 16px;
        }

        /* ========================================= */
        /* ì½˜í…ì¸  ì˜ì—­ ìŠ¤íƒ€ì¼ */
        /* ========================================= */

        .content-wrapper {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        h2 {
            font-size: 28px;
            font-weight: 800;
            color: var(--deep-text);
            text-align: center;
            padding-bottom: 10px;
            margin-bottom: 30px;
            border-bottom: 3px solid var(--main-color);
            display: block;
        }

        /* ì—¬í–‰ ê³„íš ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
        .plan-group {
            margin-bottom: 30px;
            padding: 20px;
            background: #FFFFFF;
            border: 1px solid var(--light-border);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .plan-header {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #EEE;
        }

        .plan-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* ë²„íŠ¼ì„ ìœ„ìª½ì— ë°°ì¹˜ */
        }

        .plan-header h3 {
            font-size: 22px;
            font-weight: 700;
            color: var(--deep-text);
            margin: 0 0 5px 0;
        }

        .plan-header p {
            font-size: 14px;
            color: #777;
            margin: 0;
        }

        .plan-btn-group {
            display: flex;
            gap: 10px;
        }

        /* âœ… ìˆ˜ì • ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°œì„  ë° ë³€ê²½ */
        .btn-edit {
            padding: 8px 18px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;

            /* ë””ìì¸ ì ìš© */
            background-color: var(--main-color);
            color: white;
            box-shadow: 0 2px 5px rgba(126, 87, 194, 0.2);
        }

        .btn-edit:hover {
            background-color: var(--hover-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(126, 87, 194, 0.3);
        }
        /* -- ë²„íŠ¼ ë””ìì¸ ë -- */


        /* ë¦¬ë·° ëª©ë¡ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
        .review-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            padding-top: 10px;
        }

        .review-card {
            background: #FAFAFA;
            border: 1px solid var(--light-border);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .review-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(126, 87, 194, 0.15);
        }

        .review-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
        }

        .review-content {
            padding: 15px;
        }

        .review-content h4 {
            font-size: 18px;
            font-weight: 700;
            color: var(--main-color);
            margin-top: 0;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .review-content .rating {
            font-size: 16px;
            font-weight: 600;
            color: var(--star-color);
            margin-bottom: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            font-size: 18px;
            color: #777;
        }

    </style>
</head>

<body>

<header class="header">
    <div class="header-container">
        <div class="header-left">
            <img th:src="@{/images/logo.png}" alt="Logo" class="logo">
            <div class="title">TRAVEL PLANNING</div>
        </div>

        <div class="header-right">
            <div class="user-info">
                <span class="welcome-text" id="welcome-text">
                    <span class="username" id="display-username">íšŒì›</span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.
                </span>
            </div>

            <nav class="nav">
                <a th:href="@{/spots/view/tourspotlist}" class="nav-link">
                    <span class="nav-icon">ğŸ </span>
                    <span>í™ˆ</span>
                </a>
                <a th:href="@{/member/view/mypage}" class="nav-link">
                    <span class="nav-icon">ğŸ‘¤</span>
                    <span>ë§ˆì´í˜ì´ì§€</span>
                </a>
                <a th:href="@{/reviews/view/search/my}" class="nav-link active">
                    <span class="nav-icon">âœï¸</span>
                    <span>ë‚´ ë¦¬ë·°</span>
                </a>
                <a href="javascript:void(0);" class="nav-link logout" onclick="handleLogout()">
                    <span class="nav-icon">ğŸšª</span>
                    <span>ë¡œê·¸ì•„ì›ƒ</span>
                </a>
            </nav>
        </div>
    </div>
</header>

<div class="content-wrapper">
    <h2>ë‚´ê°€ ì“´ ë¦¬ë·°</h2>
    <div id="planReviewList">
        <p class="no-content">ì‘ì„±í•œ ì—¬í–‰ ê³„íšì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>
</div>

<script>
    // ì„ì‹œ ì‚¬ìš©ì ì´ë¦„ ì„¤ì •
    const tempUsername = "ì—¬í–‰ì";
    const usernameElement = document.getElementById("display-username");
    if (usernameElement) {
        usernameElement.textContent = tempUsername;
    }

    // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
    async function handleLogout() {
        try {
            const response = await fetch('/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (response.ok) {
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/login';
            } else {
                const result = await response.json();
                alert(result.message || 'ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
            alert('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        loadPlansAndReviews();
    });

    async function loadPlansAndReviews() {
        const listContainer = document.getElementById("planReviewList");
        try {
            const planResponse = await fetch('/plans', { credentials: 'include' });
            if (!planResponse.ok) throw new Error("ì—¬í–‰ ê³„íš ë¡œë”© ì‹¤íŒ¨");
            const planResDto = await planResponse.json();
            const plans = planResDto.data;

            if (!plans || plans.length === 0) {
                listContainer.innerHTML = `<div class="no-content">ì‘ì„±í•œ ì—¬í–‰ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            listContainer.innerHTML = "";

            for (const plan of plans) {
                const planGroup = document.createElement("div");
                planGroup.className = "plan-group";

                const planHeader = document.createElement("div");
                planHeader.className = "plan-header";

                // âœ… 'ê³„íšì‚­ì œ' ë²„íŠ¼ ì œê±° ë° 'ìˆ˜ì •' ë²„íŠ¼ë§Œ ìœ ì§€
                planHeader.innerHTML = `
          <div class="plan-header-top">
            <div>
              <h3>${plan.title}</h3>
              <p>${plan.startDate} ~ ${plan.endDate}</p>
            </div>
            <div class="plan-btn-group">
              <button class="btn-edit" onclick="editPlan(${plan.id})">ë¦¬ë·° ìˆ˜ì •</button>
            </div>
          </div>
        `;

                const reviewContainer = document.createElement("div");
                reviewContainer.className = "review-list-container";
                reviewContainer.id = `reviews-for-plan-${plan.id}`;
                reviewContainer.innerHTML = `<p style="color: #888;">ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;

                planGroup.appendChild(planHeader);
                planGroup.appendChild(reviewContainer);
                listContainer.appendChild(planGroup);

                loadReviewsForPlan(plan.id, reviewContainer.id);
            }
        } catch (e) {
            console.error("ë¡œë”© ì‹¤íŒ¨:", e);
            listContainer.innerHTML = `<div class="no-content">ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
        }
    }

    async function loadReviewsForPlan(planId, containerId) {
        const container = document.getElementById(containerId);

        try {
            const targetResponse = await fetch(`/reviews/course?planId=${planId}`, { credentials: 'include' });
            if (!targetResponse.ok) {
                container.innerHTML = `<p style="color: #888;">ì´ ê³„íšì—ëŠ” ì½”ìŠ¤ê°€ ì—†ê±°ë‚˜ ë¦¬ë·° ëŒ€ìƒì´ ì•„ë‹™ë‹ˆë‹¤.</p>`;
                return;
            }

            const targetDto = await targetResponse.json();
            const courseId = targetDto.targetId;
            const courseType = targetDto.type;

            const reviewResponse = await fetch(`/reviews/target?type=${courseType}&id=${courseId}`, {
                credentials: 'include'
            });

            if (!reviewResponse.ok) throw new Error("ë¦¬ë·° ë¡œë”© ì‹¤íŒ¨");
            const reviewPage = await reviewResponse.json();
            const reviews = reviewPage.content;

            if (!reviews || reviews.length === 0) {
                container.innerHTML = `<p style="color: #888;">ì´ ì½”ìŠ¤ì— ëŒ€í•œ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }

            container.innerHTML = "";

            reviews.forEach(r => {
                const div = document.createElement("div");
                div.className = "review-card";

                const imageTag = (r.imageUrls && r.imageUrls.length > 0)
                    ? `<img class="review-image" src="${r.imageUrls[0]}" alt="ë¦¬ë·° ì´ë¯¸ì§€">`
                    : `<img class="review-image" src="/images/default-thumbnail.png" alt="ê¸°ë³¸ ì´ë¯¸ì§€">`;

                div.innerHTML = `
          ${imageTag}
          <div class="review-content">
            <h4>${r.title}</h4>
            <p class="rating">â˜… ${r.rating}</p>
            <p>${r.content}</p>
          </div>
        `;
                container.appendChild(div);
            });

        } catch (e) {
            console.error(`Plan ${planId} ë¦¬ë·° ë¡œë”© ì‹¤íŒ¨:`, e);
            container.innerHTML = `<p style="color: #E74C3C;">ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
        }
    }

    function editPlan(planId) {
        safeRedirect(`/reviews/view/edit?planId=${planId}`)
    }

    // deletePlan í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•Šì§€ë§Œ, ë§Œì•½ì„ ìœ„í•´ ì£¼ì„ ì²˜ë¦¬í•˜ì§€ ì•Šê³  ìœ ì§€í•©ë‹ˆë‹¤.
    async function deletePlan(planId) {
        if (!confirm("ì´ ì—¬í–‰ ê³„íšê³¼ ê´€ë ¨ëœ ëª¨ë“  ë¦¬ë·°ê°€ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
            const res = await fetch(`/plans/${planId}`, { method: "DELETE", credentials: "include" });
            if (!res.ok) throw new Error("ì‚­ì œ ì‹¤íŒ¨");
            alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            // loadPlansAndReviews();
            safeRedirect('/reviews/view/search/my')
        } catch (e) {
            alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
            console.error(e);
        }
    }
</script>
</body>
</html>