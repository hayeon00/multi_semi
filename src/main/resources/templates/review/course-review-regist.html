<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>코스 리뷰 작성</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Pretendard&display=swap">
    <style>
        /* (기존 CSS 생략) */
        body {
            font-family: 'Pretendard', sans-serif;
            background: #F4F6FA;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        h1 {
            font-size: 24px;
            color: #2C3E50;
            font-weight: 700;
        }
        h2 {
            font-size: 20px;
            color: #34495E;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .review-container {
            width: 100%;
            max-width: 700px;
            background: #FFFFFF;
            border-radius: 14px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        #reviewForm label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 15px;
        }
        #reviewForm input[type="text"],
        #reviewForm textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #DCDDE1;
            background: #FAFAFA;
            transition: .2s;
            font-size: 15px;
            box-sizing: border-box;
        }
        #reviewForm input[type="file"] {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #DCDDE1;
            border-radius: 8px;
            box-sizing: border-box;
            background: #FAFAFA;
            cursor: pointer;
            margin-bottom: 20px;
        }
        #reviewForm textarea {
            height: 120px;
            resize: none;
        }
        #reviewForm input:focus, #reviewForm textarea:focus {
            border-color: #3498DB;
            background: #fff;
            outline: none;
        }
        button[type="submit"] {
            width: 100%;
            padding: 14px;
            background: #3498DB;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: .2s;
        }
        button[type="submit"]:hover {
            background: #2980B9;
        }
        .rating-stars {
            display: inline-block;
            direction: rtl;
            margin-bottom: 15px;
        }
        .rating-stars input[type="radio"] { display: none; }
        .rating-stars label {
            font-size: 28px;
            color: #E0E0E0;
            cursor: pointer;
            padding: 0 2px;
            transition: color 0.2s;
            display: inline-block;
        }
        .rating-stars label:hover,
        .rating-stars label:hover ~ label,
        .rating-stars input[type="radio"]:checked ~ label {
            color: #F39C12;
        }
        .divider {
            height: 1px;
            background: #E0E0E0;
            margin: 30px 0;
        }
        #spot-review-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .spot-review-item {
            background: #F9F9F9;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 20px;
        }
        /* ======== :흰색_확인_표시: 1. CSS 추가 ======== */
        .spot-review-item h3 {
            margin: 0 0 10px 0;
            color: #2C3E50;
            display: flex; /* 뱃지와 제목 정렬 */
            align-items: center;
        }
        .day-badge {
            background-color: #3498DB;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            margin-right: 8px;
            white-space: nowrap; /* "Day 1"이 줄바꿈 되지 않도록 */
        }
        /* ================================ */
        .spot-review-item .rating-stars {
            margin-bottom: 10px;
        }
        .spot-review-item .rating-stars label {
            font-size: 24px;
        }
        .spot-review-item textarea {
            height: 60px;
            font-size: 14px;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
<h1>리뷰 작성</h1>
<div class="review-container">
    <form id="complexReviewForm" enctype="multipart/form-data">
        <h2 id="course-title">... (코스 제목 로딩 중)</h2>
        <input type="hidden" id="course-target-id" value="">
        <input type="hidden" id="course-target-type" value="course">
        새 항목
        12:12
        <label for="review-title">리뷰 제목</label>
        <input type="text" id="review-title" name="title" required>
        <label for="review-content">리뷰 내용</label>
        <textarea id="review-content" name="content" required></textarea>
        <label>별점</label>
        <div class="rating-stars" id="main-rating">
            <input type="radio" id="main-star5" name="rating" value="5" required><label for="main-star5">★</label>
            <input type="radio" id="main-star4" name="rating" value="4"><label for="main-star4">★</label>
            <input type="radio" id="main-star3" name="rating" value="3"><label for="main-star3">★</label>
            <input type="radio" id="main-star2" name="rating" value="2"><label for="main-star2">★</label>
            <input type="radio" id="main-star1" name="rating" value="1"><label for="main-star1">★</label>
        </div>
        <label for="review-images">사진 업로드 (코스 전체)</label>
        <input type="file" id="review-images" name="images" multiple>
        <div class="divider"></div>
        <h2>코스 포함 관광지 리뷰</h2>
        <div id="spot-review-list">
            <p style="text-align: center; color: #7F8C8D;">관광지 목록을 불러오는 중입니다...</p>
        </div>
        <button type="submit" style="margin-top: 30px;">리뷰 등록</button>
    </form>
</div>
<script>
    let planId;
    document.addEventListener("DOMContentLoaded", async () => {
        const url = new URL(window.location.href);
        planId = url.searchParams.get("planId");
        if (!planId) {
            alert("잘못된 접근입니다. planId가 없습니다.");
            return;
        }
        loadCourseInfo(planId);
        loadSpotInfo(planId);
    });
    // 코스 정보 로드
    async function loadCourseInfo(planId) {
        try {
            const response = await fetch(`/reviews/course?planId=${planId}`, {
                method: "GET",
                credentials: "include"
            });
            if (!response.ok) throw new Error("코스 정보 로딩 실패");
            const target = await response.json();
            document.getElementById("course-title").textContent = target.title.replace(" - 전체 여행 코스", "");
            document.getElementById("course-target-id").value = target.targetId;
        } catch (error) {
            console.error(error);
            document.getElementById("course-title").textContent = "코스 정보 로딩 실패";
        }
    }
    // 관광지 목록 로드
    async function loadSpotInfo(planId) {
        const container = document.getElementById("spot-review-list");
        try {
            // PlanController의 상세조회 API 호출
            const response = await fetch(`/plans/${planId}`, {
                method: 'GET',
                credentials: 'include'
            });
            if (!response.ok) throw new Error("관광지 목록 로딩 실패");
            const resDto = await response.json();
            const planDetail = resDto.data; // ResponseDto로 감싸져 있으므로 .data
            const spots = planDetail.coursePlaces; // List<CoursePlaceDto>
            container.innerHTML = "";
            if (!spots || spots.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: #7F8C8D;">이 코스에는 리뷰할 관광지가 없습니다.</p>`;
                return;
            }
            spots.forEach(spot => {
                const itemDiv = document.createElement("div");
                itemDiv.className = "spot-review-item";
                itemDiv.dataset.targetId = spot.id;
                itemDiv.dataset.type = spot.type;
                // ======== :흰색_확인_표시: 2. HTML 수정 (dayNo 표시) ========
                // <h3> 태그 안에 <span> 뱃지 추가
                itemDiv.innerHTML = `
                    <h3>
                        <span class="day-badge">Day ${spot.dayNo}</span>
                        ${spot.title}
                    </h3>
                    <label>별점</label>
                    <div class="rating-stars">
                        <input type="radio" id="spot-star5-${spot.id}" name="spot_rating_${spot.id}" value="5"><label for="spot-star5-${spot.id}">★</label>
                        <input type="radio" id="spot-star4-${spot.id}" name="spot_rating_${spot.id}" value="4"><label for="spot-star4-${spot.id}">★</label>
                        <input type="radio" id="spot-star3-${spot.id}" name="spot_rating_${spot.id}" value="3"><label for="spot-star3-${spot.id}">★</label>
                        <input type="radio" id="spot-star2-${spot.id}" name="spot_rating_${spot.id}" value="2"><label for="spot-star2-${spot.id}">★</label>
                        <input type="radio" id="spot-star1-${spot.id}" name="spot_rating_${spot.id}" value="1"><label for="spot-star1-${spot.id}">★</label>
                    </div>
                    <label for="spot-content-${spot.id}">한 줄 평 (선택)</label>
                    <textarea id="spot-content-${spot.id}" class="spot-content" placeholder="이 장소에 대한 리뷰를 남겨주세요"></textarea>
                `;
                // ==========================================
                container.appendChild(itemDiv);
            });
        } catch (error) {
            console.error(error);
            container.innerHTML = `<p style="text-align:center;color:#e74c3c;">관광지 목록을 불러오는 중 오류가 발생했습니다.</p>`;
        }
    }
    // 폼 제출 이벤트 (POST /reviews/complex)
    document.addEventListener("submit", async (event) => {
        if (event.target.id !== "complexReviewForm") return;
        event.preventDefault();
        const form = event.target;
        // --- 1. 코스 전체 리뷰 DTO 구성 ---
        const mainRatingInput = form.querySelector('input[name="rating"]:checked');
        if (!mainRatingInput) {
            alert("코스 전체에 대한 별점을 선택해주세요.");
            return;
        }
        const mainReview = {
            targetId: document.getElementById("course-target-id").value,
            targetType: document.getElementById("course-target-type").value,
            title: document.getElementById("review-title").value,
            content: document.getElementById("review-content").value,
            rating: parseInt(mainRatingInput.value, 10)
        };
        // --- 2. 개별 관광지 리뷰 DTO 목록 구성 ---
        const spotReviews = [];
        document.querySelectorAll(".spot-review-item").forEach(item => {
            const ratingInput = item.querySelector('input[name^="spot_rating_"]:checked');
            const content = item.querySelector('.spot-content').value;
            const rating = ratingInput ? parseInt(ratingInput.value, 10) : 0;
            if (rating > 0 || content.trim() !== "") {
                spotReviews.push({
                    targetId: item.dataset.targetId,
                    targetType: item.dataset.type,
                    rating: rating,
                    content: content
                });
            }
        });
        // --- 3. DTO와 이미지를 FormData에 합치기 ---
        const formData = new FormData();
        const combinedDto = {
            mainReview: mainReview,
            spotReviews: spotReviews
        };
        formData.append('dto', new Blob([JSON.stringify(combinedDto)], {
            type: "application/json"
        }));
        const imageFiles = document.getElementById("review-images").files;
        for (let i = 0; i < imageFiles.length; i++) {
            formData.append('images', imageFiles[i]);
        }
        // --- 4. 새로운 /reviews/complex API로 전송 ---
        try {
            const response = await fetch("/reviews/complex", {
                method: "POST",
                body: formData,
                credentials: "include"
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error("리뷰 등록에 실패했습니다: " + errorText);
            }
            alert("리뷰가 성공적으로 등록되었습니다!");
            location.href = "/reviews/view/search/my";
        } catch (err) {
            console.error(err);
            alert("서버 오류가 발생했습니다. " + err.message);
        }
    });
</script>
</body>
</html>