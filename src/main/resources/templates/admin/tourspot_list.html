<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ì | ê´€ê´‘ì§€ ëª©ë¡</title>

    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/admin_tourspot.css}">
</head>

<body>
<header>
    <div style="display: flex; align-items: center; gap: 20px;">
        <img th:src="@{/images/logo.png}" alt="Logo">
        <div class="title">TRAVEL PLANING</div>
    </div>
    <div>
        <div style="text-align:right; font-size:14px; margin-bottom:5px;">
            (ê´€ë¦¬ì) ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.
        </div>
        <div class="nav">
            <a th:href="@{/admin/view/members}">íšŒì›ê´€ë¦¬</a>
            <a th:href="@{/admin/view/tourspot}">ê´€ê´‘ì§€ê´€ë¦¬</a>
            <a th:href="@{/mypage}">ê´€ë¦¬ìí˜ì´ì§€</a>
            <a th:href="@{/logout}">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>
</header>

<main>

    <!-- âœ… ê²€ìƒ‰ ì˜ì—­ -->
    <div style="margin: 20px 0; text-align: center;">
        <input type="text" id="searchInput" placeholder="ê´€ê´‘ì§€ ì œëª©ìœ¼ë¡œ ê²€ìƒ‰..."
               style="padding: 6px 10px; width: 250px;">
        <button onclick="searchTourSpots()">ê²€ìƒ‰</button>
        <button onclick="location.href='/admin/view/tourspot'">ì „ì²´ ë³´ê¸°</button>
    </div>

    <!-- âœ… ê´€ê´‘ì§€ ì¶”ê°€ ë²„íŠ¼ -->
    <div style="text-align: right; margin: 20px;">
        <button class="add-btn" th:onclick="'location.href=\'/admin/view/tourspot/add\''">ê´€ê´‘ì§€ ì¶”ê°€</button>
    </div>

    <h2 style="text-align: center;">ê´€ê´‘ì§€ ëª©ë¡</h2>

    <table id="tourspotTable">
        <thead>
        <tr>
            <th>ë²ˆí˜¸</th>
            <th>ëŒ€í‘œ ì´ë¯¸ì§€</th>
            <th>ì œëª©</th>
            <th>ì£¼ì†Œ</th>
            <th>ì¶”ì²œ ìˆ˜</th>
            <th>ìƒíƒœ</th>
            <th>ê´€ë¦¬</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="spot, iterStat : ${tourspotList}"
            th:onclick="'location.href=\'/admin/edit/' + ${spot.id} + '\';'"
            class="clickable-row">
            <td th:text="${iterStat.count}"></td>
            <td><img th:src="${spot.firstImage}" alt="ì´ë¯¸ì§€" width="80" height="60"></td>
            <td th:text="${spot.title}">ì œëª©</td>
            <td th:text="${spot.address}">ì£¼ì†Œ</td>
            <td th:text="${spot.recCount}">ì¶”ì²œ ìˆ˜</td>
            <td th:text="${spot.status}">ìƒíƒœ</td>
            <td>
                <button class="btn-action"
                        th:if="${spot.status == 'Y'}"
                        th:onclick="'event.stopPropagation(); deactivateTourSpot(' + ${spot.id} + ');'">
                    ğŸ—‘ ë¹„í™œì„±í™”
                </button>
                <button class="btn-action"
                        th:if="${spot.status == 'N'}"
                        th:onclick="'event.stopPropagation(); activateTourSpot(' + ${spot.id} + ');'">
                    â™» ë³µêµ¬
                </button>
            </td>
        </tr>

        <tr th:if="${#lists.isEmpty(tourspotList)}">
            <td colspan="7">ë“±ë¡ëœ ê´€ê´‘ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
        </tr>
        </tbody>
    </table>

    <!-- âœ… í˜ì´ì§€ë„¤ì´ì…˜ -->
    <div class="pagination">
        <a th:if="${currentPage > 0}"
           th:href="@{/admin/view/tourspot(page=${currentPage - 1})}">&lt; ì´ì „</a>

        <a th:each="i : ${#numbers.sequence(startPage, endPage - 1)}"
           th:href="@{/admin/view/tourspot(page=${i})}"
           th:text="${i + 1}"
           th:classappend="${i == currentPage} ? 'active' : ''"></a>

        <a th:if="${currentPage + 1 < totalPages}"
           th:href="@{/admin/view/tourspot(page=${currentPage + 1})}">ë‹¤ìŒ &gt;</a>
    </div>

    <footer>Â© 2025 Travel Planing. All rights reserved.</footer>
</main>

<!-- âœ… ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    // âœ… ì„œë²„ ymlì— ì§€ì •í•œ ì´ë¯¸ì§€ ê¸°ë³¸ URL (í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •)
    const IMAGE_BASE_URL = "http://localhost:8090/reviewimgs/";

    async function searchTourSpots() {
        const keyword = document.getElementById("searchInput").value.trim();
        if (!keyword) {
            alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        try {
            const response = await fetch(`/admin/tourspot/search?title=${encodeURIComponent(keyword)}`);
            const data = await response.json();

            const tourList = data.data || [];
            const tableBody = document.querySelector("#tourspotTable tbody");
            tableBody.innerHTML = "";

            if (tourList.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }

            tourList.forEach((spot, index) => {
                // âœ… ì´ë¯¸ì§€ ê²½ë¡œ ë³´ì • ë¡œì§
                let imageSrc = "";
                if (!spot.firstImage) {
                    imageSrc = "/images/no-image.png";
                } else if (spot.firstImage.startsWith("http")) {
                    imageSrc = spot.firstImage;
                } else {
                    imageSrc = IMAGE_BASE_URL + spot.firstImage;
                }

                const row = document.createElement("tr");
                row.classList.add("clickable-row");
                row.onclick = () => location.href = `/admin/edit/${spot.id}`;

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><img src="${imageSrc}" alt="ì´ë¯¸ì§€" width="80" height="60"></td>
                    <td>${spot.title}</td>
                    <td>${spot.address}</td>
                    <td>${spot.recCount || 0}</td>
                    <td>${spot.status}</td>
                    <td>
                        ${spot.status === 'Y'
                    ? `<button class="btn-action" onclick="event.stopPropagation(); deactivateTourSpot(${spot.id});">ğŸ—‘ ë¹„í™œì„±í™”</button>`
                    : `<button class="btn-action" onclick="event.stopPropagation(); activateTourSpot(${spot.id});">â™» ë³µêµ¬</button>`}
                    </td>
                `;
                tableBody.appendChild(row);
            });

        } catch (err) {
            console.error("ì„œë²„ í†µì‹  ì˜¤ë¥˜:", err);
            alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // âœ… ê´€ê´‘ì§€ ë¹„í™œì„±í™”
    async function deactivateTourSpot(id) {
        if (!confirm("ì´ ê´€ê´‘ì§€ë¥¼ ë¹„í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const res = await fetch(`/admin/tourspot/${id}/deactivate`, { method: "PUT" });
        if (res.ok) {
            alert("ë¹„í™œì„±í™” ì™„ë£Œ!");
            location.reload();
        } else {
            alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // âœ… ê´€ê´‘ì§€ ë³µêµ¬
    async function activateTourSpot(id) {
        if (!confirm("ì´ ê´€ê´‘ì§€ë¥¼ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const res = await fetch(`/admin/tourspot/${id}/activate`, { method: "PUT" });
        if (res.ok) {
            alert("ë³µêµ¬ ì™„ë£Œ!");
            location.reload();
        } else {
            alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }
</script>

</body>
</html>
