<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê´€ê´‘ì§€ ê´€ë¦¬ | Travel Planing</title>
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/admin_tourspot.css}">
</head>

<body>
<script th:src="@{/js/common.js}"></script>

<header>
    <div class="header-left">
        <img th:src="@{/images/logo.png}" alt="Logo">
        <div class="title">TRAVEL PLANING</div>
    </div>
    <div class="header-right">
        <div class="welcome-text">
            <span class="admin-badge">ê´€ë¦¬ì</span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.
        </div>
        <nav class="nav">
            <a th:href="@{/spots/view/tourspotlist}" class="nav-link">
                <span class="nav-icon">ğŸ </span>
                <span>í™ˆ</span>
            </a>
            <a th:href="@{/admin/view/adminpage}" class="nav-link active">
                <span class="nav-icon">ğŸ“Š</span>
                <span>ëŒ€ì‹œë³´ë“œ</span>
            </a>
            <a th:href="@{/admin/view/members}" class="nav-link">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>íšŒì›ê´€ë¦¬</span>
            </a>
            <a th:href="@{/admin/view/tourspot}" class="nav-link">
                <span class="nav-icon">ğŸ—ºï¸</span>
                <span>ê´€ê´‘ì§€ê´€ë¦¬</span>
            </a>
            <a th:href="@{/admin/view/acc}" class="nav-link">
                <span class="nav-icon">ğŸ¨</span>
                <span>ìˆ™ì†Œê´€ë¦¬</span>
            </a>
            <a href="javascript:void(0);" class="nav-link logout" onclick="handleLogout()">
                <span class="nav-icon">ğŸšª</span>
                <span>ë¡œê·¸ì•„ì›ƒ</span>
            </a>
        </nav>

    </div>
</header>

<main>
    <div class="admin-container">
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <h2 class="admin-title">ê´€ê´‘ì§€ ê´€ë¦¬</h2>
                <p class="admin-sub">ë“±ë¡ëœ ê´€ê´‘ì§€ë¥¼ ê´€ë¦¬í•˜ê³  ìƒˆë¡œìš´ ì¥ì†Œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤</p>
            </div>
            <div class="stats-card">
                <div class="stat-item">
                    <span class="stat-label">ì „ì²´ ê´€ê´‘ì§€</span>
                    <span class="stat-value" id="totalSpots">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">í™œì„± ê´€ê´‘ì§€</span>
                    <span class="stat-value active" id="activeSpots">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ë¹„í™œì„± ê´€ê´‘ì§€</span>
                    <span class="stat-value inactive" id="inactiveSpots">-</span>
                </div>
            </div>
            <button class="btn-add-tourspot" th:onclick="'location.href=\'/admin/view/tourspot/add\''">
                <span class="add-icon">â•</span>
                <span>ê´€ê´‘ì§€ ì¶”ê°€í•˜ê¸°</span>
            </button>
        </aside>

        <section class="admin-content">
            <!-- ê²€ìƒ‰ ì˜ì—­ -->
            <div class="search-container">
                <div class="search-box">
                    <input type="text"
                           id="searchInput"
                           placeholder="ğŸ” ê´€ê´‘ì§€ ì œëª©ìœ¼ë¡œ ê²€ìƒ‰..."
                           onkeydown="if(event.key==='Enter') searchTourSpots();" />
                    <button class="btn btn-search" onclick="searchTourSpots()">ê²€ìƒ‰</button>
                    <button class="btn btn-reset" onclick="location.href='/admin/view/tourspot'">ì „ì²´ ë³´ê¸°</button>
                </div>
            </div>

            <!-- í…Œì´ë¸” ì˜ì—­ -->
            <div class="table-container">
                <table id="tourspotTable">
                    <thead>
                    <tr>
                        <th width="60">ë²ˆí˜¸</th>
                        <th width="100">ëŒ€í‘œ ì´ë¯¸ì§€</th>
                        <th width="180">ì œëª©</th>
                        <th width="200">ì£¼ì†Œ</th>
                        <th width="120">í™ˆí˜ì´ì§€</th>
                        <th width="80">ì¶”ì²œ ìˆ˜</th>
                        <th width="80">ìƒíƒœ</th>
                        <th width="120">ê´€ë¦¬</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="spot, iterStat : ${tourspotList}"
                        th:onclick="'location.href=\'/admin/edit/' + ${spot.id} + '\';'"
                        class="clickable-row">
                        <td class="text-center" th:text="${iterStat.count}"></td>
                        <td class="text-center">
                            <img th:src="${spot.firstImage}"
                                 alt="ê´€ê´‘ì§€ ì´ë¯¸ì§€"
                                 class="tourspot-thumbnail"
                                 onerror="this.onerror=null; this.src='/images/no-image.png'">
                        </td>
                        <td class="tourspot-title" th:text="${spot.title}">ì œëª©</td>
                        <td class="tourspot-address" th:text="${spot.address}">ì£¼ì†Œ</td>
                        <td class="text-center tourspot-homepage">
                            <a th:if="${spot.homepage != null and !#strings.isEmpty(spot.homepage)}"
                               th:href="${spot.homepage}"
                               target="_blank"
                               onclick="event.stopPropagation();"
                               class="homepage-link">
                                ğŸ”— ë°”ë¡œê°€ê¸°
                            </a>
                            <span th:unless="${spot.homepage != null and !#strings.isEmpty(spot.homepage)}"
                                  class="no-homepage">-</span>
                        </td>
                        <td class="text-center">
                            <span class="rec-count" th:text="${spot.recCount}">0</span>
                        </td>
                        <td class="text-center">
                                <span class="status-badge"
                                      th:classappend="${spot.status == 'Y' ? 'status-active' : 'status-inactive'}"
                                      th:text="${spot.status == 'Y' ? 'âœ“ í™œì„±' : 'âœ— ë¹„í™œì„±'}">
                                </span>
                        </td>
                        <td class="text-center">
                            <button class="btn-action btn-deactivate"
                                    th:if="${spot.status == 'Y'}"
                                    th:onclick="'event.stopPropagation(); deactivateTourSpot(' + ${spot.id} + ');'">
                                <span>ë¹„í™œì„±í™”</span>
                            </button>
                            <button class="btn-action btn-activate"
                                    th:if="${spot.status == 'N'}"
                                    th:onclick="'event.stopPropagation(); activateTourSpot(' + ${spot.id} + ');'">
                                <span>ë³µêµ¬</span>
                            </button>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(tourspotList)}" class="empty-row">
                        <td colspan="8">
                            <div class="empty-state">
                                <span class="empty-icon">ğŸ—ºï¸</span>
                                <p>ë“±ë¡ëœ ê´€ê´‘ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div class="pagination" th:if="${totalPages > 0}">
                <a th:if="${currentPage > 0}"
                   th:href="@{/admin/view/tourspot(page=${currentPage - 1})}"
                   class="page-btn prev-btn">
                    â€¹ ì´ì „
                </a>

                <a th:each="i : ${#numbers.sequence(startPage, endPage - 1)}"
                   th:href="@{/admin/view/tourspot(page=${i})}"
                   th:text="${i + 1}"
                   class="page-number"
                   th:classappend="${i == currentPage} ? 'active' : ''">
                </a>

                <a th:if="${currentPage + 1 < totalPages}"
                   th:href="@{/admin/view/tourspot(page=${currentPage + 1})}"
                   class="page-btn next-btn">
                    ë‹¤ìŒ â€º
                </a>
            </div>
        </section>
    </div>
</main>

<footer>
    <p>&copy; 2025 Travel Planing. All rights reserved.</p>
</footer>

<script>
    const IMAGE_BASE_URL = "http://localhost:8090/reviewimgs/";

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í†µê³„ ì—…ë°ì´íŠ¸
    window.onload = function() {
        updateStats();
    };

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats() {
        const rows = document.querySelectorAll("#tourspotTable tbody tr:not(.empty-row)");
        const total = rows.length;
        let active = 0;

        rows.forEach(row => {
            const statusBadge = row.querySelector('.status-badge');
            if (statusBadge && statusBadge.classList.contains('status-active')) {
                active++;
            }
        });

        const inactive = total - active;

        document.getElementById('totalSpots').textContent = total;
        document.getElementById('activeSpots').textContent = active;
        document.getElementById('inactiveSpots').textContent = inactive;
    }

    // ê´€ê´‘ì§€ ê²€ìƒ‰
    async function searchTourSpots() {
        const keyword = document.getElementById("searchInput").value.trim();
        if (!keyword) {
            alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        try {
            const response = await fetchWithRefresh(`/admin/tourspot/search?title=${encodeURIComponent(keyword)}`);
            const data = await response.json();

            const tourList = data.data || [];
            const tableBody = document.querySelector("#tourspotTable tbody");
            tableBody.innerHTML = "";

            if (tourList.length === 0) {
                tableBody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="8">
                            <div class="empty-state">
                                <span class="empty-icon">ğŸ”</span>
                                <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                            </div>
                        </td>
                    </tr>`;
                updateStats();
                return;
            }

            tourList.forEach((spot, index) => {
                let imageSrc = "";
                if (!spot.firstImage) {
                    imageSrc = "/images/no-image.png";
                } else if (spot.firstImage.startsWith("http")) {
                    imageSrc = spot.firstImage;
                } else {
                    imageSrc = IMAGE_BASE_URL + spot.firstImage;
                }

                // âœ… í™ˆí˜ì´ì§€ ë§í¬ ìƒì„±
                const homepageHtml = spot.homepage
                    ? `<a href="${spot.homepage}" target="_blank" onclick="event.stopPropagation();" class="homepage-link">ğŸ”— ë°”ë¡œê°€ê¸°</a>`
                    : `<span class="no-homepage">-</span>`;

                const row = document.createElement("tr");
                row.classList.add("clickable-row");
                row.onclick = () => location.href = `/admin/edit/${spot.id}`;

                row.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td class="text-center">
                        <img src="${imageSrc}"
                             alt="ê´€ê´‘ì§€ ì´ë¯¸ì§€"
                             class="tourspot-thumbnail"
                             onerror="this.src='/images/no-image.png'">
                    </td>
                    <td class="tourspot-title">${spot.title}</td>
                    <td class="tourspot-address">${spot.address}</td>
                    <td class="text-center tourspot-homepage">${homepageHtml}</td>
                    <td class="text-center">
                        <span class="rec-count">${spot.recCount || 0}</span>
                    </td>
                    <td class="text-center">
                        <span class="status-badge ${spot.status === 'Y' ? 'status-active' : 'status-inactive'}">
                            ${spot.status === 'Y' ? 'âœ“ í™œì„±' : 'âœ— ë¹„í™œì„±'}
                        </span>
                    </td>
                    <td class="text-center">
                        ${spot.status === 'Y'
                    ? `<button class="btn-action btn-deactivate" onclick="event.stopPropagation(); deactivateTourSpot(${spot.id});">
                                   <span>ë¹„í™œì„±í™”</span>
                               </button>`
                    : `<button class="btn-action btn-activate" onclick="event.stopPropagation(); activateTourSpot(${spot.id});">
                                   <span>ë³µêµ¬</span>
                               </button>`}
                    </td>
                `;
                tableBody.appendChild(row);
            });

            updateStats();

        } catch (err) {
            console.error("ì„œë²„ í†µì‹  ì˜¤ë¥˜:", err);
            alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ê´€ê´‘ì§€ ë¹„í™œì„±í™”
    async function deactivateTourSpot(id) {
        if (!confirm("ì´ ê´€ê´‘ì§€ë¥¼ ë¹„í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
            const res = await fetchWithRefresh(`/admin/tourspot/${id}/deactivate`, { method: "PUT" });
            if (res.ok) {
                alert("âœ“ ë¹„í™œì„±í™” ì™„ë£Œ!");
                location.reload();
            } else {
                alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        } catch (err) {
            console.error("ì˜¤ë¥˜:", err);
            alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ê´€ê´‘ì§€ ë³µêµ¬
    async function activateTourSpot(id) {
        if (!confirm("ì´ ê´€ê´‘ì§€ë¥¼ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
            const res = await fetchWithRefresh(`/admin/tourspot/${id}/activate`, { method: "PUT" });
            if (res.ok) {
                alert("âœ“ ë³µêµ¬ ì™„ë£Œ!");
                location.reload();
            } else {
                alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        } catch (err) {
            console.error("ì˜¤ë¥˜:", err);
            alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    async function handleLogout() {
        try {
            const response = await fetch('/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (response.ok) {
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/login';
            } else {
                const result = await response.json();
                alert(result.message || 'ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
            alert('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
</script>

</body>
</html>