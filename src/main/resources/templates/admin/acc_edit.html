<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="ko"
      layout:decorate="~{/common/layout}">

<head layout:fragment="head">
    <meta charset="UTF-8">
    <title>숙소 수정 | Travel Planning</title>

    <!-- 기존 스타일 유지 -->
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/admin_tourspot_edit.css}">
</head>

<body>

<!-- ⭐ 페이지 실제 내용 -->
<div layout:fragment="content">

    <main>
        <!-- 상단 헤더 -->
        <div class="page-header">
            <div class="breadcrumb">
                <a th:href="@{/admin/view/acc}">숙소 관리</a>
                <span class="separator">›</span>
                <span class="current">숙소 수정</span>
            </div>
            <h2 class="page-title">
                <span class="title-icon">✏️</span>
                숙소 정보 수정
            </h2>
            <p class="page-desc">숙소 상세 정보를 수정할 수 있습니다</p>
        </div>

        <div class="edit-container">

            <!-- 왼쪽 입력 폼 -->
            <div class="form-section form-left">

                <!-- 컨트롤러에서 전달받는 id -->
                <input type="hidden" id="accId" th:value="${id}">

                <div class="form-group">
                    <label class="form-label required"><span class="label-icon">📝</span> 숙소명</label>
                    <input type="text" id="title" class="form-input" placeholder="숙소명 입력" required>
                </div>

                <div class="form-group">
                    <label class="form-label required"><span class="label-icon">📍</span> 주소</label>
                    <input type="text" id="address" class="form-input" placeholder="전체 주소 입력" required>
                </div>

                <div class="form-group">
                    <label class="form-label"><span class="label-icon">📞</span>전화번호</label>
                    <input type="text" id="tel" class="form-input">
                </div>

                <div class="form-group">
                    <label class="form-label"><span class="label-icon">📞</span>홈페이지</label>
                    <input type="text" id="homepage" class="form-input">
                </div>

                <div class="form-group">
                    <label class="form-label"><span class="label-icon">📄</span>설명</label>
                    <textarea id="description" class="form-textarea" placeholder="숙소 설명 입력"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">🌍 위도</label>
                        <input type="text" id="mapy" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">🌏 경도</label>
                        <input type="text" id="mapx" class="form-input">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">지역 코드</label>
                        <input type="number" id="areacode" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">시군구 코드</label>
                        <input type="number" id="sigungucode" class="form-input">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">행정동 코드</label>
                    <input type="number" id="lDongRegnCd" class="form-input">
                </div>
            </div>

            <!-- 오른쪽 이미지 영역 -->
            <div class="form-section form-right">

                <div class="image-section">
                    <label class="form-label"><span class="label-icon">🖼️</span>대표 이미지</label>

                    <div class="image-preview-container">
                        <img id="previewImg" src="" alt="숙소 이미지" class="preview-image">
                        <div class="image-overlay">
                            <span class="overlay-text">클릭하여 이미지 변경</span>
                        </div>
                    </div>

                    <div class="file-input-wrapper">
                        <input type="file" id="file" class="file-input" accept="image/*" onchange="previewImage(event)">
                        <label for="file" class="file-label">
                            <span class="file-icon">📁</span>
                            <span class="file-text">이미지 선택</span>
                        </label>
                    </div>

                    <div class="image-info">
                        <p class="info-text">ℹ️ 권장 크기: 800x600px 이상</p>
                        <p class="info-text">ℹ️ 지원 형식: JPG, PNG, WEBP</p>
                    </div>
                </div>

                <!-- 우측 정보 카드 -->
                <div class="stats-info-card">
                    <h3 class="stats-title">숙소 정보</h3>

                    <div class="stats-item">
                        <span class="stats-label">숙소 ID</span>
                        <span class="stats-value" id="stat-id"></span>
                    </div>

                    <div class="stats-item">
                        <span class="stats-label">추천 수</span>
                        <span class="stats-value recommend" id="stat-rec"></span>
                    </div>

                    <div class="stats-item">
                        <span class="stats-label">상태</span>
                        <span class="stats-value" id="stat-status"></span>
                    </div>
                </div>

            </div>
        </div>

        <!-- 버튼 -->
        <div class="btn-container">
            <button type="button" class="btn btn-save" onclick="updateAcc()">
                <span class="btn-icon">💾</span>저장하기
            </button>

            <button type="button" class="btn btn-cancel" onclick="confirmCancel()">
                <span class="btn-icon">↩️</span>취소
            </button>
        </div>

    </main>


<script defer>
    window.onload = () => {
        console.log("🚀 페이지 로드됨 → loadAccData 실행 시작");
        loadAccData();
    };

    /* -------------------------
       1) 초기 데이터 로딩
    ------------------------- */
    function loadAccData() {
        const id = document.getElementById("accId").value;
        console.log("📌 숨겨진 ID 값:", id);

        const url = `/accommodations/detail?id=${id}`;
        console.log("🌐 요청 URL:", url);

        fetch(url)
            .then(res => {
                console.log("🔵 fetch 응답 status:", res.status);
                return res.json();
            })
            .then(result => {
                console.log("🟢 조회 성공 결과:", result);

                if (!result || !result.data) {
                    console.error("❌ result.data 없음:", result);
                    alert("조회된 숙소 정보가 없습니다!");
                    return;
                }

                const acc = result.data;
                console.log("📦 숙소 데이터(acc):", acc);

                // 좌측 입력값 채우기
                document.getElementById("title").value = acc.title || "";
                document.getElementById("address").value = acc.address || "";
                document.getElementById("tel").value = acc.tel || "";
                document.getElementById("homepage").value = acc.homepage || "";
                document.getElementById("description").value = acc.description || "";
                document.getElementById("mapx").value = acc.mapx || "";
                document.getElementById("mapy").value = acc.mapy || "";
                document.getElementById("areacode").value = acc.areacode || "";
                document.getElementById("sigungucode").value = acc.sigungucode || "";
                document.getElementById("lDongRegnCd").value = acc.ldongRegnCd || "";

                // 이미지
                if (acc.firstImage) {
                    document.getElementById("previewImg").src = acc.firstImage;
                } else {
                    document.getElementById("previewImg").src = `/images/no-image.png`;
                }

                // 우측 정보 카드
                document.getElementById("stat-id").textContent = acc.id;
                document.getElementById("stat-rec").textContent = acc.recCount;

                const statusEl = document.getElementById("stat-status");
                if (acc.status === "Y") {
                    statusEl.textContent = "✓ 활성";
                    statusEl.classList.add("status-active");
                } else {
                    statusEl.textContent = "✗ 비활성";
                    statusEl.classList.add("status-inactive");
                }

                console.log("✅ 화면 반영 완료");

            })
            .catch(err => {
                console.error("🔥 fetch 오류 발생:", err);
                alert("데이터 로딩 중 오류 발생(콘솔 확인)");
            });
    }

    /* -------------------------
       2) 업데이트 (저장)
    ------------------------- */
    function updateAcc() {

        const title = document.getElementById("title").value.trim();
        const address = document.getElementById("address").value.trim();

        if (!title) {
            alert('⚠️ 제목을 입력해주세요.');
            document.getElementById("title").focus();
            return;
        }

        if (!address) {
            alert('⚠️ 주소를 입력해주세요.');
            document.getElementById("address").focus();
            return;
        }
        const id = document.getElementById("accId").value;

        const formData = new FormData();

        // AccDTO의 모든 필드를 직접 append!!
        formData.append("id", id);
        formData.append("title", document.getElementById("title").value.trim());
        formData.append("address", document.getElementById("address").value.trim());
        formData.append("tel", document.getElementById("tel").value.trim());
        formData.append("homepage", document.getElementById("homepage").value.trim());
        formData.append("description", document.getElementById("description").value.trim());
        formData.append("mapx", document.getElementById("mapx").value);
        formData.append("mapy", document.getElementById("mapy").value);
        formData.append("areacode", document.getElementById("areacode").value);
        formData.append("sigungucode", document.getElementById("sigungucode").value);
        formData.append("lDongRegnCd", document.getElementById("lDongRegnCd").value);
        formData.append("catCode", "acc");  // 고정
        formData.append("contentId", "");   // 필요 없으면 빈칸

        // 파일 append
        const file = document.getElementById("file").files[0];
        if (file) {
            formData.append("imageFile", file);
        }

        fetch(`/admin/accommodations/update`, {
            method: "PUT",
            body: formData
        })
            .then(res => {
                if (res.ok) {
                    alert("수정 완료!");
                    location.href = "/admin/view/acc";
                } else {
                    alert("오류 발생. 다시 시도해주세요.");
                }
            });
    }


    /* -------------------------
       3) 이미지 미리보기
    ------------------------- */
    function previewImage(event) {
        console.log("🖼 이미지 선택됨:", event.target.files[0]);

        const file = event.target.files[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) {
            alert("⚠️ 파일 크기가 5MB를 초과합니다.");
            event.target.value = "";
            return;
        }

        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById("previewImg").src = e.target.result;
            console.log("🖼 이미지 미리보기 반영 완료");
        };
        reader.readAsDataURL(file);
    }

    /* -------------------------
       4) 취소
    ------------------------- */
    function confirmCancel() {
        console.log("↩️ 취소 버튼 클릭됨");
        if (confirm("수정을 취소하시겠습니까?")) {
            history.back();
        }
    }
</script>
</div>

</body>

</html>
