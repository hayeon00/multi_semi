<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê´€ê´‘ì§€ ìˆ˜ì • | Travel Planing</title>
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/admin_tourspot_edit.css}">
</head>

<body>
<script th:src="@{/js/common.js}"></script>

<header>
    <div class="header-left">
        <img th:src="@{/images/logo.png}" alt="Logo">
        <div class="title">TRAVEL PLANING</div>
    </div>
    <div class="header-right">
        <div class="welcome-text">
            <span class="admin-badge">ê´€ë¦¬ì</span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.
        </div>
        <nav class="nav">
            <a th:href="@{/spots/view/tourspotlist}" class="nav-link">
                <span class="nav-icon">ğŸ </span>
                <span>í™ˆ</span>
            </a>
            <a th:href="@{/admin/view/adminpage}" class="nav-link active">
                <span class="nav-icon">ğŸ“Š</span>
                <span>ëŒ€ì‹œë³´ë“œ</span>
            </a>
            <a th:href="@{/admin/view/members}" class="nav-link">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>íšŒì›ê´€ë¦¬</span>
            </a>
            <a th:href="@{/admin/view/tourspot}" class="nav-link">
                <span class="nav-icon">ğŸ—ºï¸</span>
                <span>ê´€ê´‘ì§€ê´€ë¦¬</span>
            </a>
            <a th:href="@{/admin/view/acc}" class="nav-link">
                <span class="nav-icon">ğŸ¨</span>
                <span>ìˆ™ì†Œê´€ë¦¬</span>
            </a>
            <a href="javascript:void(0);" class="nav-link logout" onclick="handleLogout()">
                <span class="nav-icon">ğŸšª</span>
                <span>ë¡œê·¸ì•„ì›ƒ</span>
            </a>
        </nav>
    </div>
</header>

<main>
    <div class="page-header">
        <div class="breadcrumb">
            <a th:href="@{/admin/view/tourspot}">ê´€ê´‘ì§€ ê´€ë¦¬</a>
            <span class="separator">â€º</span>
            <span class="current">ê´€ê´‘ì§€ ìˆ˜ì •</span>
        </div>
        <h2 class="page-title">
            <span class="title-icon">âœï¸</span>
            ê´€ê´‘ì§€ ì •ë³´ ìˆ˜ì •
        </h2>
        <p class="page-desc">ê´€ê´‘ì§€ì˜ ìƒì„¸ ì •ë³´ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
    </div>

    <div class="edit-container">
        <!-- ì™¼ìª½ ì…ë ¥ í¼ -->
        <div class="form-section form-left">
            <input type="hidden" id="spotId" th:value="${spot.id}">

            <div class="form-group">
                <label class="form-label required">
                    <span class="label-icon">ğŸ“</span>
                    ì œëª©
                </label>
                <input type="text"
                       id="title"
                       class="form-input"
                       th:value="${spot.title}"
                       placeholder="ê´€ê´‘ì§€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                       required>
            </div>

            <div class="form-group">
                <label class="form-label required">
                    <span class="label-icon">ğŸ“</span>
                    ì£¼ì†Œ
                </label>
                <input type="text"
                       id="address"
                       class="form-input"
                       th:value="${spot.address}"
                       placeholder="ì „ì²´ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                       required>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <span class="label-icon">ğŸ“</span>
                    ì „í™”ë²ˆí˜¸
                </label>
                <input type="text"
                       id="tel"
                       class="form-input"
                       th:value="${spot.tel}"
                       placeholder="ì—°ë½ ê°€ëŠ¥í•œ ì „í™”ë²ˆí˜¸">
            </div>

            <!-- âœ… í™ˆí˜ì´ì§€ í•„ë“œ ì¶”ê°€ -->
            <div class="form-group">
                <label class="form-label">
                    <span class="label-icon">ğŸ”—</span>
                    í™ˆí˜ì´ì§€
                </label>
                <input type="url"
                       id="homepage"
                       class="form-input"
                       th:value="${spot.homepage}"
                       placeholder="ì˜ˆ: https://www.royalpalace.go.kr">
            </div>

            <div class="form-group">
                <label class="form-label">
                    <span class="label-icon">ğŸ“„</span>
                    ì„¤ëª…
                </label>
                <textarea id="description"
                          class="form-textarea"
                          th:text="${spot.description}"
                          placeholder="ê´€ê´‘ì§€ì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">ğŸŒ</span>
                        ìœ„ë„ (Latitude)
                    </label>
                    <input type="text"
                           id="mapy"
                           class="form-input"
                           th:value="${spot.mapy}"
                           placeholder="ì˜ˆ: 37.5665">
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">ğŸŒ</span>
                        ê²½ë„ (Longitude)
                    </label>
                    <input type="text"
                           id="mapx"
                           class="form-input"
                           th:value="${spot.mapx}"
                           placeholder="ì˜ˆ: 126.9780">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">ğŸ·ï¸</span>
                        ì§€ì—­ ì½”ë“œ
                    </label>
                    <input type="number"
                           id="areacode"
                           class="form-input"
                           th:value="${spot.areacode}"
                           placeholder="ì§€ì—­ ì½”ë“œ">
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">ğŸ·ï¸</span>
                        ì‹œêµ°êµ¬ ì½”ë“œ
                    </label>
                    <input type="number"
                           id="sigungucode"
                           class="form-input"
                           th:value="${spot.sigungucode}"
                           placeholder="ì‹œêµ°êµ¬ ì½”ë“œ">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <span class="label-icon">ğŸ”¢</span>
                    í–‰ì •ë™ ì½”ë“œ
                </label>
                <input type="text"
                       id="lDongRegnCd"
                       class="form-input"
                       th:value="${spot.lDongRegnCd}"
                       placeholder="í–‰ì •ë™ ì½”ë“œ">
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½ ì´ë¯¸ì§€ ì˜ì—­ -->
        <div class="form-section form-right">
            <div class="image-section">
                <label class="form-label">
                    <span class="label-icon">ğŸ–¼ï¸</span>
                    ëŒ€í‘œ ì´ë¯¸ì§€
                </label>

                <div class="image-preview-container">
                    <img id="previewImg"
                         th:src="${spot.firstImage}"
                         alt="ê´€ê´‘ì§€ ì´ë¯¸ì§€"
                         class="preview-image">
                    <div class="image-overlay">
                        <span class="overlay-text">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ë³€ê²½</span>
                    </div>
                </div>

                <div class="file-input-wrapper">
                    <input type="file"
                           id="file"
                           class="file-input"
                           accept="image/*"
                           onchange="previewImage(event)">
                    <label for="file" class="file-label">
                        <span class="file-icon">ğŸ“</span>
                        <span class="file-text">ì´ë¯¸ì§€ ì„ íƒ</span>
                    </label>
                </div>

                <div class="image-info">
                    <p class="info-text">
                        <span class="info-icon">â„¹ï¸</span>
                        ê¶Œì¥ í¬ê¸°: 800x600px ì´ìƒ
                    </p>
                    <p class="info-text">
                        <span class="info-icon">â„¹ï¸</span>
                        ì§€ì› í˜•ì‹: JPG, PNG, WEBP
                    </p>
                </div>
            </div>

            <!-- í†µê³„ ì •ë³´ ì¹´ë“œ -->
            <div class="stats-info-card">
                <h3 class="stats-title">ê´€ê´‘ì§€ ì •ë³´</h3>
                <div class="stats-item">
                    <span class="stats-label">ê´€ê´‘ì§€ ID</span>
                    <span class="stats-value" th:text="${spot.id}">-</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">ì¶”ì²œ ìˆ˜</span>
                    <span class="stats-value recommend" th:text="${spot.recCount}">0</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">ìƒíƒœ</span>
                    <span class="stats-value"
                          th:classappend="${spot.status == 'Y' ? 'status-active' : 'status-inactive'}"
                          th:text="${spot.status == 'Y' ? 'âœ“ í™œì„±' : 'âœ— ë¹„í™œì„±'}">
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ë²„íŠ¼ -->
    <div class="btn-container">
        <button type="button" class="btn btn-save" onclick="updateSpot()">
            <span class="btn-icon">ğŸ’¾</span>
            <span>ì €ì¥í•˜ê¸°</span>
        </button>
        <button type="button" class="btn btn-cancel" onclick="confirmCancel()">
            <span class="btn-icon">â†©ï¸</span>
            <span>ì·¨ì†Œ</span>
        </button>
    </div>
</main>

<footer>
    <p>&copy; 2025 Travel Planing. All rights reserved.</p>
</footer>

<script>
    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
    function previewImage(event) {
        const file = event.target.files[0];
        if (!file) return;

        // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('âš ï¸ íŒŒì¼ í¬ê¸°ê°€ 5MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.');
            event.target.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById("previewImg").src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    // ì·¨ì†Œ í™•ì¸
    function confirmCancel() {
        if (confirm('ìˆ˜ì •ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')) {
            history.back();
        }
    }

    // ê´€ê´‘ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
    function updateSpot() {
        // í•„ìˆ˜ í•„ë“œ ê²€ì¦
        const title = document.getElementById("title").value.trim();
        const address = document.getElementById("address").value.trim();

        if (!title) {
            alert('âš ï¸ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            document.getElementById("title").focus();
            return;
        }

        if (!address) {
            alert('âš ï¸ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            document.getElementById("address").focus();
            return;
        }

        const id = document.getElementById("spotId").value;

        const dto = {
            title: title,
            address: address,
            tel: document.getElementById("tel").value.trim(),
            homepage: document.getElementById("homepage").value.trim(), // âœ… ì¶”ê°€
            description: document.getElementById("description").value.trim(),
            mapx: parseFloat(document.getElementById("mapx").value) || null,
            mapy: parseFloat(document.getElementById("mapy").value) || null,
            areacode: parseInt(document.getElementById("areacode").value) || null,
            sigungucode: parseInt(document.getElementById("sigungucode").value) || null,
            lDongRegnCd: document.getElementById("lDongRegnCd").value.trim() || null
        };

        // ë””ë²„ê¹… ë¡œê·¸
        console.log("=== ì „ì†¡ ë°ì´í„° í™•ì¸ ===");
        console.log("ì „ì†¡í•  DTO:", dto);
        console.log("DTO JSON:", JSON.stringify(dto, null, 2));

        const file = document.getElementById("file").files[0];
        const formData = new FormData();
        formData.append("dto", new Blob([JSON.stringify(dto)], { type: "application/json" }));
        if (file) {
            formData.append("file", file);
        }

        // ë¡œë”© í‘œì‹œ
        const saveBtn = document.querySelector('.btn-save');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<span>ì €ì¥ ì¤‘...</span>';
        saveBtn.disabled = true;

        fetchWithRefresh(`/admin/tourspot/${id}`, {
            method: "PUT",
            body: formData,
            headers: {}
        })
            .then(res => {
                if (res.ok) {
                    alert("âœ… ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                    location.href = "/admin/view/tourspot";
                } else {
                    alert("âŒ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            })
            .catch(err => {
                console.error("ì„œë²„ ì˜¤ë¥˜:", err);
                alert("âŒ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
    }

    // í˜ì´ì§€ ë‚˜ê°ˆ ë•Œ ê²½ê³ 
    let formChanged = false;
    document.querySelectorAll('input, textarea').forEach(element => {
        element.addEventListener('change', () => {
            formChanged = true;
        });
    });

    window.addEventListener('beforeunload', (e) => {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    async function handleLogout() {
        try {
            const response = await fetch('/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (response.ok) {
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/login';
            } else {
                const result = await response.json();
                alert(result.message || 'ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
            alert('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
</script>
</body>
</html>