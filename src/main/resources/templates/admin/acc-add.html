<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="ko"
      layout:decorate="~{/common/layout}">

<head layout:fragment="head">
    <meta charset="UTF-8">
    <title>ìˆ™ì†Œ ì¶”ê°€ | Travel Planning</title>

    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/admin_tourspot_add.css}">
</head>

<body>

<div layout:fragment="content">

    <main>
        <!-- ìƒë‹¨ í˜ì´ì§€ ì •ë³´ -->
        <div class="page-header">
            <div class="breadcrumb">
                <a th:href="@{/admin/view/acc}">ìˆ™ì†Œ ê´€ë¦¬</a>
                <span class="separator">â€º</span>
                <span class="current">ìƒˆ ìˆ™ì†Œ ì¶”ê°€</span>
            </div>
            <h2 class="page-title">
                <span class="title-icon">â•</span>
                ìƒˆë¡œìš´ ìˆ™ì†Œ ì¶”ê°€
            </h2>
            <p class="page-desc">ìƒˆë¡œìš´ ìˆ™ì†Œ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ë“±ë¡í•©ë‹ˆë‹¤</p>
        </div>

        <form id="addForm" enctype="multipart/form-data">
            <div class="form-container">

                <!-- ì™¼ìª½ ì…ë ¥ í¼ -->
                <div class="form-section form-left">
                    <div class="section-title">
                        <span class="section-icon">ğŸ“‹</span>
                        ê¸°ë³¸ ì •ë³´
                    </div>

                    <div class="form-group">
                        <label class="form-label required">
                            <span class="label-icon">ğŸ“</span>
                            ìˆ™ì†Œëª…
                        </label>
                        <input type="text"
                               id="title"
                               name="title"
                               class="form-input"
                               placeholder="ì˜ˆ: ë¡¯ë°í˜¸í…” ì„œìš¸"
                               required>
                    </div>

                    <div class="form-group">
                        <label class="form-label required">
                            <span class="label-icon">ğŸ“</span>
                            ì£¼ì†Œ
                        </label>
                        <input type="text"
                               id="address"
                               name="address"
                               class="form-input"
                               placeholder="ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬ ì„ì§€ë¡œ 30"
                               required>
                    </div>

                    <div class="form-group">
                        <label class="form-label"><span class="label-icon">ğŸ“</span>ì „í™”ë²ˆí˜¸</label>
                        <input type="text" id="tel" name="tel" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label"><span class="label-icon">ğŸ“</span>í™ˆí˜ì´ì§€</label>
                        <input type="text" id="homepage" name="homepage" class="form-input">
                    </div>

                    <!-- ì§€ì—­/ì‹œêµ°êµ¬ ì½”ë“œ -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ğŸ·ï¸ ì§€ì—­ ì½”ë“œ</label>
                            <input type="number" id="areacode" name="areacode" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">ğŸ·ï¸ ì‹œêµ°êµ¬ ì½”ë“œ</label>
                            <input type="number" id="sigungucode" name="sigungucode" class="form-input">
                        </div>
                    </div>

                    <!-- ğŸ”¥ ìƒˆë¡œ ì¶”ê°€: ìœ„ë„/ê²½ë„ ì…ë ¥ì¹¸ -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ğŸŒ ìœ„ë„ (Latitude)</label>
                            <input type="text" id="mapy" name="mapy" class="form-input" placeholder="ì˜ˆ: 37.566535">
                        </div>

                        <div class="form-group">
                            <label class="form-label">ğŸŒ ê²½ë„ (Longitude)</label>
                            <input type="text" id="mapx" name="mapx" class="form-input" placeholder="ì˜ˆ: 126.977969">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ”˜ ìƒíƒœ</label>
                        <div class="switch-container">
                            <input type="checkbox" id="status" name="status"
                                   class="switch-input" checked>
                            <label for="status" class="switch-label">
                                <span class="switch-slider"></span>
                            </label>
                            <span class="switch-text">í™œì„±í™”</span>
                        </div>
                    </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½ ì´ë¯¸ì§€ ë° ì„¤ëª… -->
                <div class="form-section form-right">
                    <div class="section-title">
                        <span class="section-icon">ğŸ–¼ï¸</span>
                        ì´ë¯¸ì§€ ë° ì„¤ëª…
                    </div>

                    <div class="image-upload-section">
                        <label class="form-label required">
                            <span class="label-icon">ğŸ“·</span>
                            ëŒ€í‘œ ì´ë¯¸ì§€
                        </label>

                        <div class="image-preview-container">
                            <img id="preview" th:src="@{/images/sample.png}" class="preview-image">
                            <div class="image-placeholder" id="placeholder">
                                <span class="placeholder-icon">ğŸ–¼ï¸</span>
                                <p class="placeholder-text">ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                            </div>
                        </div>

                        <div class="file-input-wrapper">
                            <input type="file"
                                   id="imageInput"
                                   name="imageFile"
                                   class="file-input"
                                   accept="image/*"
                                   onchange="previewImage(event)"
                                   required>
                            <label for="imageInput" class="file-label">
                                ğŸ“ ì´ë¯¸ì§€ ì„ íƒ
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label"><span class="label-icon">ğŸ“„</span> ìƒì„¸ ì„¤ëª…</label>
                        <textarea id="description"
                                  name="description"
                                  class="form-textarea"
                                  placeholder="ìˆ™ì†Œì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    </div>
                </div>

            </div>
        </form>

        <!-- ë²„íŠ¼ -->
        <div class="btn-container">
            <button type="button" class="btn btn-submit" onclick="submitAccAdd()">
                <span class="btn-icon">âœ“</span>ë“±ë¡í•˜ê¸°
            </button>

            <button type="button" class="btn btn-cancel" onclick="confirmCancel()">
                <span class="btn-icon">â†©ï¸</span>ì·¨ì†Œ
            </button>
        </div>

    </main>


    <script>
        /* -----------------------------
         * ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
         * ----------------------------- */
        function previewImage(event) {
            const file = event.target.files[0];
            const preview = document.getElementById("preview");
            const placeholder = document.getElementById("placeholder");

            if (!file) return;

            // 5MB ì œí•œ
            if (file.size > 5 * 1024 * 1024) {
                alert("âš ï¸ íŒŒì¼ í¬ê¸°ê°€ 5MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.");
                event.target.value = "";
                return;
            }

            const reader = new FileReader();
            reader.onload = e => {
                preview.src = e.target.result;
                preview.style.display = "block";
                placeholder.style.display = "none";
            };
            reader.readAsDataURL(file);
        }

        /* -----------------------------
         * ì·¨ì†Œ ë²„íŠ¼
         * ----------------------------- */
        function confirmCancel() {
            if (confirm("ì‘ì„±ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                history.back();
            }
        }

        /* -----------------------------
         * ìˆ™ì†Œ ë“±ë¡ ìš”ì²­
         * ----------------------------- */
        async function submitAccAdd() {

            console.log("===== ğŸ¨ submitAccAdd() í˜¸ì¶œë¨ =====");

            const title = document.getElementById("title").value.trim();
            const address = document.getElementById("address").value.trim();
            const tel = document.getElementById("tel").value.trim();
            const homepage = document.getElementById("homepage").value.trim();
            const areacode = document.getElementById("areacode").value.trim();
            const sigungucode = document.getElementById("sigungucode").value.trim();
            const description = document.getElementById("description").value.trim();
            const mapx = document.getElementById("mapx").value.trim();
            const mapy = document.getElementById("mapy").value.trim();
            const status = document.getElementById("status").checked ? "Y" : "N";
            const imageFile = document.getElementById("imageInput").files[0];


            // ---- í•„ìˆ˜ê°’ ê²€ì‚¬ ----
            if (!title) {
                console.warn("â›” title ëˆ„ë½");
                alert("âš ï¸ ìˆ™ì†Œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            if (!address) {
                console.warn("â›” address ëˆ„ë½");
                alert("âš ï¸ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            if (!imageFile) {
                console.warn("â›” imageFile ëˆ„ë½");
                alert("âš ï¸ ëŒ€í‘œ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            if (!mapx) {
                console.warn("â›” mapx ëˆ„ë½");
                alert("âš ï¸ mapxë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            if (!mapy) {
                console.warn("â›” mapy ëˆ„ë½");
                alert("âš ï¸ mapyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            // ---- FormData êµ¬ì„± ----
            const formData = new FormData();
            formData.append("catCode", "acc");
            formData.append("title", title);
            formData.append("address", address);
            formData.append("tel", tel);
            formData.append("homepage", homepage);
            formData.append("areacode", areacode);
            formData.append("sigungucode", sigungucode);
            formData.append("mapy", mapy);
            formData.append("mapx", mapx);
            formData.append("description", description);
            formData.append("status", status);
            formData.append("imageFile", imageFile);

            console.log("===== ğŸ“¦ FormData ìµœì¢… ë‚´ìš© =====");

            for (let pair of formData.entries()) {
                console.log(pair[0] + ":", pair[1]);
            }

            // ---- ë²„íŠ¼ ìƒíƒœ ë³€ê²½ ----
            const btn = document.querySelector(".btn-submit");
            const original = btn.innerHTML;
            btn.innerHTML = "ë“±ë¡ ì¤‘...";
            btn.disabled = true;

            // ---- ì„œë²„ ìš”ì²­ ----
            console.log("ğŸš€ ì„œë²„ì— ë“±ë¡ ìš”ì²­ ì „ì†¡ /admin/accommodations/regist");

            try {
                const res = await fetchWithRefresh("/admin/accommodations/regist", {
                    method: "POST",
                    body: formData,
                    credentials: "include",
                    headers: {}
                });

                console.log("ğŸ“¥ ì„œë²„ ì‘ë‹µ ì½”ë“œ:", res.status);

                if (res.ok) {
                    alert("âœ… ìˆ™ì†Œê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    location.href = "/admin/view/acc";
                } else {
                    const msg = await res.text();
                    console.error("âŒ ë“±ë¡ ì‹¤íŒ¨:", msg);
                    alert("âŒ ë“±ë¡ ì‹¤íŒ¨: " + msg);

                    btn.innerHTML = original;
                    btn.disabled = false;
                }

            } catch (err) {
                console.error("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", err);
                alert("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + err.message);

                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        /* ìŠ¤ìœ„ì¹˜ í…ìŠ¤íŠ¸ ë³€ê²½ */
        document.getElementById("status").addEventListener("change", function () {
            document.querySelector(".switch-text").textContent =
                this.checked ? "í™œì„±í™”" : "ë¹„í™œì„±í™”";
        });
    </script>
</div>

</body>

</html>
