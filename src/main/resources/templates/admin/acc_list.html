<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="ko"
      layout:decorate="~{/common/layout}">

<head layout:fragment="head">
    <meta charset="UTF-8">
    <title>ìˆ™ì†Œ ê´€ë¦¬ | Travel Planning</title>

    <!-- admin ê³µí†µ -->
    <link rel="stylesheet" th:href="@{/css/admin_acc.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/admin_tourspot.css}">

</head>

<body>

<div layout:fragment="content">

    <main>
        <div class="admin-container">

            <!-- â­ ì‚¬ì´ë“œë°” -->
            <aside class="admin-sidebar">
                <div class="sidebar-header">
                    <h2 class="admin-title">ìˆ™ì†Œ ê´€ë¦¬</h2>
                    <p class="admin-sub">ë“±ë¡ëœ ìˆ™ì†Œë¥¼ ê´€ë¦¬í•˜ê³  ìƒˆë¡œìš´ ìˆ™ì†Œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤</p>
                </div>

                <div class="stats-card">
                    <div class="stat-item">
                        <span class="stat-label">ì „ì²´ ìˆ™ì†Œ</span>
                        <span class="stat-value" id="totalAccs">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">í™œì„± ìˆ™ì†Œ</span>
                        <span class="stat-value active" id="activeAccs">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ë¹„í™œì„± ìˆ™ì†Œ</span>
                        <span class="stat-value inactive" id="inactiveAccs">-</span>
                    </div>
                </div>

                <button class="btn-add-acc" onclick="location.href='/admin/view/acc/add'">
                    <span class="add-icon">â•</span>
                    <span>ìˆ™ì†Œ ì¶”ê°€í•˜ê¸°</span>
                </button>
            </aside>

            <!-- â­ ë©”ì¸ ì½˜í…ì¸  -->
            <section class="admin-content">

                <!-- ê²€ìƒ‰ì°½ -->
                <div class="search-container">
                    <div class="search-box">
                        <input type="text"
                               id="searchInput"
                               placeholder="ğŸ” ìˆ™ì†Œ ì œëª©ìœ¼ë¡œ ê²€ìƒ‰..."
                               onkeydown="if(event.key==='Enter') loadAccs(0);">

                        <button class="btn btn-search" onclick="loadAccs(0)">ê²€ìƒ‰</button>
                        <button class="btn btn-reset" onclick="resetSearch()">ì „ì²´ ë³´ê¸°</button>
                    </div>
                </div>

                <!-- ìˆ™ì†Œ í…Œì´ë¸” -->
                <div class="table-container">
                    <table>
                        <thead>
                        <tr>
                            <th width="60">ë²ˆí˜¸</th>
                            <th width="100">ëŒ€í‘œ ì´ë¯¸ì§€</th>
                            <th width="200">ì œëª©</th>
                            <th width="250">ì£¼ì†Œ</th>
                            <th width="80">ì¶”ì²œ ìˆ˜</th>
                            <th width="80">ìƒíƒœ</th>
                            <th width="120">ê´€ë¦¬</th>
                        </tr>
                        </thead>
                        <tbody id="accTableBody"></tbody>
                    </table>
                </div>

                <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
                <div id="pagination" class="pagination"></div>

            </section>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Travel Planning. All rights reserved.</p>
    </footer>

    <!-- JS -->
    <script>
        let currentPage = 0;
        const API_URL = "/accommodations/list";

        window.onload = () => loadAccs(0);

        function loadAccs(page) {
            currentPage = page;
            const keyword = document.getElementById("searchInput").value.trim();
            const query = `?page=${page}&keyword=${encodeURIComponent(keyword)}`;

            fetch(API_URL + query)
                .then(res => res.json())
                .then(result => {
                    if (!result?.data) return;

                    const {contents, totalPages} = result.data;

                    renderTable(contents);
                    renderPagination(totalPages);
                    updateStats(contents);
                });
        }

        function renderTable(list) {
            const tbody = document.getElementById("accTableBody");
            tbody.innerHTML = "";

            if (!list.length) {
                tbody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="7">
                            <div class="empty-state">
                                <span class="empty-icon">ğŸ›ï¸</span>
                                <p>ë“±ë¡ëœ ìˆ™ì†Œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            list.forEach((acc, idx) => {
                const img = acc.firstImage || "/images/no-image.png";

                tbody.innerHTML += `
                    <tr class="clickable-row" onclick="location.href='/admin/view/acc/edit/${acc.id}'">
                        <td class="text-center">${idx + 1}</td>
                        <td class="text-center"><img src="${img}" class="tourspot-thumbnail"></td>
                        <td>${acc.title}</td>
                        <td>${acc.address}</td>
                        <td class="text-center">
                            <span class="rec-count" th:text="${acc.recCount}">0</span>
                        </td>
                        <td class="text-center">
                            <span class="status-badge ${acc.status === 'Y' ? 'status-active' : 'status-inactive'}">
                                ${acc.status === 'Y' ? 'âœ“ í™œì„±' : 'âœ— ë¹„í™œì„±'}
                            </span>
                        </td>
                        <td class="text-center">
                            ${acc.status === 'Y'
                    ? `<button class="btn-action btn-deactivate" onclick="event.stopPropagation(); toggleAccStatus(${acc.id}, 'N')">ë¹„í™œì„±í™”</button>`
                    : `<button class="btn-action btn-activate" onclick="event.stopPropagation(); toggleAccStatus(${acc.id}, 'Y')">ë³µêµ¬</button>`
                }
                        </td>
                    </tr>`;
            });
        }

        function renderPagination(totalPages) {
            const container = document.getElementById("pagination");
            container.innerHTML = "";
            if (totalPages <= 1) return;

            let start = Math.max(0, currentPage - 2);
            let end = Math.min(totalPages, start + 10);

            // ì´ì „ ë²„íŠ¼
            if (currentPage > 0) {
                container.innerHTML += `
            <a class="page-btn prev-btn" onclick="loadAccs(${currentPage - 1})">â€¹ ì´ì „</a>`;
            }

            // í‘œì‹œí•  í˜ì´ì§€ ë²ˆí˜¸(ìµœëŒ€ 5ê°œ)
            for (let i = start; i < end; i++) {
                container.innerHTML += `
            <a class="page-number ${i === currentPage ? 'active' : ''}"
               onclick="loadAccs(${i})">${i + 1}</a>`;
            }

            // ë‹¤ìŒ ë²„íŠ¼
            if (currentPage + 1 < totalPages) {
                container.innerHTML += `
            <a class="page-btn next-btn" onclick="loadAccs(${currentPage + 1})">ë‹¤ìŒ â€º</a>`;
            }
        }


        function updateStats(list) {
            const total = list.length;
            const active = list.filter(a => a.status === 'Y').length;

            document.getElementById("totalAccs").textContent = total;
            document.getElementById("activeAccs").textContent = active;
            document.getElementById("inactiveAccs").textContent = total - active;
        }

        function resetSearch() {
            document.getElementById("searchInput").value = "";
            loadAccs(0);
        }

        function toggleAccStatus(id, status) {
            const msg = status === 'N'
                ? "í•´ë‹¹ ìˆ™ì†Œë¥¼ ë¹„í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
                : "í•´ë‹¹ ìˆ™ì†Œë¥¼ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";

            if (!confirm(msg)) return;

            fetchWithRefresh(`/admin/accommodations/update?id=${id}&status=${status}`, {method: "PUT"})
                .then(res => {
                    if (res.ok) {
                        alert("ë³€ê²½ ì™„ë£Œ!");
                        loadAccs(currentPage);
                    }
                });
        }
    </script>

</div>

</body>
</html>
