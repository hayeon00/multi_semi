<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìˆ™ì†Œ ê´€ë¦¬ | Travel Planing</title>
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/admin_acc.css}">
</head>

<body>
<header>
    <div class="header-left">
        <img th:src="@{/images/logo.png}" alt="Logo">
        <div class="title">TRAVEL PLANING</div>
    </div>
    <div class="header-right">
        <div class="welcome-text">
            <span class="admin-badge">ê´€ë¦¬ì</span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.
        </div>
        <nav class="nav">
            <a th:href="@{/spots/view/tourspotlist}" class="nav-link">
                <span class="nav-icon">ğŸ </span>
                <span>í™ˆ</span>
            </a>
            <a th:href="@{/admin/view/adminpage}" class="nav-link active">
                <span class="nav-icon">ğŸ“Š</span>
                <span>ëŒ€ì‹œë³´ë“œ</span>
            </a>
            <a th:href="@{/admin/view/members}" class="nav-link">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>íšŒì›ê´€ë¦¬</span>
            </a>
            <a th:href="@{/admin/view/tourspot}" class="nav-link">
                <span class="nav-icon">ğŸ—ºï¸</span>
                <span>ê´€ê´‘ì§€ê´€ë¦¬</span>
            </a>
            <a th:href="@{/admin/view/acc}" class="nav-link">
                <span class="nav-icon">ğŸ¨</span>
                <span>ìˆ™ì†Œê´€ë¦¬</span>
            </a>
            <a th:href="@{/login}" class="nav-link logout">
                <span class="nav-icon">ğŸšª</span>
                <span>ë¡œê·¸ì•„ì›ƒ</span>
            </a>
        </nav>
    </div>
</header>

<main>
    <div class="admin-container">
        <!-- â­ ì‚¬ì´ë“œë°” -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <h2 class="admin-title">ìˆ™ì†Œ ê´€ë¦¬</h2>
                <p class="admin-sub">ë“±ë¡ëœ ìˆ™ì†Œë¥¼ ê´€ë¦¬í•˜ê³  ìƒˆë¡œìš´ ìˆ™ì†Œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤</p>
            </div>

            <div class="stats-card">
                <div class="stat-item">
                    <span class="stat-label">ì „ì²´ ìˆ™ì†Œ</span>
                    <span class="stat-value" id="totalAccs">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">í™œì„± ìˆ™ì†Œ</span>
                    <span class="stat-value active" id="activeAccs">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ë¹„í™œì„± ìˆ™ì†Œ</span>
                    <span class="stat-value inactive" id="inactiveAccs">-</span>
                </div>
            </div>

            <button class="btn-add-acc" onclick="location.href='/admin/view/acc/add'">
                <span class="add-icon">â•</span>
                <span>ìˆ™ì†Œ ì¶”ê°€í•˜ê¸°</span>
            </button>
        </aside>

        <!-- â­ ë©”ì¸ ì½˜í…ì¸  -->
        <section class="admin-content">
            <!-- ê²€ìƒ‰ì°½ -->
            <div class="search-container">
                <div class="search-box">
                    <input type="text"
                           id="searchInput"
                           placeholder="ğŸ” ìˆ™ì†Œ ì œëª©ìœ¼ë¡œ ê²€ìƒ‰..."
                           onkeydown="if(event.key==='Enter') loadAccs(0);">

                    <button class="btn btn-search" onclick="loadAccs(0)">ê²€ìƒ‰</button>
                    <button class="btn btn-reset" onclick="resetSearch()">ì „ì²´ ë³´ê¸°</button>
                </div>
            </div>

            <!-- ìˆ™ì†Œ í…Œì´ë¸” -->
            <div class="table-container">
                <table id="accTable">
                    <thead>
                    <tr>
                        <th width="60">ë²ˆí˜¸</th>
                        <th width="100">ëŒ€í‘œ ì´ë¯¸ì§€</th>
                        <th width="200">ì œëª©</th>
                        <th width="250">ì£¼ì†Œ</th>
                        <th width="80">ì¶”ì²œ ìˆ˜</th>
                        <th width="80">ìƒíƒœ</th>
                        <th width="120">ê´€ë¦¬</th>
                    </tr>
                    </thead>
                    <tbody id="accTableBody"></tbody>
                </table>
            </div>

            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div id="pagination" class="pagination"></div>
        </section>
    </div>
</main>

<footer>
    <p>&copy; 2025 Travel Planing. All rights reserved.</p>
</footer>

<script th:src="@{/js/common.js}"></script>

<script>
    let currentPage = 0;
    const API_URL = "/accommodations/list";

    window.onload = () => loadAccs(0);

    async function loadAccs(page) {
        currentPage = page;
        const keyword = document.getElementById("searchInput").value.trim();
        const query = `?page=${page}&keyword=${encodeURIComponent(keyword)}`;

        try {
            const response = await fetchWithRefresh(API_URL + query, {
                method: "GET",
                headers: { "Content-Type": "application/json" },
                credentials: "include"
            });

            if (!response.ok) {
                alert("ìˆ™ì†Œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                return;
            }

            const result = await response.json();
            if (!result?.data) return;

            const {contents, totalPages} = result.data;

            renderTable(contents);
            renderPagination(totalPages);
            updateStats(contents);
        } catch (error) {
            console.error("ğŸš¨ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    }

    function renderTable(list) {
        const tbody = document.getElementById("accTableBody");
        tbody.innerHTML = "";

        if (!list || list.length === 0) {
            tbody.innerHTML = `
                <tr class="empty-row">
                    <td colspan="7">
                        <div class="empty-state">
                            <span class="empty-icon">ğŸ¨</span>
                            <p>ë“±ë¡ëœ ìˆ™ì†Œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        </div>
                    </td>
                </tr>`;
            return;
        }

        list.forEach((acc, idx) => {
            const img = acc.firstImage || "/images/no-image.png";
            const tr = document.createElement("tr");
            tr.classList.add("clickable-row");
            tr.onclick = () => location.href = `/admin/view/acc/edit/${acc.id}`;

            tr.innerHTML = `
                <td class="text-center">${idx + 1}</td>
                <td class="text-center">
                    <img src="${img}"
                         alt="ìˆ™ì†Œ ì´ë¯¸ì§€"
                         class="tourspot-thumbnail"
                         onerror="this.onerror=null; this.src='/images/no-image.png'">
                </td>
                <td class="tourspot-title">${acc.title}</td>
                <td class="tourspot-address">${acc.address}</td>
                <td class="text-center">
                    <span class="rec-count">${acc.recCount || 0}</span>
                </td>
                <td class="text-center">
                    <span class="status-badge ${acc.status === 'Y' ? 'status-active' : 'status-inactive'}">
                        ${acc.status === 'Y' ? 'âœ“ í™œì„±' : 'âœ— ë¹„í™œì„±'}
                    </span>
                </td>
                <td class="text-center">
                    ${acc.status === 'Y'
                ? `<button class="btn-action btn-deactivate"
                                   onclick="event.stopPropagation(); toggleAccStatus(${acc.id}, 'N')">
                               <span>ë¹„í™œì„±í™”</span>
                           </button>`
                : `<button class="btn-action btn-activate"
                                   onclick="event.stopPropagation(); toggleAccStatus(${acc.id}, 'Y')">
                               <span>ë³µêµ¬</span>
                           </button>`
            }
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderPagination(totalPages) {
        const container = document.getElementById("pagination");
        container.innerHTML = "";
        if (totalPages <= 1) return;

        const maxVisible = 10;
        let start = Math.max(0, currentPage - Math.floor(maxVisible / 2));
        let end = Math.min(totalPages, start + maxVisible);

        // start ì¬ì¡°ì • (ëì— ë„ë‹¬í–ˆì„ ë•Œ)
        if (end - start < maxVisible) {
            start = Math.max(0, end - maxVisible);
        }

        // ì´ì „ ë²„íŠ¼
        if (currentPage > 0) {
            const prevBtn = document.createElement("a");
            prevBtn.className = "page-btn prev-btn";
            prevBtn.textContent = "â€¹ ì´ì „";
            prevBtn.onclick = () => loadAccs(currentPage - 1);
            container.appendChild(prevBtn);
        }

        // í˜ì´ì§€ ë²ˆí˜¸ë“¤
        for (let i = start; i < end; i++) {
            const pageLink = document.createElement("a");
            pageLink.className = `page-number ${i === currentPage ? 'active' : ''}`;
            pageLink.textContent = i + 1;
            pageLink.onclick = () => loadAccs(i);
            container.appendChild(pageLink);
        }

        // ë‹¤ìŒ ë²„íŠ¼
        if (currentPage + 1 < totalPages) {
            const nextBtn = document.createElement("a");
            nextBtn.className = "page-btn next-btn";
            nextBtn.textContent = "ë‹¤ìŒ â€º";
            nextBtn.onclick = () => loadAccs(currentPage + 1);
            container.appendChild(nextBtn);
        }
    }

    function updateStats(list) {
        const total = list.length;
        const active = list.filter(a => a.status === 'Y').length;

        document.getElementById("totalAccs").textContent = total;
        document.getElementById("activeAccs").textContent = active;
        document.getElementById("inactiveAccs").textContent = total - active;
    }

    function resetSearch() {
        document.getElementById("searchInput").value = "";
        loadAccs(0);
    }

    async function toggleAccStatus(id, status) {
        const msg = status === 'N'
            ? "í•´ë‹¹ ìˆ™ì†Œë¥¼ ë¹„í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
            : "í•´ë‹¹ ìˆ™ì†Œë¥¼ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";

        if (!confirm(msg)) return;

        try {
            const response = await fetchWithRefresh(`/admin/accommodations/update?id=${id}&status=${status}`, {
                method: "PUT",
                credentials: "include"
            });

            if (response.ok) {
                alert("âœ“ ë³€ê²½ ì™„ë£Œ!");
                loadAccs(currentPage);
            } else {
                alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        } catch (error) {
            console.error("ğŸš¨ ì˜¤ë¥˜:", error);
            alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }
</script>

</body>
</html>