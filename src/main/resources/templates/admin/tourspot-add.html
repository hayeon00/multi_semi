<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê´€ê´‘ì§€ ì¶”ê°€ | Travel Planning</title>
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/admin_tourspot_add.css}">
</head>

<body>
<script th:src="@{/js/common.js}"></script>

<header>
    <div class="header-left">
        <img th:src="@{/images/logo.png}" alt="Logo">
        <div class="title">TRAVEL PLANNING</div>
    </div>
    <div class="header-right">
        <div class="welcome-text">
            <span class="admin-badge">ê´€ë¦¬ì</span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.
        </div>
        <nav class="nav">
            <a th:href="@{/spots/view/tourspotlist}" class="nav-link">
                <span class="nav-icon">ğŸ </span>
                <span>í™ˆ</span>
            </a>
            <a th:href="@{/admin/view/adminpage}" class="nav-link active">
                <span class="nav-icon">ğŸ“Š</span>
                <span>ëŒ€ì‹œë³´ë“œ</span>
            </a>
            <a th:href="@{/admin/view/members}" class="nav-link">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>íšŒì›ê´€ë¦¬</span>
            </a>
            <a th:href="@{/admin/view/tourspot}" class="nav-link">
                <span class="nav-icon">ğŸ—ºï¸</span>
                <span>ê´€ê´‘ì§€ê´€ë¦¬</span>
            </a>
            <a th:href="@{/admin/view/acc}" class="nav-link">
                <span class="nav-icon">ğŸ¨</span>
                <span>ìˆ™ì†Œê´€ë¦¬</span>
            </a>
            <a href="javascript:void(0);" class="nav-link logout" onclick="handleLogout()">
                <span class="nav-icon">ğŸšª</span>
                <span>ë¡œê·¸ì•„ì›ƒ</span>
            </a>
        </nav>
    </div>
</header>

<main>
    <div class="page-header">
        <div class="breadcrumb">
            <a th:href="@{/admin/view/tourspot}">ê´€ê´‘ì§€ ê´€ë¦¬</a>
            <span class="separator">â€º</span>
            <span class="current">ìƒˆ ê´€ê´‘ì§€ ì¶”ê°€</span>
        </div>
        <h2 class="page-title">
            <span class="title-icon">â•</span>
            ìƒˆë¡œìš´ ê´€ê´‘ì§€ ì¶”ê°€
        </h2>
        <p class="page-desc">ìƒˆë¡œìš´ ê´€ê´‘ì§€ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ë“±ë¡í•©ë‹ˆë‹¤</p>
    </div>

    <form id="addForm" enctype="multipart/form-data">
        <div class="form-container">
            <!-- ì™¼ìª½ ì…ë ¥ í¼ -->
            <div class="form-section form-left">
                <div class="section-title">
                    <span class="section-icon">ğŸ“‹</span>
                    ê¸°ë³¸ ì •ë³´
                </div>

                <div class="form-group">
                    <label class="form-label required">
                        <span class="label-icon">ğŸ“</span>
                        ê´€ê´‘ì§€ ì œëª©
                    </label>
                    <input type="text"
                           id="title"
                           name="title"
                           class="form-input"
                           placeholder="ì˜ˆ: ê²½ë³µê¶"
                           required>
                </div>

                <div class="form-group">
                    <label class="form-label required">
                        <span class="label-icon">ğŸ“</span>
                        ì£¼ì†Œ
                    </label>
                    <input type="text"
                           id="address"
                           name="address"
                           class="form-input"
                           placeholder="ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ ì¢…ë¡œêµ¬ ì‚¬ì§ë¡œ 161"
                           required>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">ğŸ“</span>
                        ì „í™”ë²ˆí˜¸
                    </label>
                    <input type="text"
                           id="tel"
                           name="tel"
                           class="form-input"
                           placeholder="ì˜ˆ: 02-3700-3900">
                </div>

                <!-- âœ… í™ˆí˜ì´ì§€ í•„ë“œ ì¶”ê°€ -->
                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">ğŸ”—</span>
                        í™ˆí˜ì´ì§€
                    </label>
                    <input type="url"
                           id="homepage"
                           name="homepage"
                           class="form-input"
                           placeholder="ì˜ˆ: https://www.royalpalace.go.kr">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">
                            <span class="label-icon">ğŸ·ï¸</span>
                            ì§€ì—­ ì½”ë“œ
                        </label>
                        <input type="text"
                               id="areacode"
                               name="areacode"
                               class="form-input"
                               placeholder="ì˜ˆ: 1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="label-icon">ğŸ·ï¸</span>
                            ì‹œêµ°êµ¬ ì½”ë“œ
                        </label>
                        <input type="text"
                               id="sigungucode"
                               name="sigungucode"
                               class="form-input"
                               placeholder="ì˜ˆ: 1">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">
                            <span class="label-icon">ğŸŒ</span>
                            ìœ„ë„ (Latitude)
                        </label>
                        <input type="text" id="mapy" name="mapy" class="form-input" placeholder="ì˜ˆ: 37.566535">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="label-icon">ğŸŒ</span>
                            ê²½ë„ (Longitude)
                        </label>
                        <input type="text" id="mapx" name="mapx" class="form-input" placeholder="ì˜ˆ: 126.977969">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">ğŸ”¢</span>
                        í–‰ì •ë™ ì½”ë“œ
                    </label>
                    <input type="text"
                           id="lDongRegnCd"
                           name="lDongRegnCd"
                           class="form-input"
                           placeholder="ì˜ˆ: 1111011700">
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">ğŸ”˜</span>
                        ìƒíƒœ
                    </label>
                    <div class="switch-container">
                        <input type="checkbox"
                               id="status"
                               name="status"
                               class="switch-input"
                               checked>
                        <label for="status" class="switch-label">
                            <span class="switch-slider"></span>
                        </label>
                        <span class="switch-text">í™œì„±í™”</span>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½ ì´ë¯¸ì§€ ë° ì„¤ëª… ì˜ì—­ -->
            <div class="form-section form-right">
                <div class="section-title">
                    <span class="section-icon">ğŸ–¼ï¸</span>
                    ì´ë¯¸ì§€ ë° ì„¤ëª…
                </div>

                <div class="image-upload-section">
                    <label class="form-label required">
                        <span class="label-icon">ğŸ“·</span>
                        ëŒ€í‘œ ì´ë¯¸ì§€
                    </label>

                    <div class="image-preview-container">
                        <img id="preview"
                             th:src="@{/images/sample.png}"
                             alt="ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€"
                             class="preview-image">
                        <div class="image-placeholder" id="placeholder">
                            <span class="placeholder-icon">ğŸ–¼ï¸</span>
                            <p class="placeholder-text">ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                        </div>
                    </div>

                    <div class="file-input-wrapper">
                        <input type="file"
                               id="imageInput"
                               name="firstImageFile"
                               class="file-input"
                               accept="image/*"
                               onchange="previewImage(event)"
                               required>
                        <label for="imageInput" class="file-label">
                            <span class="file-icon">ğŸ“</span>
                            <span class="file-text">ì´ë¯¸ì§€ ì„ íƒí•˜ê¸°</span>
                        </label>
                    </div>

                    <div class="image-info">
                        <p class="info-text">
                            <span class="info-icon">â„¹ï¸</span>
                            ê¶Œì¥ í¬ê¸°: 800x600px ì´ìƒ
                        </p>
                        <p class="info-text">
                            <span class="info-icon">â„¹ï¸</span>
                            ìµœëŒ€ í¬ê¸°: 5MB
                        </p>
                        <p class="info-text">
                            <span class="info-icon">â„¹ï¸</span>
                            ì§€ì› í˜•ì‹: JPG, PNG, WEBP
                        </p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">ğŸ“„</span>
                        ìƒì„¸ ì„¤ëª…
                    </label>
                    <textarea id="description"
                              name="description"
                              class="form-textarea"
                              placeholder="ê´€ê´‘ì§€ì— ëŒ€í•œ ìƒì„¸í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”&#10;&#10;ì˜ˆ: ê²½ë³µê¶ì€ ì¡°ì„ ì™•ì¡°ì˜ ë²•ê¶ì´ì ëŒ€í‘œì ì¸ ê¶ê¶ë¡œ..."></textarea>
                </div>
            </div>
        </div>
    </form>

    <!-- í•˜ë‹¨ ë²„íŠ¼ -->
    <div class="btn-container">
        <button type="button" class="btn btn-submit" onclick="submitAdd()">
            <span class="btn-icon">âœ“</span>
            <span>ë“±ë¡í•˜ê¸°</span>
        </button>
        <button type="button" class="btn btn-cancel" onclick="confirmCancel()">
            <span class="btn-icon">â†©ï¸</span>
            <span>ì·¨ì†Œ</span>
        </button>
    </div>
</main>

<footer>
    <p>&copy; 2025 Travel Planning. All rights reserved.</p>
</footer>

<script>
    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
    function previewImage(event) {
        const file = event.target.files[0];
        const preview = document.getElementById("preview");
        const placeholder = document.getElementById("placeholder");

        if (!file) return;

        // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('âš ï¸ íŒŒì¼ í¬ê¸°ê°€ 5MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.');
            event.target.value = '';
            return;
        }

        // íŒŒì¼ íƒ€ì… ì²´í¬
        if (!file.type.startsWith('image/')) {
            alert('âš ï¸ ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            event.target.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = e => {
            preview.src = e.target.result;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
        };
        reader.readAsDataURL(file);
    }

    // ì·¨ì†Œ í™•ì¸
    function confirmCancel() {
        if (confirm('ì‘ì„±ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì…ë ¥í•œ ë‚´ìš©ì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')) {
            window.history.back();
        }
    }

    // ê´€ê´‘ì§€ ë“±ë¡
    async function submitAdd() {
        // í•„ìˆ˜ í•„ë“œ ê²€ì¦
        const title = document.getElementById("title").value.trim();
        const address = document.getElementById("address").value.trim();
        const imageFile = document.getElementById("imageInput").files[0];

        if (!title) {
            alert('âš ï¸ ê´€ê´‘ì§€ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            document.getElementById("title").focus();
            return;
        }

        if (!address) {
            alert('âš ï¸ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            document.getElementById("address").focus();
            return;
        }

        if (!imageFile) {
            alert('âš ï¸ ëŒ€í‘œ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            document.getElementById("imageInput").focus();
            return;
        }

        const formData = new FormData();
        formData.append("title", title);
        formData.append("description", document.getElementById("description").value.trim());
        formData.append("address", address);
        formData.append("tel", document.getElementById("tel").value.trim());
        formData.append("homepage", document.getElementById("homepage").value.trim()); // âœ… ì¶”ê°€
        formData.append("areacode", document.getElementById("areacode").value.trim());
        formData.append("sigungucode", document.getElementById("sigungucode").value.trim());
        formData.append("mapy", document.getElementById("mapy").value.trim());
        formData.append("mapx", document.getElementById("mapx").value.trim());
        formData.append("lDongRegnCd", document.getElementById("lDongRegnCd").value.trim());
        formData.append("status", document.getElementById("status").checked ? "Y" : "N");
        formData.append("firstImageFile", imageFile);

        // ë¡œë”© í‘œì‹œ
        const submitBtn = document.querySelector('.btn-submit');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span>ë“±ë¡ ì¤‘...</span>';
        submitBtn.disabled = true;

        try {
            const res = await fetchWithRefresh("/admin/tourspot", {
                method: "POST",
                body: formData,
                credentials: "include",
                headers: {}
            });

            if (res.ok) {
                alert("âœ… ê´€ê´‘ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                location.href = "/admin/view/tourspot";
            } else {
                const msg = await res.text();
                alert("âŒ ë“±ë¡ ì‹¤íŒ¨: " + msg);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        } catch (err) {
            console.error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", err);
            alert("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    // í˜ì´ì§€ ë‚˜ê°ˆ ë•Œ ê²½ê³ 
    let formChanged = false;
    document.querySelectorAll('input, textarea').forEach(element => {
        element.addEventListener('input', () => {
            formChanged = true;
        });
    });

    window.addEventListener('beforeunload', (e) => {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // ìŠ¤ìœ„ì¹˜ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    document.getElementById('status').addEventListener('change', function() {
        const switchText = document.querySelector('.switch-text');
        switchText.textContent = this.checked ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”';
    });

    async function handleLogout() {
        try {
            const response = await fetch('/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (response.ok) {
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/login';
            } else {
                const result = await response.json();
                alert(result.message || 'ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
            alert('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
</script>
</body>
</html>