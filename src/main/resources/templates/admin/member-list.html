<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íšŒì› ê´€ë¦¬ | Travel Planing</title>
    <link th:href="@{/css/admin.css}" rel="stylesheet">
</head>
<body>
<header>
    <div class="logo">
        <img th:src="@{/images/logo.png}" alt="Logo">
        <span class="title">TRAVEL PLANING</span>
    </div>

    <nav class="admin-nav">
        <div class="welcome-text">ê´€ë¦¬ì ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.</div>
        <div class="menu-links">
            <a th:href="@{/}">Home</a>
            <a th:href="@{/mypage}">ê´€ë¦¬ìí˜ì´ì§€</a>
            <a th:href="@{/logout}">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </nav>
</header>

<main>
    <div class="admin-container">
        <aside class="admin-sidebar">
            <h2 class="admin-title">íšŒì› ê´€ë¦¬</h2>
            <p class="admin-sub">ê´€ë¦¬ì ì „ìš© í˜ì´ì§€ì…ë‹ˆë‹¤.</p>
        </aside>

        <section class="admin-content">

            <!-- âœ… ê²€ìƒ‰ ì˜ì—­ -->
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ì•„ì´ë””ë¡œ ê²€ìƒ‰..." onkeydown="if(event.key==='Enter') searchMember();" />
                <button class="btn-search" onclick="searchMember()">ê²€ìƒ‰</button>
                <button class="btn-reset" onclick="loadMembers()">ì „ì²´ ë³´ê¸°</button>
            </div>

            <table id="memberTable" border="1" cellpadding="10">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>ì•„ì´ë””</th>
                    <th>ì´ë¦„</th>
                    <th>ì´ë©”ì¼</th>
                    <th>ì „í™”ë²ˆí˜¸</th>
                    <th>ê¶Œí•œ</th>
                    <th>ìƒíƒœ</th>
                    <th>ê´€ë¦¬</th>
                </tr>
                </thead>
                <tbody>
                <!-- JSë¡œ ì±„ì›€ -->
                </tbody>
            </table>
        </section>
    </div>
</main>

<footer>
    &copy; 2025 Travel Planing. All rights reserved.
</footer>

<script th:src="@{/js/common.js}"></script>

<script>
    // âœ… íšŒì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadMembers() {
        try {
            const response = await fetchWithRefresh("/admin/members", {
                method: "GET",
                headers: { "Content-Type": "application/json" },
                credentials: "include"
            });

            if (!response.ok) {
                alert("íšŒì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ê¶Œí•œ ë˜ëŠ” í† í° í™•ì¸)");
                return;
            }

            const result = await response.json();
            renderMembers(result.data);
        } catch (error) {
            console.error("ğŸš¨ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    }

    // âœ… íšŒì› ëª©ë¡ ë Œë”ë§
    function renderMembers(members) {
        const tbody = document.querySelector("#memberTable tbody");
        tbody.innerHTML = "";

        if (!members || members.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">ì¡°íšŒëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            return;
        }

        members.forEach(member => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${member.id}</td>
                <td>${member.loginId}</td>
                <td>${member.username}</td>
                <td>${member.email}</td>
                <td>${member.tel}</td>
                <td>${member.role}</td>
                <td>${member.status}</td>
                <td>
                    ${
                member.status === "Y"
                    ? `<button class="btn-action btn-deactivate" onclick="deactivateMember(${member.id})">ğŸ—‘ ë¹„í™œì„±í™”</button>`
                    : `<button class="btn-action btn-activate" onclick="activateMember(${member.id})">ğŸ”„ ë³µêµ¬</button>`
            }
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // âœ… ì•„ì´ë””ë¡œ íšŒì› ê²€ìƒ‰
    async function searchMember() {
        const keyword = document.getElementById("searchInput").value.trim();
        if (!keyword) {
            alert("ê²€ìƒ‰í•  ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        try {
            const response = await fetchWithRefresh(`/admin/members?loginId=${encodeURIComponent(keyword)}`, {
                method: "GET",
                headers: { "Content-Type": "application/json" },
                credentials: "include"
            });

            if (!response.ok) {
                alert("ê²€ìƒ‰ ì‹¤íŒ¨ âŒ (ê¶Œí•œ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜)");
                return;
            }

            const result = await response.json();
            const members = Array.isArray(result.data) ? result.data : [result.data];
            renderMembers(members);
        } catch (error) {
            console.error("ğŸš¨ ê²€ìƒ‰ ì˜¤ë¥˜:", error);
            alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // âœ… íšŒì› ë¹„í™œì„±í™” (Y â†’ N)
    async function deactivateMember(id) {
        if (!confirm("ì •ë§ë¡œ ì´ íšŒì›ì„ ë¹„í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const response = await fetchWithRefresh(`/admin/members/${id}/deactivate`, {
            method: "PUT",
            credentials: "include"
        });

        if (response.ok) {
            alert("íšŒì›ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadMembers();
        } else {
            alert("ë¹„í™œì„±í™” ì‹¤íŒ¨ âŒ (ê¶Œí•œ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜)");
        }
    }

    // âœ… íšŒì› ë³µêµ¬ (N â†’ Y)
    async function activateMember(id) {
        if (!confirm("ì´ íšŒì›ì„ ë‹¤ì‹œ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const response = await fetchWithRefresh(`/admin/members/${id}/activate`, {
            method: "PUT",
            credentials: "include"
        });

        if (response.ok) {
            alert("íšŒì›ì´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadMembers();
        } else {
            alert("ë³µêµ¬ ì‹¤íŒ¨ âŒ (ê¶Œí•œ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜)");
        }
    }

    window.onload = loadMembers;
</script>
</body>
</html>
