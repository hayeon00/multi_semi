<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íšŒì› ê´€ë¦¬ | Travel Planing</title>
    <link th:href="@{/css/admin.css}" rel="stylesheet">
</head>
<body>
<header>
    <div class="header-left">
        <img th:src="@{/images/logo.png}" alt="Logo">
        <div class="title">TRAVEL PLANING</div>
    </div>
    <div class="header-right">
        <div class="welcome-text">
            <span class="admin-badge">ê´€ë¦¬ì</span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.
        </div>
        <nav class="nav">
            <a th:href="@{/spots/view/tourspotlist}" class="nav-link">
                <span class="nav-icon">ğŸ </span>
                <span>í™ˆ</span>
            </a>
            <a th:href="@{/admin/view/adminpage}" class="nav-link active">
                <span class="nav-icon">ğŸ“Š</span>
                <span>ëŒ€ì‹œë³´ë“œ</span>
            </a>
            <a th:href="@{/admin/view/members}" class="nav-link">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>íšŒì›ê´€ë¦¬</span>
            </a>
            <a th:href="@{/admin/view/tourspot}" class="nav-link">
                <span class="nav-icon">ğŸ—ºï¸</span>
                <span>ê´€ê´‘ì§€ê´€ë¦¬</span>
            </a>
            <a th:href="@{/admin/view/acc}" class="nav-link">
                <span class="nav-icon">ğŸ¨</span>
                <span>ìˆ™ì†Œê´€ë¦¬</span>
            </a>
            <a href="javascript:void(0);" class="nav-link logout" onclick="handleLogout()">
                <span class="nav-icon">ğŸšª</span>
                <span>ë¡œê·¸ì•„ì›ƒ</span>
            </a>
        </nav>
    </div>
</header>

<main>
    <div class="admin-container">
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <h2 class="admin-title">íšŒì› ê´€ë¦¬</h2>
                <p class="admin-sub">ì‹œìŠ¤í…œì— ë“±ë¡ëœ íšŒì›ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
            </div>
            <div class="stats-card">
                <div class="stat-item">
                    <span class="stat-label">ì „ì²´ íšŒì›</span>
                    <span class="stat-value" id="totalMembers">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">í™œì„± íšŒì›</span>
                    <span class="stat-value active" id="activeMembers">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ë¹„í™œì„± íšŒì›</span>
                    <span class="stat-value inactive" id="inactiveMembers">-</span>
                </div>
            </div>
        </aside>

        <section class="admin-content">
            <!-- ê²€ìƒ‰ ì˜ì—­ -->
            <div class="search-container">
                <div class="search-box">
                    <input type="text"
                           id="searchInput"
                           placeholder="ğŸ” ì•„ì´ë””ë¡œ ê²€ìƒ‰..."
                           onkeydown="if(event.key==='Enter') searchMember();" />
                    <button class="btn btn-search" onclick="searchMember()">ê²€ìƒ‰</button>
                    <button class="btn btn-reset" onclick="loadMembers()">ì „ì²´ ë³´ê¸°</button>
                </div>
            </div>

            <!-- í…Œì´ë¸” ì˜ì—­ -->
            <div class="table-container">
                <table id="memberTable">
                    <thead>
                    <tr>
                        <th width="60">ID</th>
                        <th width="120">ì•„ì´ë””</th>
                        <th width="100">ì´ë¦„</th>
                        <th width="180">ì´ë©”ì¼</th>
                        <th width="120">ì „í™”ë²ˆí˜¸</th>
                        <th width="80">ê¶Œí•œ</th>
                        <th width="80">ìƒíƒœ</th>
                        <th width="120">ê´€ë¦¬</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- JSë¡œ ì±„ì›€ -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>
</main>

<footer>
    <p>&copy; 2025 Travel Planing. All rights reserved.</p>
</footer>

<script th:src="@{/js/common.js}"></script>

<script>
    // íšŒì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadMembers() {
        try {
            const response = await fetchWithRefresh("/admin/members", {
                method: "GET",
                headers: { "Content-Type": "application/json" },
                credentials: "include"
            });

            if (!response.ok) {
                alert("íšŒì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                return;
            }

            const result = await response.json();
            renderMembers(result.data);
            updateStats(result.data);
        } catch (error) {
            console.error("ğŸš¨ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats(members) {
        const total = members ? members.length : 0;
        const active = members ? members.filter(m => m.status === 'Y').length : 0;
        const inactive = total - active;

        document.getElementById('totalMembers').textContent = total;
        document.getElementById('activeMembers').textContent = active;
        document.getElementById('inactiveMembers').textContent = inactive;
    }

    // íšŒì› ëª©ë¡ ë Œë”ë§
    function renderMembers(members) {
        const tbody = document.querySelector("#memberTable tbody");
        tbody.innerHTML = "";

        if (!members || members.length === 0) {
            tbody.innerHTML = `
                <tr class="empty-row">
                    <td colspan="8">
                        <div class="empty-state">
                            <span class="empty-icon">ğŸ“­</span>
                            <p>ì¡°íšŒëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</p>
                        </div>
                    </td>
                </tr>`;
            return;
        }

        members.forEach(member => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="text-center">${member.id}</td>
                <td><strong>${member.loginId}</strong></td>
                <td>${member.username}</td>
                <td class="text-email">${member.email}</td>
                <td>${member.tel}</td>
                <td class="text-center">
                    <span class="badge badge-${member.role === 'ADMIN' ? 'admin' : 'user'}">
                        ${member.role}
                    </span>
                </td>
                <td class="text-center">
                    <span class="status-badge ${member.status === 'Y' ? 'status-active' : 'status-inactive'}">
                        ${member.status === 'Y' ? 'âœ“ í™œì„±' : 'âœ— ë¹„í™œì„±'}
                    </span>
                </td>
                <td class="text-center">
                    ${member.status === "Y"
                ? `<button class="btn-action btn-deactivate" onclick="deactivateMember(${member.id})">
                              <span>ë¹„í™œì„±í™”</span>
                           </button>`
                : `<button class="btn-action btn-activate" onclick="activateMember(${member.id})">
                              <span>ë³µêµ¬</span>
                           </button>`
            }
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // ì•„ì´ë””ë¡œ íšŒì› ê²€ìƒ‰
    async function searchMember() {
        const keyword = document.getElementById("searchInput").value.trim();
        if (!keyword) {
            alert("ê²€ìƒ‰í•  ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        try {
            const response = await fetchWithRefresh(`/admin/members?loginId=${encodeURIComponent(keyword)}`, {
                method: "GET",
                headers: { "Content-Type": "application/json" },
                credentials: "include"
            });

            if (!response.ok) {
                alert("ê²€ìƒ‰ ì‹¤íŒ¨ (ê¶Œí•œ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜)");
                return;
            }

            const result = await response.json();
            const members = Array.isArray(result.data) ? result.data : [result.data];
            renderMembers(members);
            updateStats(members);
        } catch (error) {
            console.error("ğŸš¨ ê²€ìƒ‰ ì˜¤ë¥˜:", error);
            alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // íšŒì› ë¹„í™œì„±í™”
    async function deactivateMember(id) {
        if (!confirm("ì •ë§ë¡œ ì´ íšŒì›ì„ ë¹„í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const response = await fetchWithRefresh(`/admin/members/${id}/deactivate`, {
            method: "PUT",
            credentials: "include"
        });

        if (response.ok) {
            alert("âœ“ íšŒì›ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadMembers();
        } else {
            alert("ë¹„í™œì„±í™” ì‹¤íŒ¨ (ê¶Œí•œ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜)");
        }
    }

    // íšŒì› ë³µêµ¬
    async function activateMember(id) {
        if (!confirm("ì´ íšŒì›ì„ ë‹¤ì‹œ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const response = await fetchWithRefresh(`/admin/members/${id}/activate`, {
            method: "PUT",
            credentials: "include"
        });

        if (response.ok) {
            alert("âœ“ íšŒì›ì´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadMembers();
        } else {
            alert("ë³µêµ¬ ì‹¤íŒ¨ (ê¶Œí•œ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜)");
        }
    }


    async function handleLogout() {
        try {
            const response = await fetch('/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include' // ì¿ í‚¤ í¬í•¨
            });

            if (response.ok) {
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/login';
            } else {
                const result = await response.json();
                alert(result.message || 'ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
            alert('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    window.onload = loadMembers;
</script>
</body>
</html>