<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ | Travel Planing</title>
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/adminpage.css}">

</head>
<body>
<!-- í—¤ë” -->
<header>
    <div class="header-left">
        <img th:src="@{/images/logo.png}" alt="Logo" src="/api/placeholder/50/50">
        <div class="title">TRAVEL PLANING</div>
    </div>
    <div class="header-right">
        <div class="welcome-text">
            <span class="admin-badge">ê´€ë¦¬ì</span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.
        </div>
        <nav class="nav">
            <a th:href="@{/spots/view/tourspotlist}" class="nav-link">
                <span class="nav-icon">ğŸ </span>
                <span>í™ˆ</span>
            </a>
            <a th:href="@{/admin/view/adminpage}" class="nav-link active">
                <span class="nav-icon">ğŸ“Š</span>
                <span>ëŒ€ì‹œë³´ë“œ</span>
            </a>
            <a th:href="@{/admin/view/members}" class="nav-link">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>íšŒì›ê´€ë¦¬</span>
            </a>
            <a th:href="@{/admin/view/tourspot}" class="nav-link">
                <span class="nav-icon">ğŸ—ºï¸</span>
                <span>ê´€ê´‘ì§€ê´€ë¦¬</span>
            </a>
            <a th:href="@{/admin/view/acc}" class="nav-link">
                <span class="nav-icon">ğŸ¨</span>
                <span>ìˆ™ì†Œê´€ë¦¬</span>
            </a>
            <a href="javascript:void(0);" class="nav-link logout" onclick="handleLogout()">
                <span class="nav-icon">ğŸšª</span>
                <span>ë¡œê·¸ì•„ì›ƒ</span>
            </a>
        </nav>
    </div>
</header>

<!-- ë©”ì¸ ì»¨í…ì¸  -->
<main>
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="page-header">
        <h1 class="page-title">
            <span class="title-icon">ğŸ“Š</span>
            ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
        </h1>
        <p class="page-desc">ì‹œìŠ¤í…œì˜ ì „ì²´ í˜„í™©ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
    </div>

    <!-- í†µê³„ ì¹´ë“œ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">ì „ì²´ íšŒì›</span>
                <span class="stat-icon">ğŸ‘¥</span>
            </div>
            <div class="stat-value" id="totalMembers">-</div>
            <div class="stat-change">ğŸ“ˆ í™œì„± íšŒì› ì¤‘ì‹¬</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">ì „ì²´ ê´€ê´‘ì§€</span>
                <span class="stat-icon">ğŸ—ºï¸</span>
            </div>
            <div class="stat-value" id="totalTourspots">-</div>
            <div class="stat-change">âœ¨ ìµœì‹  ë°ì´í„°</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">ì „ì²´ ìˆ™ì†Œ</span>
                <span class="stat-icon">ğŸ¨</span>
            </div>
            <div class="stat-value" id="totalAccs">-</div>
            <div class="stat-change">ğŸ”„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸</div>
        </div>
    </div>

    <!-- ë°ì´í„° í…Œì´ë¸” ê·¸ë¦¬ë“œ -->
    <div class="data-grid">
        <!-- íšŒì› ì •ë³´ ì¹´ë“œ -->
        <div class="data-card">
            <div class="data-card-header">
                <h2 class="card-title">
                    <span>ğŸ‘¥</span>
                    íšŒì› ì •ë³´
                </h2>
                <button class="more-btn" onclick="location.href='/admin/view/members'">ë”ë³´ê¸°</button>
            </div>
            <div class="table-wrapper">
                <div id="memberTable">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìˆ™ì†Œ ì •ë³´ ì¹´ë“œ -->
        <div class="data-card">
            <div class="data-card-header">
                <h2 class="card-title">
                    <span>ğŸ¨</span>
                    ìˆ™ì†Œ ì •ë³´
                </h2>
                <button class="more-btn" onclick="location.href='/admin/view/acc'">ë”ë³´ê¸°</button>
            </div>
            <div class="table-wrapper">
                <div id="accTable">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>ìˆ™ì†Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê´€ê´‘ì§€ ì •ë³´ ì¹´ë“œ (ì „ì²´ ë„ˆë¹„) -->
        <div class="data-card full-width">
            <div class="data-card-header">
                <h2 class="card-title">
                    <span>ğŸ—ºï¸</span>
                    ê´€ê´‘ì§€ ì •ë³´
                </h2>
                <button class="more-btn" onclick="location.href='/admin/view/tourspot'">ë”ë³´ê¸°</button>
            </div>
            <div class="table-wrapper">
                <div id="tourspotTable">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>ê´€ê´‘ì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- í‘¸í„° -->
<footer>
    <p>&copy; 2025 Travel Planing. All rights reserved.</p>
</footer>

<script th:src="@{/js/common.js}"></script>

<script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', function() {
        loadMemberData();
        loadTourSpotData();
        loadAccData();
    });

    // íšŒì› ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadMemberData() {
        try {
            const response = await fetchWithRefresh('/admin/members', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('íšŒì› ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }

            const result = await response.json();

            if (result.data && result.data.length > 0) {
                // í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('totalMembers').textContent = result.data.length;

                const members = result.data.slice(0, 5);

                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ì•„ì´ë””</th>
                                <th>ì´ë¦„</th>
                                <th>ì´ë©”ì¼</th>
                                <th>ì „í™”ë²ˆí˜¸</th>
                                <th>ê¶Œí•œ</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                members.forEach(member => {
                    html += `
                        <tr>
                            <td>${member.id || '-'}</td>
                            <td><strong>${member.loginId || '-'}</strong></td>
                            <td>${member.username || '-'}</td>
                            <td>${member.email || '-'}</td>
                            <td>${member.tel || '-'}</td>
                            <td>
                                <span class="badge badge-${member.role === 'ADMIN' ? 'admin' : 'user'}">
                                    ${member.role || '-'}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge ${member.status === 'Y' ? 'status-active' : 'status-inactive'}">
                                    ${member.status === 'Y' ? 'âœ“ í™œì„±' : 'âœ— ë¹„í™œì„±'}
                                </span>
                            </td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;

                document.getElementById('memberTable').innerHTML = html;
            } else {
                document.getElementById('totalMembers').textContent = '0';
                document.getElementById('memberTable').innerHTML = `
                    <div class="empty-state">
                        <span class="empty-icon">ğŸ‘¥</span>
                        <p>ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('íšŒì› ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            document.getElementById('totalMembers').textContent = '0';
            document.getElementById('memberTable').innerHTML = `
                <div class="empty-state">
                    <span class="empty-icon">âš ï¸</span>
                    <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            `;
        }
    }

    // ê´€ê´‘ì§€ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadTourSpotData() {
        try {
            const response = await fetchWithRefresh('/admin/tourspot/list?page=0&size=5&sort=id', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('ê´€ê´‘ì§€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }

            const result = await response.json();

            if (result.data && result.data.content && result.data.content.length > 0) {
                // í†µê³„ ì—…ë°ì´íŠ¸ - totalElementsê°€ ì „ì²´ ê°œìˆ˜
                const totalCount = result.data.totalElements || result.data.content.length;
                document.getElementById('totalTourspots').textContent = totalCount;

                const tourspots = result.data.content;

                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ì´ë¯¸ì§€</th>
                                <th>ì œëª©</th>
                                <th>ì£¼ì†Œ</th>
                                <th>ì¶”ì²œìˆ˜</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                tourspots.forEach(spot => {
                    const imgSrc = spot.firstImage || '/images/no-image.png';
                    const recCount = spot.recCount || 0;

                    html += `
                        <tr>
                            <td>${spot.id || '-'}</td>
                            <td>
                                <img src="${imgSrc}"
                                     alt="${spot.title}"
                                     onerror="this.src='/images/no-image.png'">
                            </td>
                            <td>${spot.title || '-'}</td>
                            <td>${spot.address || '-'}</td>
                            <td><span class="rec-count">${recCount}</span></td>
                            <td>
                                <span class="status-badge ${spot.status === 'Y' ? 'status-active' : 'status-inactive'}">
                                    ${spot.status === 'Y' ? 'âœ“ í™œì„±' : 'âœ— ë¹„í™œì„±'}
                                </span>
                            </td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;

                document.getElementById('tourspotTable').innerHTML = html;
            } else {
                document.getElementById('totalTourspots').textContent = '0';
                document.getElementById('tourspotTable').innerHTML = `
                    <div class="empty-state">
                        <span class="empty-icon">ğŸ—ºï¸</span>
                        <p>ë“±ë¡ëœ ê´€ê´‘ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('ê´€ê´‘ì§€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            document.getElementById('totalTourspots').textContent = '0';
            document.getElementById('tourspotTable').innerHTML = `
                <div class="empty-state">
                    <span class="empty-icon">âš ï¸</span>
                    <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            `;
        }
    }

    // ìˆ™ì†Œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadAccData() {
        try {
            const response = await fetchWithRefresh('/accommodations/list?page=0&size=5&sort=id', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }

            const result = await response.json();
            console.log('ìˆ™ì†Œ API ì‘ë‹µ:', result);

            if (result.data && result.data.contents && result.data.contents.length > 0) {
                // â­ totalElements ì‚¬ìš©
                document.getElementById('totalAccs').textContent = result.data.totalElements || 0;

                const accs = result.data.contents;

                let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ì´ë¯¸ì§€</th>
                            <th>ì œëª©</th>
                            <th>ì£¼ì†Œ</th>
                            <th>ì¶”ì²œìˆ˜</th>
                            <th>ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

                accs.forEach(acc => {
                    const imgSrc = acc.firstImage || '/images/no-image.png';
                    const recCount = acc.recCount || 0;

                    html += `
                    <tr>
                        <td>${acc.id || '-'}</td>
                        <td>
                            <img src="${imgSrc}"
                                 alt="${acc.title}"
                                 onerror="this.src='/images/no-image.png'">
                        </td>
                        <td>${acc.title || '-'}</td>
                        <td>${acc.address || '-'}</td>
                        <td><span class="rec-count">${recCount}</span></td>
                        <td>
                            <span class="status-badge ${acc.status === 'Y' ? 'status-active' : 'status-inactive'}">
                                ${acc.status === 'Y' ? 'âœ“ í™œì„±' : 'âœ— ë¹„í™œì„±'}
                            </span>
                        </td>
                    </tr>
                `;
                });

                html += `
                    </tbody>
                </table>
            `;

                document.getElementById('accTable').innerHTML = html;
            } else {
                document.getElementById('totalAccs').textContent = '0';
                document.getElementById('accTable').innerHTML = `
                <div class="empty-state">
                    <span class="empty-icon">ğŸ¨</span>
                    <p>ë“±ë¡ëœ ìˆ™ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            `;
            }
        } catch (error) {
            console.error('ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            document.getElementById('totalAccs').textContent = '0';
            document.getElementById('accTable').innerHTML = `
            <div class="empty-state">
                <span class="empty-icon">âš ï¸</span>
                <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        `;
        }

    }

    async function handleLogout() {
        try {
            const response = await fetch('/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include' // ì¿ í‚¤ í¬í•¨
            });

            if (response.ok) {
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/login';
            } else {
                const result = await response.json();
                alert(result.message || 'ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
            alert('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
</script>
</body>
</html>