<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="ko"
      layout:decorate="~{/common/layout}">

<head layout:fragment="head">
    <meta charset="UTF-8">
    <title>ê´€ê´‘ì§€ ìƒì„¸ë³´ê¸° | Travel Planning</title>

    <!-- ìƒì„¸ í˜ì´ì§€ ì „ìš© CSS -->
    <link rel="stylesheet" th:href="@{/css/detail.css}">
</head>

<body>

<div layout:fragment="content">

    <div class="detail-container">

        <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
        <div class="nav-buttons">
            <button class="btn-nav" id="btnHistoryBack">â† ì´ì „ í˜ì´ì§€</button>
            <button class="btn-nav" id="btnBack">â† ê´€ê´‘ì§€ ëª©ë¡</button>
        </div>

        <h1 class="detail-title">ê´€ê´‘ì§€ ìƒì„¸ì •ë³´</h1>

        <!-- ë¡œë”© -->
        <div id="loading" class="loading-wrapper">
            <div class="loading-spinner"></div>
            <p class="loading-text">ğŸŒ€ ìƒì„¸ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <!-- ìƒì„¸ ì •ë³´ -->
        <div id="detail" class="detail-content" style="display:none;"></div>

        <!-- ë¦¬ë·° -->
        <div id="reviews" class="reviews" style="display:none;">
            <h3>ğŸ“ ìµœì‹  ë¦¬ë·°</h3>
            <div id="review-list"></div>
        </div>

        <!-- ì§€ë„ -->
        <div id="map" class="detail-map">ì§€ë„ ë¡œë”© ì¤‘...</div>

        <!-- ë²„íŠ¼ ê·¸ë£¹ -->
        <div id="actions" class="btn-group" style="display:none;">
            <button class="btn btn-accommodation" id="btnAcc">ğŸ¨ ê·¼ì²˜ ìˆ™ì†Œ ë³´ê¸°</button>
            <button class="btn btn-plan" id="btnPlan">ğŸ—“ï¸ ì—¬í–‰ ê³„íš ìƒì„±</button>
            <button class="btn btn-like" id="btnLike">â™¡ ì¶”ì²œ</button>
        </div>

    </div>

    <!-- Kakao Map SDK -->
    <script th:inline="javascript">
        const kakaoKey = /*[[${kakaoKey}]]*/ '';
        const script = document.createElement('script');
        script.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoKey}&autoload=false`;
        script.async = true;
        script.onload = () => {
            console.log("ğŸ—ºï¸ Kakao Map SDK ë¡œë“œ ì™„ë£Œ");
            loadDetail();
        };
        document.head.appendChild(script);
    </script>

    <!-- ìƒì„¸ í˜ì´ì§€ JS -->
    <script th:inline="javascript">
        const id = /*[[${id}]]*/ 0;

        function showToast(message) {
            const toast = document.createElement("div");
            toast.textContent = message;
            toast.className = "toast-message";
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // ìƒì„¸ ì •ë³´ ë¡œë“œ
        function loadDetail() {
            fetchWithRefresh(`/spots/detail?id=${id}`)
                .then(res => res.json())
                .then(result => {

                    const data = result.data;
                    if (!data) throw new Error("ë°ì´í„° ì—†ìŒ");

                    document.getElementById("loading").style.display = "none";
                    document.getElementById("detail").style.display = "block";
                    document.getElementById("actions").style.display = "flex";

                    const container = document.getElementById("detail");

                    container.innerHTML = `
                        <img src="${data.firstImage || '/images/no-image.png'}"
                             class="detail-image">

                        <h2 class="detail-subtitle">${data.title}</h2>

                        <div class="info">
                            <p><strong>ì£¼ì†Œ:</strong> ${data.address || 'ì •ë³´ ì—†ìŒ'}</p>
                            <p><strong>ì „í™”ë²ˆí˜¸:</strong> ${data.tel || 'ì •ë³´ ì—†ìŒ'}</p>
                            <p><strong>í™ˆí˜ì´ì§€:</strong>
                                ${data.homepage ? `<a href="${data.homepage}" target="_blank">${data.homepage}</a>` : 'ì •ë³´ ì—†ìŒ'}
                            </p>
                            <p><strong>ì„¤ëª…:</strong> ${data.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                            <p><strong>ì¶”ì²œìˆ˜:</strong> ${data.recCount}</p>
                            <p><strong>ì‘ì„±ì¼:</strong> ${data.createdAt}</p>
                            <p><strong>ìˆ˜ì •ì¼:</strong> ${data.modifiedAt}</p>
                        </div>
                    `;

                    initMap(data.mapy, data.mapx, data.title);
                    loadReviews();
                })
                .catch(err => {
                    console.error("âŒ ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨", err);
                    document.getElementById("loading").innerHTML =
                        `<p class="error-text">âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
                });
        }

        // ë¦¬ë·° ë¡œë“œ
        function loadReviews() {
            fetch(`/reviews/target?type=tsp&id=${id}&size=3`)
                .then(res => res.json())
                .then(result => {
                    const reviews = result.content;

                    const reviewSection = document.getElementById("reviews");
                    const reviewList = document.getElementById("review-list");

                    reviewSection.style.display = "block";
                    reviewList.innerHTML = "";

                    if (!reviews || reviews.length === 0) {
                        reviewList.innerHTML = `<p class="empty-review">ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                        return;
                    }

                    reviews.forEach(r => {
                        const div = document.createElement("div");
                        div.classList.add("review-card");
                        div.innerHTML = `
                            <h4>${r.writer || "ìµëª… ì‚¬ìš©ì"}</h4>
                            <p><strong>${r.title}</strong></p>
                            <p>${r.content}</p>
                            <div class="review-meta">â­ ${r.rating || 0}ì  | ${r.createdAt}</div>
                        `;
                        reviewList.appendChild(div);
                    });
                })
                .catch(() => {
                    document.getElementById("review-list").innerHTML =
                        `<p class="error-text">ë¦¬ë·° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
                });
        }

        // ì§€ë„
        function initMap(lat, lng) {
            if (!window.kakao || !kakao.maps) {
                return setTimeout(() => initMap(lat, lng), 500);
            }

            kakao.maps.load(() => {
                const map = new kakao.maps.Map(
                    document.getElementById('map'),
                    {center: new kakao.maps.LatLng(lat, lng), level: 3}
                );
                new kakao.maps.Marker({position: new kakao.maps.LatLng(lat, lng)}).setMap(map);
            });
        }

        document.getElementById("btnBack").onclick = () =>
            window.location.href = `/spots/view/tourspotlist`;

        document.getElementById("btnHistoryBack").onclick = () =>
            window.history.back();

        document.getElementById("btnAcc").onclick = () =>
            // window.location.href = `/accommodations/view/acclist?tspId=${id}`;
            safeRedirect(`/accommodations/view/acclist?tspId=${id}`);

        document.getElementById("btnPlan").onclick = () => {
            safeRedirect(`/plans/view/create?tspId=${id}`)
        };

        document.getElementById("btnLike").onclick = () => {
            fetchWithRefresh(`/recommend/toggle?targetId=${id}&catCode=tsp`)
                .then(res => res.json())
                .then(result => {
                    const btn = document.getElementById("btnLike");
                    if (result.data?.status === "Y") {
                        btn.classList.add("active");
                        btn.innerHTML = "â¤ï¸ ì¶”ì²œ ì·¨ì†Œ";
                        showToast("ì¶”ì²œí–ˆìŠµë‹ˆë‹¤!");
                    } else {
                        btn.classList.remove("active");
                        btn.innerHTML = "â™¡ ì¶”ì²œ";
                        showToast("ì¶”ì²œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                    loadDetail();
                });
        };
    </script>

</div>

</body>
</html>
