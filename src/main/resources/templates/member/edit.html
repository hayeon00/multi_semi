<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íšŒì›ì •ë³´ ìˆ˜ì • | TRAVEL PLANING</title>
    <link rel="stylesheet" th:href="@{/css/member-edit.css}">
</head>

<body>
<header>
    <div class="header-container">
        <div class="header-left">
            <img th:src="@{/images/logo.png}" alt="Logo" class="logo">
            <span class="title">TRAVEL PLANING</span>
        </div>

        <div class="header-right">
            <span id="welcome-text">{ì‚¬ìš©ì} ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.</span>
            <nav class="nav-links">
                <a th:href="@{/}">Home</a>
                <a th:href="@{/member/view/mypage}">ë§ˆì´í˜ì´ì§€</a>
                <a th:href="@{/logout}">ë¡œê·¸ì•„ì›ƒ</a>
            </nav>
        </div>
    </div>
</header>

<main>
    <h2>íšŒì›ì •ë³´ ìˆ˜ì •</h2>

    <div class="edit-container">
        <!-- ì™¼ìª½: í”„ë¡œí•„ ì´ë¯¸ì§€ -->
        <div class="profile-section">
            <img id="profileImg" src="/images/default-profile.png" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="profile-img">
            <label for="imageFile" class="upload-btn">ì‚¬ì§„ ìˆ˜ì • ğŸ“·</label>
            <input type="file" id="imageFile" name="imageFile" accept="image/*" hidden onchange="previewImage(event)">
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì •ë³´ ì…ë ¥ í¼ -->
        <div class="edit-form">
            <label for="username">ì´ë¦„</label>
            <input type="text" id="username" placeholder="ê¸°ì¡´ ì´ë¦„" />

            <label for="tel">ì „í™”ë²ˆí˜¸</label>
            <input type="text" id="tel" placeholder="ê¸°ì¡´ ì „í™”ë²ˆí˜¸" />

            <label for="email">ì´ë©”ì¼</label>
            <input type="email" id="email" placeholder="ê¸°ì¡´ ì´ë©”ì¼" />

            <div class="btn-group">
                <button type="button" class="btn btn-save" onclick="updateMember()">ìˆ˜ì •ì™„ë£Œ</button>
                <a href="/member/view/mypage" class="btn btn-cancel">ë’¤ë¡œê°€ê¸°</a>
            </div>
        </div>
    </div>
</main>

<footer>Â© 2025 TRAVEL PLANING. All rights reserved.</footer>

<script>
    // âœ… ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
    document.addEventListener("DOMContentLoaded", () => {
        console.log("í˜ì´ì§€ ë¡œë“œ - íšŒì›ì •ë³´ ì¡°íšŒ ì‹œì‘");

        fetch("/members/info", {
            method: "GET",
            credentials: "include"
        })
            .then(res => {
                console.log("ì‘ë‹µ ìƒíƒœ:", res.status);
                if (!res.ok) throw new Error("íšŒì›ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨");
                return res.json();
            })
            .then(data => {
                console.log("ë°›ì€ ë°ì´í„°:", data);

                const member = data.data;

                document.getElementById("welcome-text").innerText = `${member.username} ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.`;
                document.getElementById("username").placeholder = member.username || "ê¸°ì¡´ ì´ë¦„";
                document.getElementById("email").placeholder = member.email || "ê¸°ì¡´ ì´ë©”ì¼";
                document.getElementById("tel").placeholder = member.tel || "ê¸°ì¡´ ì „í™”ë²ˆí˜¸";

                // ì‹¤ì œ ê°’ë„ ì„¤ì •
                document.getElementById("username").value = member.username || "";
                document.getElementById("email").value = member.email || "";
                document.getElementById("tel").value = member.tel || "";

                // ì´ë¯¸ì§€ í‘œì‹œ
                if (member.image && member.image !== 'default.img') {
                    document.getElementById("profileImg").src = `http://localhost:8090/profile/${member.image}`;
                    console.log("í”„ë¡œí•„ ì´ë¯¸ì§€:", member.image);
                }

                console.log("íšŒì›ì •ë³´ ë¡œë“œ ì™„ë£Œ");
            })
            .catch(err => {
                console.error("íšŒì› ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:", err);
                alert("íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ âŒ");
            });
    });

    // âœ… ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
    function previewImage(event) {
        const file = event.target.files[0];
        if (!file) return;

        console.log("ì„ íƒëœ ì´ë¯¸ì§€:", file.name, "í¬ê¸°:", file.size, "bytes");

        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById("profileImg").src = e.target.result;
            console.log("ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì™„ë£Œ");
        };
        reader.readAsDataURL(file);
    }

    // âœ… íšŒì›ì •ë³´ ìˆ˜ì • ìš”ì²­ (ì´ë¯¸ì§€ í¬í•¨)
    async function updateMember() {
        console.log("=== ìˆ˜ì • ì‹œì‘ ===");

        const username = document.getElementById("username").value;
        const email = document.getElementById("email").value;
        const tel = document.getElementById("tel").value;

        console.log("ì…ë ¥ëœ ê°’:", { username, email, tel });

        // ë¹ˆ ê°’ ì²´í¬
        if (!username || !email || !tel) {
            alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        // âœ… FormData ìƒì„±
        const formData = new FormData();
        formData.append("username", username);
        formData.append("email", email);
        formData.append("tel", tel);

        // âœ… ì´ë¯¸ì§€ íŒŒì¼ ì¶”ê°€ (ì„ íƒ ì‚¬í•­)
        const imageFileInput = document.getElementById("imageFile");
        if (imageFileInput && imageFileInput.files.length > 0) {
            const imageFile = imageFileInput.files[0];
            formData.append("imageFile", imageFile);
            console.log("ì—…ë¡œë“œí•  ì´ë¯¸ì§€:", imageFile.name, "í¬ê¸°:", imageFile.size, "bytes");
        } else {
            console.log("ì´ë¯¸ì§€ ë³€ê²½ ì—†ìŒ");
        }

        console.log("ì „ì†¡í•  FormData:");
        for (let pair of formData.entries()) {
            console.log(pair[0] + ':', pair[1]);
        }

        try {
            const res = await fetch("/members/update", {
                method: "PUT",
                body: formData,
                credentials: "include"
            });

            console.log("ì‘ë‹µ ìƒíƒœ:", res.status);

            if (res.ok) {
                const result = await res.json();
                console.log("ì‘ë‹µ ë°ì´í„°:", result);
                alert("íšŒì›ì •ë³´ ìˆ˜ì • ì™„ë£Œ âœ…");
                location.href = "/member/view/mypage";
            } else {
                const error = await res.json();
                console.error("ìˆ˜ì • ì‹¤íŒ¨:", error);
                alert(`ìˆ˜ì • ì‹¤íŒ¨: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            }
        } catch (error) {
            console.error("ìš”ì²­ ì‹¤íŒ¨:", error);
            alert("ìˆ˜ì • ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ âŒ");
        }
    }
</script>
</body>
</html>