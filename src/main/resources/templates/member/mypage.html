<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§ˆì´í˜ì´ì§€ | Travel Planning</title>
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/mypage.css}">
</head>
<body>
<header>
    <div class="header-left">
        <img th:src="@{/images/logo.png}" alt="Logo" class="logo">
        <div class="title">TRAVEL PLANNING</div>
    </div>
    <div class="header-right">
        <div class="welcome-text" id="welcome-text">
            <span class="user-badge">íšŒì›</span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.
        </div>
        <nav class="nav">
            <a th:href="@{/spots/view/tourspotlist}" class="nav-link">
                <span class="nav-icon">ğŸ </span>
                <span>í™ˆ</span>
            </a>
            <a th:href="@{/member/view/mypage}" class="nav-link active">
                <span class="nav-icon">ğŸ‘¤</span>
                <span>ë§ˆì´í˜ì´ì§€</span>
            </a>
            <a th:href="@{/reviews/view/search/my}" class="nav-link">
                <span class="nav-icon">âœï¸</span>
                <span>ë‚´ ë¦¬ë·°</span>
            </a>
            <a href="javascript:void(0);" class="nav-link logout" onclick="handleLogout()">
                <span class="nav-icon">ğŸšª</span>
                <span>ë¡œê·¸ì•„ì›ƒ</span>
            </a>
        </nav>
    </div>
</header>

<main>
    <div class="admin-container">
        <!-- ì™¼ìª½ í”„ë¡œí•„ ì˜ì—­ -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <h2 class="admin-title">í”„ë¡œí•„</h2>
                <p class="admin-sub">ë‚´ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤</p>
            </div>

            <div class="profile-card">
                <img id="profile-img" src="/images/profile-sample.jpg" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="profile-img">
                <h3 id="username" class="profile-name">íšŒì› ì´ë¦„</h3>
                <p class="profile-id" id="loginId">@ì•„ì´ë””</p>
                <p class="profile-email" id="email">email@example.com</p>

                <button class="btn-primary" onclick="location.href='/member/view/edit'">
                    <span>âœï¸</span>
                    <span>í”„ë¡œí•„ ìˆ˜ì •</span>
                </button>
                <button class="btn-secondary" onclick="location.href='/reviews/view/search/my'">
                    <span>ğŸ“</span>
                    <span>ë‚´ê°€ ì“´ ë¦¬ë·°</span>
                </button>
            </div>
        </aside>

        <!-- ì˜¤ë¥¸ìª½ ìµœê·¼ ê³„íš -->
        <section class="admin-content">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="section-icon">ğŸ“…</span>
                    ìµœê·¼ ë‚´ ê³„íš
                </h2>
            </div>

            <div class="plan-list" id="plan-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>ì—¬í–‰ ê³„íšì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </section>
    </div>
</main>

<footer>
    <p>&copy; 2025 Travel Planning. All rights reserved.</p>
</footer>

<script th:src="@{/js/common.js}"></script>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            // âœ… 1. ë¡œê·¸ì¸í•œ íšŒì› ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const memberRes = await fetchWithRefresh("/members/mypage", {
                method: "GET",
                headers: { "Content-Type": "application/json" },
                credentials: "include"
            });

            if (!memberRes.ok) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                location.href = "/login";
                return;
            }

            const memberResult = await memberRes.json();
            const member = memberResult.data;

            // âœ… 2. í™”ë©´ì— íšŒì› ì •ë³´ í‘œì‹œ
            document.getElementById("welcome-text").innerHTML =
                `<span class="user-badge">íšŒì›</span>${member.username}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.`;
            document.getElementById("username").textContent = member.username;
            document.getElementById("loginId").textContent = `@${member.loginId}`;
            document.getElementById("email").textContent = member.email;

            const imgTag = document.getElementById("profile-img");

// í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œ (íšŒì›ì •ë³´ ìˆ˜ì • í˜ì´ì§€ì™€ ë™ì¼í•œ ë°©ì‹)
            if (member.image && member.image !== 'default.img') {
                // URLì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ, ì•„ë‹ˆë©´ URL ì¶”ê°€
                const imageUrl = member.image.startsWith('http')
                    ? member.image
                    : `http://localhost:8090/profile/${member.image}`;
                imgTag.src = imageUrl;
                console.log("í”„ë¡œí•„ ì´ë¯¸ì§€:", imageUrl);
            } else {
                imgTag.src = "/images/no-image.png";
                console.log("ê¸°ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©");
            }

// ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ë³€ê²½
            imgTag.onerror = function() {
                console.error("âŒ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:", this.src);
                this.src = "/images/no-image.png";
                this.onerror = null; // ë¬´í•œë£¨í”„ ë°©ì§€!
            };

            imgTag.onload = function() {
                console.log("âœ… ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:", this.src);
            };

            // âœ… 3. ìµœê·¼ ì—¬í–‰ ê³„íš ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            const planRes = await fetchWithRefresh("/plans", {
                method: "GET",
                headers: { "Content-Type": "application/json" },
                credentials: "include"
            });

            const planResult = await planRes.json();
            const list = document.getElementById("plan-list");

            if (planRes.ok && planResult.status === 200) {
                const plans = planResult.data;
                if (plans.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <span class="empty-icon">ğŸ“…</span>
                            <p>ì•„ì§ ì‘ì„±í•œ ì—¬í–‰ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                } else {
                    list.innerHTML = plans.map(plan => `
          <div class="plan-item">
            <div class="plan-title">${plan.title}</div>
            <button class="btn-review-small" onclick="location.href='/reviews/view/write?planId=${plan.id}'">ë¦¬ë·°ì“°ê¸°</button>
          </div>
        `).join("");
                    list.innerHTML = plans.map(plan => {
                        // âœ… days ë³€ìˆ˜ ê³„ì‚°
                        const days = Math.ceil(
                            (new Date(plan.endDate) - new Date(plan.startDate)) / (1000 * 60 * 60 * 24)
                        ) + 1;

                        return `
    <div class="plan-card"
         onclick="location.href='/plans/view/${plan.id}'"
         style="cursor: pointer;">

        <div class="plan-info">
            <h3 class="plan-title">${plan.title}</h3>
            <p class="plan-destination">ğŸ“ ${plan.startLocation || 'ë¯¸ì •'}</p>
            <p class="plan-date">ğŸ“… ${new Date(plan.startDate).toLocaleDateString('ko-KR')} ~ ${new Date(plan.endDate).toLocaleDateString('ko-KR')} (${days}ì¼)</p>
            <p class="plan-people">ğŸ‘¥ ${plan.numberOfPeople}ëª…</p>
            ${plan.isAiPlan ? '<span class="ai-badge">ğŸ¤– AI ì¶”ì²œ</span>' : ''}
        </div>

        <div class="plan-actions">
            <button class="btn-plan-review"
                    onclick="event.stopPropagation(); location.href='/reviews/view/write?planId=${plan.id}'">
                <span>âœï¸</span>
                <span>ë¦¬ë·° ì‘ì„±</span>
            </button>
        </div>
    </div>
`;
                    }).join("");
                }
            } else {
                list.innerHTML = `
                    <div class="empty-state">
                        <span class="empty-icon">âš ï¸</span>
                        <p>ì—¬í–‰ ê³„íšì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            }

        } catch (err) {
            console.error("ì„œë²„ í†µì‹  ì˜¤ë¥˜:", err);
            document.getElementById("plan-list").innerHTML = `
                <div class="empty-state">
                    <span class="empty-icon">âš ï¸</span>
                    <p>ì„œë²„ ì˜¤ë¥˜ë¡œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            `;
        }
    });

    async function handleLogout() {
        try {
            const response = await fetch('/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include' // ì¿ í‚¤ í¬í•¨
            });

            if (response.ok) {
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/login';
            } else {
                const result = await response.json();
                alert(result.message || 'ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
            alert('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
</script>
</body>
</html>
